<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo Fortaleza 2030 + Custom AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Inversiones UY">

    <style>
        /* ===== GLOBAL THEME SYSTEM ===== */
        :root {
            /* Light Mode Colors (Default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --nav-bg: #ffffff;
            --nav-border: #e2e8f0;
            --accent-primary: #22c55e;
            --accent-secondary: #3b82f6;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        html.dark {
            /* Dark Mode Colors */
            --bg-primary: #0B0F14;
            --bg-secondary: #141B24;
            --bg-tertiary: #1a2332;
            --text-primary: rgba(255, 255, 255, 0.92);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --border-color: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(255, 255, 255, 0.05);
            --input-border: rgba(255, 255, 255, 0.15);
            --nav-bg: #0B0F14;
            --nav-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #C6FF34;
            --accent-secondary: #22c55e;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        /* Apply theme to body */
        html.dark body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Theme-aware classes */
        .theme-bg-primary {
            background-color: var(--bg-primary);
        }

        .theme-bg-secondary {
            background-color: var(--bg-secondary);
        }

        .theme-bg-card {
            background-color: var(--card-bg);
        }

        .theme-text-primary {
            color: var(--text-primary);
        }

        .theme-text-secondary {
            color: var(--text-secondary);
        }

        .theme-border {
            border-color: var(--border-color);
        }

        /* Dark mode overrides for common elements */
        html.dark nav {
            background-color: #0B0F14 !important;
            border-color: var(--nav-border) !important;
            backdrop-filter: none !important;
        }

        /* Mode toggle container in dark mode - solid background */
        html.dark #mode-toggle-container {
            background-color: #1a2332 !important;
        }

        /* Fix strategy button text visibility in dark mode */
        html.dark #mode-toggle-container button {
            color: rgba(255, 255, 255, 0.85) !important;
        }

        html.dark #mode-toggle-container button:hover {
            color: #ffffff !important;
        }

        /* Active strategy button in dark mode */
        html.dark #mode-toggle-container button.bg-white,
        html.dark #mode-toggle-container button[class*="bg-slate-800"] {
            background-color: var(--bg-tertiary) !important;
            color: #ffffff !important;
        }

        /* Specific colored buttons in dark mode - keep their colors */
        html.dark #btn-simulador,
        html.dark #btn-portfolios,
        html.dark #btn-backtesting,
        html.dark #btn-rebalance,
        html.dark #btn-dashboard {
            color: inherit !important;
        }

        html.dark header {
            background-color: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode: Remove ugly borders from utility buttons */
        html.dark #save-portfolio-btn,
        html.dark button[onclick="generatePDFReport()"],
        html.dark button[onclick="scrollToSection('ai-advisor')"] {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Dark mode: Remove outline/focus ring from all tab buttons */
        html.dark #mode-toggle-container button {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }

        html.dark #mode-toggle-container button:focus,
        html.dark #mode-toggle-container button:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Dark mode: Fix checkbox and its label visibility */
        html.dark input[type="checkbox"] {
            accent-color: #6366f1 !important;
        }

        html.dark input[type="checkbox"]+label,
        html.dark input[type="checkbox"]~label,
        html.dark .flex.items-center label,
        html.dark label.flex,
        html.dark span.ml-2,
        html.dark span.ml-3 {
            color: #e2e8f0 !important;
        }

        /* Also target checkbox containers specifically */
        html.dark .rounded-lg label,
        html.dark [class*="bg-slate"] label {
            color: #e2e8f0 !important;
        }

        /* Dark mode: Fix checkbox container backgrounds */
        html.dark .bg-amber-50,
        html.dark [class*="bg-amber-50"] {
            background-color: rgba(245, 158, 11, 0.15) !important;
            border-color: rgba(245, 158, 11, 0.4) !important;
        }

        html.dark .bg-purple-50,
        html.dark [class*="bg-purple-50"] {
            background-color: rgba(139, 92, 246, 0.15) !important;
            border-color: rgba(139, 92, 246, 0.4) !important;
        }

        html.dark .bg-orange-50,
        html.dark [class*="bg-orange-50"] {
            background-color: rgba(249, 115, 22, 0.15) !important;
            border-color: rgba(249, 115, 22, 0.4) !important;
        }

        html.dark .bg-red-50,
        html.dark [class*="bg-red-50"] {
            background-color: rgba(239, 68, 68, 0.15) !important;
            border-color: rgba(239, 68, 68, 0.4) !important;
        }

        html.dark .bg-blue-50,
        html.dark [class*="bg-blue-50"] {
            background-color: rgba(59, 130, 246, 0.15) !important;
            border-color: rgba(59, 130, 246, 0.4) !important;
        }

        /* Dark mode: Fix text-slate-700 inside checkbox containers */
        html.dark .text-slate-700 {
            color: #e2e8f0 !important;
        }

        /* Dark mode: Utility buttons - STRONGER border removal */
        html.dark button[class*="border-blue"],
        html.dark button[class*="border-red"],
        html.dark button[class*="border-purple"],
        html.dark button[class*="bg-blue-50"],
        html.dark button[class*="bg-red-50"],
        html.dark button[class*="bg-purple-50"] {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        html.dark .bg-white {
            background-color: var(--card-bg) !important;
        }

        html.dark .bg-slate-50,
        html.dark .bg-slate-100 {
            background-color: var(--bg-secondary) !important;
        }

        html.dark .text-slate-900,
        html.dark .text-slate-800 {
            color: var(--text-primary) !important;
        }

        html.dark .text-slate-700,
        html.dark .text-slate-600 {
            color: var(--text-secondary) !important;
        }

        html.dark .text-slate-500 {
            color: var(--text-muted) !important;
        }

        html.dark .border-slate-200,
        html.dark .border-slate-100 {
            border-color: var(--border-color) !important;
        }

        html.dark input,
        html.dark select,
        html.dark textarea {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important;
        }

        html.dark input::placeholder,
        html.dark textarea::placeholder {
            color: var(--text-muted) !important;
        }

        html.dark .card {
            background-color: var(--card-bg) !important;
            border-color: var(--card-border) !important;
        }

        html.dark .shadow-lg,
        html.dark .shadow-xl {
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color) !important;
        }

        /* Chat UI in dark mode */
        html.dark .chat-ai {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        html.dark .chat-user {
            background-color: #3730A3 !important;
            color: #E0E7FF !important;
        }

        /* Dark mode: Fix low visibility text colors */
        html.dark .text-purple-700,
        html.dark .text-purple-600,
        html.dark .text-purple-500 {
            color: #c4b5fd !important;
        }

        html.dark .text-slate-600,
        html.dark .text-slate-500:not(#mode-toggle-container button) {
            color: #94a3b8 !important;
        }

        /* Dark mode: Fix gradient backgrounds that are too light */
        html.dark .bg-gradient-to-r,
        html.dark [class*="from-purple-50"],
        html.dark [class*="from-blue-50"],
        html.dark [class*="from-green-50"],
        html.dark [class*="to-purple-50"],
        html.dark [class*="to-blue-50"] {
            background: linear-gradient(to right, #1e293b, #1e3a5f) !important;
            border-color: #334155 !important;
        }

        html.dark .bg-purple-50,
        html.dark .bg-blue-50,
        html.dark .bg-green-50,
        html.dark .bg-red-50 {
            background-color: #1e293b !important;
        }

        /* Dark mode: Fix checkbox and form elements */
        html.dark label {
            color: #e2e8f0 !important;
        }

        html.dark .rounded-lg.border,
        html.dark .border-purple-200,
        html.dark .border-blue-200 {
            border-color: #475569 !important;
        }

        /* Dark mode: Fix inline text inside suggestions/cards */
        html.dark .text-sm.text-slate-600,
        html.dark .text-xs.text-slate-500 {
            color: #cbd5e1 !important;
        }

        /* Dark mode: Dashboard wrapper background */
        html.dark #dashboard-wrapper {
            background-color: #0B0F14 !important;
        }

        /* Dark mode: Main body background */
        html.dark body {
            background-color: #0B0F14 !important;
        }

        html.dark main {
            background-color: #0B0F14 !important;
        }

        /* ===== DASHBOARD THEME OVERRIDES ===== */
        /* Light mode: Override ALL hardcoded dark inline styles in Dashboard */
        html:not(.dark) #dashboard-wrapper {
            background-color: #f8fafc !important;
        }

        /* Override ALL dark backgrounds in dashboard - use * selector for maximum coverage */
        html:not(.dark) #dashboard-wrapper [style*="background"] {
            background: #ffffff !important;
            border-color: #e2e8f0 !important;
        }

        html:not(.dark) #dashboard-wrapper [style*="linear-gradient"] {
            background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%) !important;
        }

        /* Override ALL text colors to dark */
        html:not(.dark) #dashboard-wrapper [style*="color: rgba(255"],
        html:not(.dark) #dashboard-wrapper [style*="color:rgba(255"] {
            color: #1e293b !important;
        }

        /* Dashboard cards/widgets in light mode - ALL rounded elements */
        html:not(.dark) #dashboard-wrapper .rounded-xl,
        html:not(.dark) #dashboard-wrapper .rounded-2xl,
        html:not(.dark) #dashboard-wrapper .rounded-3xl,
        html:not(.dark) #dashboard-wrapper .card,
        html:not(.dark) #dashboard-wrapper .dash-card {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
        }

        /* Inputs in dashboard */
        html:not(.dark) #dashboard-wrapper input,
        html:not(.dark) #dashboard-wrapper select,
        html:not(.dark) #dashboard-wrapper textarea {
            background: #ffffff !important;
            color: #1e293b !important;
            border-color: #d1d5db !important;
        }

        /* All buttons in Dashboard light mode except gradient ones */
        html:not(.dark) #dashboard-wrapper button:not([class*="from-"]):not([class*="bg-gradient"]) {
            background: #f1f5f9 !important;
            color: #475569 !important;
            border-color: #e2e8f0 !important;
        }

        /* Keep gradient buttons looking good */
        html:not(.dark) #dashboard-wrapper button[class*="from-"],
        html:not(.dark) #dashboard-wrapper button[class*="bg-gradient"] {
            color: #ffffff !important;
        }

        /* ALL text elements in Dashboard light mode */
        html:not(.dark) #dashboard-wrapper span:not([class*="text-green"]):not([class*="text-red"]):not([class*="text-blue"]):not([class*="text-amber"]),
        html:not(.dark) #dashboard-wrapper p,
        html:not(.dark) #dashboard-wrapper h1,
        html:not(.dark) #dashboard-wrapper h2,
        html:not(.dark) #dashboard-wrapper h3,
        html:not(.dark) #dashboard-wrapper h4,
        html:not(.dark) #dashboard-wrapper h5,
        html:not(.dark) #dashboard-wrapper label,
        html:not(.dark) #dashboard-wrapper td,
        html:not(.dark) #dashboard-wrapper th {
            color: #1e293b !important;
        }

        /* Muted text */
        html:not(.dark) #dashboard-wrapper [style*="opacity"] {
            color: #64748b !important;
        }

        /* Icons in Dashboard */
        html:not(.dark) #dashboard-wrapper i:not([class*="text-"]) {
            color: #64748b !important;
        }

        /* Keep specific icon colors */
        html:not(.dark) #dashboard-wrapper i.text-green-400,
        html:not(.dark) #dashboard-wrapper i.text-green-500,
        html:not(.dark) #dashboard-wrapper i.text-emerald-400 {
            color: #22c55e !important;
        }

        html:not(.dark) #dashboard-wrapper i.text-red-400,
        html:not(.dark) #dashboard-wrapper i.text-red-500 {
            color: #ef4444 !important;
        }

        html:not(.dark) #dashboard-wrapper i.text-blue-400,
        html:not(.dark) #dashboard-wrapper i.text-blue-500 {
            color: #3b82f6 !important;
        }

        html:not(.dark) #dashboard-wrapper i.text-amber-400,
        html:not(.dark) #dashboard-wrapper i.text-yellow-400 {
            color: #f59e0b !important;
        }

        /* Green accent colors */
        html:not(.dark) #dashboard-wrapper [style*="#C6FF34"] {
            color: #16a34a !important;
        }

        html:not(.dark) #dashboard-wrapper [style*="rgba(198,255,52"] {
            background: rgba(34, 197, 94, 0.15) !important;
            color: #16a34a !important;
        }

        /* Market Clock Glass Effect */
        .market-glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        html.dark .market-glass {
            background: rgba(11, 15, 20, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* ===== END THEME SYSTEM ===== */

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 300px;
            max-height: 400px;
        }

        .card {
            transition: transform 0.2s, background-color 0.5s, border-color 0.5s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Markdown Styles within Chat */
        .prose p {
            margin-bottom: 0.5em;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-bottom: 0.5em;
        }

        .prose li {
            margin-bottom: 0.2em;
        }

        .prose strong {
            font-weight: 700;
        }

        /* Fullscreen Chat Mode Logic */
        .chat-expanded {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            margin: 0 !important;
            border-radius: 0 !important;
            height: 100vh !important;
            width: 100vw !important;
            max-height: 100vh !important;
            display: flex;
            flex-direction: column;
        }

        .inner-ai-bg {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .inner-ai-bg {
                flex-direction: row;
            }
        }

        #chat-area-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
        }

        .inner-input-bg {
            flex-shrink: 0;
        }

        /* Sovereign Mode Styles */
        body.sovereign-mode {
            background-color: #0F172A;
            color: #E2E8F0;
        }

        .sovereign-mode .card {
            background-color: #1E293B;
            border-color: #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .sovereign-mode .text-slate-900 {
            color: #F8FAFC !important;
        }

        .sovereign-mode .text-slate-800 {
            color: #F1F5F9 !important;
        }

        .sovereign-mode .text-slate-700 {
            color: #CBD5E1 !important;
        }

        .sovereign-mode .text-slate-600 {
            color: #94A3B8 !important;
        }

        .sovereign-mode .text-slate-500 {
            color: #64748B !important;
        }

        .sovereign-mode nav {
            background-color: #1E293B;
            border-bottom: 1px solid #334155;
        }

        .sovereign-mode header {
            background-color: #0F172A;
            border-bottom: 1px solid #334155;
        }

        .sovereign-mode .bg-slate-50 {
            background-color: #111827 !important;
            border-color: #374151;
        }

        .sovereign-mode .bg-white {
            background-color: #1F2937 !important;
        }

        .sovereign-mode input,
        .sovereign-mode select {
            background-color: #374151;
            color: white;
            border-color: #4B5563;
        }

        /* Chat UI */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .chat-user {
            background-color: #DBEAFE;
            color: #1E3A8A;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .sovereign-mode .chat-user {
            background-color: #3730A3;
            color: #E0E7FF;
        }

        .chat-ai {
            background-color: #F3F4F6;
            color: #1F2937;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #E5E7EB;
        }

        .sovereign-mode .chat-ai {
            background-color: #374151;
            color: #F3F4F6;
            border-color: #4B5563;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9CA3AF;
            border-radius: 50%;
            animation: typing 1s infinite;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Modal Animation */
        @keyframes bounce-in {
            0% {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.02);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .animate-bounce-in {
            animation: bounce-in 0.3s ease-out forwards;
        }

        /* ===== MOBILE RESPONSIVE FIXES ===== */

        /* Force full width on mobile */
        @media (max-width: 768px) {

            /* Navigation: Make tabs wrap in multiple rows */
            #mode-toggle-container {
                flex-wrap: wrap !important;
                justify-content: center !important;
                gap: 4px !important;
                max-width: 100% !important;
            }

            /* Smaller tab buttons on mobile */
            #mode-toggle-container button {
                padding: 4px 8px !important;
                font-size: 9px !important;
            }

            /* Hide action buttons on mobile - use mobile menu instead */
            nav .flex.items-center.gap-2>button:not(#theme-toggle-btn):not(#mobile-menu-btn) {
                display: none !important;
            }

            /* Keep theme toggle visible but smaller */
            #theme-toggle-btn {
                width: 32px !important;
                height: 32px !important;
            }

            /* Nav container - allow wrapping */
            nav>div>div {
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            /* Main containers - full width */
            main,
            #main-portfolio-content,
            .main-container,
            .dashboard,
            .page {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0.75rem !important;
                box-sizing: border-box !important;
            }

            /* Cards and charts - full width with proper padding */
            .card,
            .chart-container,
            .tab-content,
            section,
            .rounded-xl,
            .rounded-2xl {
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            /* Fix Tailwind max-width classes on mobile */
            .max-w-7xl,
            .max-w-6xl,
            .max-w-5xl,
            .max-w-4xl,
            .max-w-3xl,
            .max-w-2xl,
            .max-w-xl {
                max-width: 100% !important;
            }

            /* Center content and fix alignment */
            .mx-auto {
                margin-left: auto !important;
                margin-right: auto !important;
            }

            /* Fix padding issues */
            .px-4,
            .px-6,
            .px-8 {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }

            /* Charts responsive */
            canvas {
                width: 100% !important;
                height: auto !important;
                min-height: 200px;
            }

            /* Responsive typography */
            h1 {
                font-size: clamp(1.5rem, 5vw, 2rem) !important;
            }

            h2 {
                font-size: clamp(1.25rem, 4vw, 1.75rem) !important;
            }

            h3 {
                font-size: clamp(1rem, 3.5vw, 1.5rem) !important;
            }

            /* Grid layouts - stack on mobile */
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
        }

        /* Small mobile (under 640px) */
        @media (max-width: 640px) {

            main,
            #main-portfolio-content {
                padding: 0.5rem !important;
            }

            .py-12 {
                padding-top: 1.5rem !important;
                padding-bottom: 1.5rem !important;
            }

            .space-y-20>*+* {
                margin-top: 2rem !important;
            }

            /* Smaller gaps */
            .gap-4,
            .gap-6,
            .gap-8 {
                gap: 0.75rem !important;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 transition-colors duration-500">

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeConfirmModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md animate-bounce-in">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-trash-can text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Borrar Historial</h3>
                <p class="text-slate-500 mb-6">쮼st치s seguro de que quieres borrar todo el historial del chat? Esta
                    acci칩n no se puede deshacer.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeConfirmModal()"
                        class="px-6 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-xl transition">
                        Cancelar
                    </button>
                    <button onclick="confirmClearChat()"
                        class="px-6 py-2.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition shadow-lg shadow-red-500/30">
                        <i class="fa-solid fa-trash-can mr-2"></i>S칤, borrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Clear Modal -->
    <div id="portfolio-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closePortfolioModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md animate-bounce-in">
            <div class="text-center">
                <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-wallet text-amber-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Borrar Cartera</h3>
                <p class="text-slate-500 mb-6">쮼st치s seguro de que quieres borrar todos los activos de tu cartera
                    personalizada?</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closePortfolioModal()"
                        class="px-6 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-xl transition">
                        Cancelar
                    </button>
                    <button onclick="confirmClearPortfolio()"
                        class="px-6 py-2.5 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-xl transition shadow-lg shadow-amber-500/30">
                        <i class="fa-solid fa-trash-can mr-2"></i>S칤, borrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset All Modal -->
    <div id="reset-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeResetModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md animate-bounce-in">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-rotate-left text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Reiniciar Todo</h3>
                <p class="text-slate-500 mb-6">쮼st치s seguro? Esto borrar치 <strong>todo</strong>: tu portfolio,
                    historial del chat, y ajustes guardados.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeResetModal()"
                        class="px-6 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-xl transition">
                        Cancelar
                    </button>
                    <button onclick="confirmResetAll()"
                        class="px-6 py-2.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition shadow-lg shadow-red-500/30">
                        <i class="fa-solid fa-rotate-left mr-2"></i>S칤, reiniciar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal (Portfolio Applied) -->
    <div id="success-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeSuccessModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md animate-bounce-in">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-check text-green-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">춰Cartera Aplicada!</h3>
                <p class="text-slate-500 mb-6">Tu nueva cartera se ha configurado correctamente. Revisa la secci칩n de
                    Asignaci칩n de Activos arriba.</p>
                <button onclick="closeSuccessModalAndScroll()"
                    class="w-full px-6 py-2.5 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition shadow-lg shadow-green-500/30">
                    <i class="fa-solid fa-arrow-up mr-2"></i>Ver mi cartera
                </button>
            </div>
        </div>
    </div>

    <!-- Save Portfolio Modal -->
    <div id="save-portfolio-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeSaveModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Guardar Portfolio</h3>
                <button onclick="closeSaveModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <p class="text-slate-500 text-sm mb-4">Dale un nombre a tu configuraci칩n actual para poder cargarla m치s
                tarde.</p>
            <input type="text" id="portfolio-name-input" placeholder="Ej: Mi Portfolio Conservador 2025"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4"
                onkeypress="if(event.key === 'Enter') confirmSavePortfolio()">
            <div class="flex gap-3">
                <button onclick="closeSaveModal()"
                    class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition">
                    Cancelar
                </button>
                <button onclick="confirmSavePortfolio()"
                    class="flex-1 px-4 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-floppy-disk mr-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Portfolio Assets Modal -->
    <div id="edit-portfolio-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeEditModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Editar Portfolio</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <input type="hidden" id="edit-portfolio-id">

            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-600 mb-1">Nombre</label>
                <input type="text" id="edit-portfolio-name"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-bold text-slate-600">Activos y Porcentajes</label>
                    <span id="edit-total-percentage"
                        class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-600">Total: 0%</span>
                </div>
                <div id="edit-assets-list" class="space-y-3 max-h-[300px] overflow-y-auto p-1">
                    <!-- Assets inputs will be generated here -->
                </div>
                <button onclick="addAssetToEdit()"
                    class="mt-3 text-sm text-blue-500 hover:text-blue-700 font-semibold flex items-center gap-1">
                    <i class="fa-solid fa-plus-circle"></i> Agregar Activo
                </button>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()"
                    class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition">
                    Cancelar
                </button>
                <button onclick="saveEditedPortfolio()"
                    class="flex-1 px-4 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-floppy-disk mr-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Modal (replaces alert) -->
    <div id="notification-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeNotification()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md animate-bounce-in">
            <div class="text-center">
                <div id="notification-icon"
                    class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i id="notification-icon-content" class="text-2xl"></i>
                </div>
                <h3 id="notification-title" class="text-xl font-bold text-slate-800 mb-2"></h3>
                <p id="notification-message" class="text-slate-500 mb-6"></p>
                <button onclick="closeNotification()" id="notification-btn"
                    class="w-full px-6 py-2.5 font-semibold rounded-xl transition shadow-lg">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (replaces confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="cancelConfirmation()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                </div>
                <h3 id="confirmation-title" class="text-xl font-bold text-slate-800 mb-2"></h3>
                <p id="confirmation-message" class="text-slate-500 mb-6"></p>
                <div class="flex gap-3">
                    <button onclick="cancelConfirmation()"
                        class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition">
                        Cancelar
                    </button>
                    <button id="confirmation-btn"
                        class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition shadow-lg shadow-red-500/30">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolios Dropdown (legacy - will be removed) -->
    <div id="portfolios-dropdown"
        class="fixed top-20 right-4 bg-white rounded-xl shadow-2xl border border-slate-200 w-80 max-h-[500px] overflow-hidden z-[1000] hidden">
        <div class="p-4 border-b border-slate-200 bg-gradient-to-r from-green-50 to-emerald-50">
            <h3 class="text-lg font-bold text-slate-800">Mis Portfolios</h3>
            <p class="text-xs text-slate-500 mt-1">Click para cargar un portfolio guardado</p>
        </div>
        <div id="portfolio-list-container" class="max-h-[400px] overflow-y-auto">
            <!-- Populated by renderPortfolioList() -->
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 transition-colors duration-500">
        <div class="w-full md:max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 py-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-1">
                    <span id="nav-icon" class="text-xl">游꺔</span>
                    <span id="nav-title" class="text-lg font-bold text-slate-800 hidden sm:block">Plan Semilla</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center bg-slate-200 rounded-full p-0.5 cursor-pointer transition-colors duration-300"
                        id="mode-toggle-container">
                        <button onclick="setMode('normal')" id="btn-normal"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold bg-white shadow text-slate-700 transition-all whitespace-nowrap">Normie</button>
                        <button onclick="setMode('sovereign')" id="btn-sovereign"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-slate-500 hover:text-slate-700 transition-all whitespace-nowrap">Soberano</button>
                        <button onclick="setMode('custom')" id="btn-custom"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-slate-500 hover:text-slate-700 transition-all whitespace-nowrap">Personalizado</button>
                        <button onclick="setMode('simulador')" id="btn-simulador"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-blue-500 hover:text-blue-700 transition-all whitespace-nowrap">
                            <i class="fa-solid fa-calculator hidden sm:inline"></i> Simulador
                        </button>
                        <button onclick="setMode('portfolios')" id="btn-portfolios"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-green-500 hover:text-green-700 transition-all whitespace-nowrap">
                            <i class="fa-solid fa-folder-open hidden sm:inline"></i> Portfolios
                        </button>
                        <button onclick="setMode('backtesting')" id="btn-backtesting"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-purple-500 hover:text-purple-700 transition-all whitespace-nowrap">
                            <i class="fa-solid fa-clock-rotate-left hidden sm:inline"></i> M치quina del Tiempo
                        </button>
                        <button onclick="setMode('rebalance')" id="btn-rebalance"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-purple-500 hover:text-purple-700 transition-all whitespace-nowrap">
                            <i class="fa-solid fa-scale-balanced hidden sm:inline"></i> Rebalanceo
                        </button>
                        <button onclick="setMode('dashboard')" id="btn-dashboard"
                            class="px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold text-teal-500 hover:text-teal-700 transition-all whitespace-nowrap">
                            <i class="fa-solid fa-chart-pie hidden sm:inline"></i> Dashboard
                        </button>
                    </div>
                    <!-- Portfolio Save Button (only visible in portfolio modes) -->
                    <button onclick="openSaveModal()" id="save-portfolio-btn"
                        class="hidden items-center gap-2 text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-1 rounded-full text-sm font-bold transition border border-blue-100 shadow-sm">
                        <i class="fa-solid fa-floppy-disk"></i> <span class="hidden md:inline">Guardar</span>
                    </button>
                    <!-- PDF Report Download Button -->
                    <button onclick="generatePDFReport()"
                        class="flex items-center gap-1 text-red-600 hover:text-red-800 bg-red-50 px-3 py-1 rounded-full text-sm font-bold transition border border-red-100 shadow-sm">
                        <i class="fa-solid fa-file-pdf"></i> <span class="hidden md:inline">Reporte PDF</span>
                    </button>
                    <button onclick="scrollToSection('ai-advisor')"
                        class="hidden sm:flex items-center gap-1 text-purple-600 hover:text-purple-800 bg-purple-50 px-3 py-1 rounded-full text-sm font-bold transition border border-purple-100 shadow-sm">
                        <i class="fa-solid fa-robot"></i> <span class="hidden md:inline">Consultor IA</span>
                    </button>
                    <!-- Mobile Menu Button (visible only on mobile) -->
                    <div class="relative md:hidden">
                        <button onclick="toggleMobileMenu()" id="mobile-menu-btn"
                            class="flex items-center justify-center w-9 h-9 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-600 transition-all duration-300 shadow-sm border border-blue-200"
                            title="Men칰">
                            <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                        </button>
                        <!-- Mobile Dropdown Menu -->
                        <div id="mobile-menu-dropdown"
                            class="hidden absolute right-0 top-12 bg-white rounded-xl shadow-2xl border border-slate-200 p-2 min-w-[180px] z-[100]">
                            <button onclick="openSaveModal(); toggleMobileMenu();"
                                class="flex items-center gap-2 w-full text-left px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium">
                                <i class="fa-solid fa-floppy-disk"></i> Guardar Portfolio
                            </button>
                            <button onclick="generatePDFReport(); toggleMobileMenu();"
                                class="flex items-center gap-2 w-full text-left px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition text-sm font-medium">
                                <i class="fa-solid fa-file-pdf"></i> Generar Reporte PDF
                            </button>
                            <button onclick="scrollToSection('ai-advisor'); toggleMobileMenu();"
                                class="flex items-center gap-2 w-full text-left px-3 py-2 text-purple-600 hover:bg-purple-50 rounded-lg transition text-sm font-medium">
                                <i class="fa-solid fa-robot"></i> Consultor IA
                            </button>
                            <hr class="my-2 border-slate-200">
                            <button onclick="exportDataAsJSON(); toggleMobileMenu();"
                                class="flex items-center gap-2 w-full text-left px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-lg transition text-sm font-medium">
                                <i class="fa-solid fa-download"></i> Exportar Datos
                            </button>
                        </div>
                    </div>
                    <!-- Theme Toggle Button (rightmost) -->
                    <button onclick="toggleTheme()" id="theme-toggle-btn"
                        class="flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 transition-all duration-300 shadow-sm border border-slate-200"
                        title="Cambiar tema">
                        <i id="theme-icon" class="fa-solid fa-moon text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="bg-white border-b border-slate-200 transition-colors duration-500">
        <div class="w-full md:max-w-7xl mx-auto px-4 py-8 sm:py-12 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight sm:text-5xl mb-4">
                Tu Estrategia: <span id="hero-highlight" class="text-blue-600">Crecimiento Equilibrado</span>
            </h1>
            <p id="hero-desc" class="max-w-2xl mx-auto text-xl text-slate-500">
                Basado en *Stocks for the Long Run*. Maximiza retorno con costos bajos.
            </p>
            <div id="alert-box" class="mt-6 max-w-lg mx-auto hidden">
                <div
                    class="bg-red-900/20 border border-red-500 text-red-400 p-4 rounded-lg flex items-start gap-3 text-left">
                    <i class="fa-solid fa-triangle-exclamation mt-1"></i>
                    <div>
                        <strong class="block text-sm uppercase tracking-wide">Alerta: Agenda 2030 / Riesgo CBDC</strong>
                        <span class="text-sm opacity-90">El sistema financiero tradicional enfrenta riesgos
                            sist칠micos.</span>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex flex-col items-center">
                <label class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Tu Capital Inicial
                    (UYU)</label>
                <div class="relative max-w-xs">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-xl font-bold text-slate-400">$</span>
                    <input type="number" id="capitalInput" value="45000" oninput="updateDashboard()"
                        class="w-full pl-8 pr-4 py-3 text-center text-2xl font-bold rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-0 outline-none transition-colors shadow-sm bg-white text-slate-800">
                </div>
                <p class="text-xs text-slate-400 mt-2">Modifica este monto para recalcular toda la estrategia.</p>
            </div>
        </div>
    </header>

    <!-- MARKETS TICKER - Full Width Seamless Loop -->
    <section id="markets" class="bg-slate-900 py-2 border-b border-slate-800 overflow-hidden">
        <div class="ticker-container relative">
            <div class="ticker-track flex animate-scroll">
                <!-- Set 1 -->
                <div class="ticker-item flex items-center gap-2 px-6">
                    <div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center">
                        <i class="fa-brands fa-bitcoin text-white text-xs"></i>
                    </div>
                    <span class="text-slate-400 text-xs">Bitcoin</span>
                    <span data-price="btc" class="text-white text-sm font-bold">--</span>
                    <span data-change="btc"
                        class="text-xs font-medium px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">--</span>
                </div>
                <div class="ticker-item flex items-center gap-2 px-6">
                    <div class="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center">
                        <i class="fa-brands fa-ethereum text-white text-xs"></i>
                    </div>
                    <span class="text-slate-400 text-xs">Ethereum</span>
                    <span data-price="eth" class="text-white text-sm font-bold">--</span>
                    <span data-change="eth"
                        class="text-xs font-medium px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">--</span>
                </div>
                <div class="ticker-item flex items-center gap-2 px-6">
                    <div class="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-chart-line text-white text-xs"></i>
                    </div>
                    <span class="text-slate-400 text-xs">S&P 500</span>
                    <span data-price="sp500" class="text-white text-sm font-bold">--</span>
                    <span data-change="sp500"
                        class="text-xs font-medium px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">--</span>
                </div>
                <div class="ticker-item flex items-center gap-2 px-6">
                    <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-coins text-white text-xs"></i>
                    </div>
                    <span class="text-slate-400 text-xs">Oro</span>
                    <span data-price="gold" class="text-white text-sm font-bold">--</span>
                    <span data-change="gold"
                        class="text-xs font-medium px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">--</span>
                </div>
                <div class="ticker-item flex items-center gap-2 px-6">
                    <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-xs font-bold">餃</span>
                    </div>
                    <span class="text-slate-400 text-xs">Solana</span>
                    <span data-price="sol" class="text-white text-sm font-bold">--</span>
                    <span data-change="sol"
                        class="text-xs font-medium px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">--</span>
                </div>
            </div>
        </div>
    </section>

    <style>
        .ticker-container {
            width: 100%;
            overflow: hidden;
        }

        .ticker-track {
            display: flex;
            width: fit-content;
        }

        @keyframes scroll {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-25%);
            }
        }

        .animate-scroll {
            animation: scroll 15s linear infinite;
        }

        .animate-scroll:hover {
            animation-play-state: paused;
        }

        .ticker-item {
            white-space: nowrap;
            flex-shrink: 0;
        }
    </style>

    <script>
        // Duplicate ticker items to fill screen width and enable seamless loop
        document.addEventListener('DOMContentLoaded', function () {
            const track = document.querySelector('.ticker-track');
            if (track) {
                // Clone all items 3 more times to ensure no gaps
                const originalContent = track.innerHTML;
                track.innerHTML = originalContent + originalContent + originalContent + originalContent;
            }
        });
    </script>

    <main id="main-portfolio-content"
        class="w-full md:max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12 space-y-10 sm:space-y-20">

        <!-- SECTION 1: ALLOCATION & BUILDER -->
        <section id="allocation">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Asignaci칩n de Activos</h2>
                <p id="alloc-desc" class="text-lg text-slate-500">Distribuci칩n optimizada para crecimiento y
                    estabilidad.</p>
            </div>

            <div class="grid lg:grid-cols-3 gap-8 items-start">

                <!-- LEFT PANEL: STRATEGY / BUILDER -->
                <div class="card p-6 border-l-4 border-blue-500 flex flex-col h-full min-h-[400px]">
                    <!-- Predefined Strategy List -->
                    <div id="strategy-panel">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">L칩gica de la Cartera</h3>
                        <ul id="strategy-list" class="space-y-4 text-sm text-slate-600">
                            <!-- Populated by JS -->
                        </ul>
                    </div>

                    <!-- CUSTOM BUILDER (Hidden by default) -->
                    <div id="custom-builder" class="hidden h-full flex flex-col">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-wrench text-slate-400"></i> Dise침a tu Mix
                        </h3>
                        <div class="space-y-3 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200 inner-border">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Activo</label>
                                <select id="customAssetSelect"
                                    class="w-full p-2 rounded border border-slate-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
                                    <!-- Options populated dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Porcentaje (%)</label>
                                <div class="flex gap-2">
                                    <input type="number" id="customAssetPct" placeholder="Ej: 50" min="1" max="100"
                                        class="w-full p-2 rounded border border-slate-300 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
                                    <button onclick="addCustomAsset()"
                                        class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 transition">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-xs font-bold text-slate-400 uppercase">Tus Activos</h4>
                                <button onclick="showClearPortfolioModal()"
                                    class="text-red-400 hover:text-red-600 text-xs" title="Borrar cartera">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <ul id="custom-asset-list" class="space-y-2 text-sm">
                                <li class="text-slate-400 italic text-xs text-center py-4">A침ade activos arriba...</li>
                            </ul>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-slate-700">Total:</span>
                                <span id="custom-total-pct" class="font-bold text-slate-800">0%</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden mb-1">
                                <div id="custom-progress-bar" class="h-full bg-blue-500 w-0 transition-all"></div>
                            </div>
                            <p id="custom-warning" class="text-[10px] text-red-500 hidden text-right">Debe sumar 100%
                            </p>

                            <!-- AUDIT BUTTON HERE - MOVED TO BUILDER PANEL -->
                            <button onclick="auditCustomPortfolio()"
                                class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded shadow flex items-center justify-center gap-2 text-sm font-bold transition">
                                <i class="fa-solid fa-user-secret"></i> Auditar Cartera con IA
                            </button>
                            <button onclick="designPortfolioWithAI()"
                                class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded shadow flex items-center justify-center gap-2 text-sm font-bold transition">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Armar Portfolio con IA
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Center: Chart -->
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>

                <!-- Right Panel: Asset Breakdown -->
                <div class="card p-6 h-full flex flex-col">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex justify-between">
                        <span>Desglose</span>
                        <span id="breakdown-total" class="text-slate-400 text-base">$45.000</span>
                    </h3>
                    <div id="asset-breakdown" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: PROJECTION -->
        <section id="projection" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-slate-900 mb-4 text-center">Proyecci칩n a Futuro</h2>

            <!-- Monte Carlo Toggle -->
            <div class="flex justify-center mb-6">
                <div class="bg-slate-100 rounded-xl p-1 inline-flex gap-1">
                    <button id="proj-mode-simple" onclick="setProjectionMode('simple')"
                        class="px-4 py-2 rounded-lg text-sm font-bold transition bg-white shadow text-blue-600">
                        <i class="fa-solid fa-chart-line mr-1"></i> Proyecci칩n Simple
                    </button>
                    <button id="proj-mode-montecarlo" onclick="setProjectionMode('montecarlo')"
                        class="px-4 py-2 rounded-lg text-sm font-bold transition text-slate-600 hover:bg-white/50">
                        <i class="fa-solid fa-chart-area mr-1"></i> Probabilidades (Montecarlo)
                    </button>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="card p-6 lg:col-span-1">
                    <h3 class="text-lg font-semibold mb-4 text-slate-700">Variables</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Aporte Mensual (UYU)</label>
                            <input type="number" id="monthlyContrib" value="2000"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                oninput="updateProjection()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">A침os</label>
                            <input type="number" id="yearsProj" value="10" min="1" max="30"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                oninput="updateProjection()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Retorno Est. Anual (%)</label>
                            <!-- EDITABLE INPUT WITH NO READONLY -->
                            <div class="relative">
                                <input type="number" id="expectedReturn" value="8" step="0.1"
                                    class="w-full p-2 border border-slate-300 rounded focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white font-bold text-blue-600 pr-8"
                                    oninput="updateProjection()">
                                <button class="absolute right-2 top-2 text-slate-400 hover:text-blue-500"
                                    title="Restaurar valor calculado" onclick="recalcReturnFromAssets()">
                                    <i class="fa-solid fa-rotate-left"></i>
                                </button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1">Editable.  Recalcular seg칰n activos.</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6 lg:col-span-2 flex flex-col justify-center">
                    <div class="chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: PLANIFICADOR DE METAS (Modo Objetivo) -->
        <section id="goal-planner" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-slate-900 mb-4 text-center">
                <i class="fa-solid fa-bullseye text-purple-500 mr-2"></i>Planificador de Metas
            </h2>
            <p class="text-center text-slate-500 mb-6">쮺u치nto necesitas invertir para alcanzar tu objetivo?</p>

            <div class="card p-6 lg:p-8">
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Inputs (Left Side) -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-sliders text-purple-500"></i>
                            Define tu Meta
                        </h3>

                        <!-- Meta Financiera -->
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">
                                游꿢 Meta Financiera ($)
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                                <input type="number" id="goal-target" value="100000" min="0" step="1000"
                                    class="w-full pl-8 pr-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg font-bold text-purple-700"
                                    oninput="calculateRequiredPMT()">
                            </div>
                            <p class="text-xs text-slate-400 mt-1">El monto que quieres alcanzar</p>
                        </div>

                        <!-- Plazo -->
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">
                                낋 Plazo (A침os): <span id="goal-years-display" class="text-purple-600">10</span>
                            </label>
                            <input type="range" id="goal-years" value="10" min="1" max="30" step="1"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-purple-500"
                                oninput="document.getElementById('goal-years-display').textContent = this.value; calculateRequiredPMT()">
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>1 a침o</span>
                                <span>15 a침os</span>
                                <span>30 a침os</span>
                            </div>
                        </div>

                        <!-- Capital Inicial -->
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">
                                游눯 Capital Inicial
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                <input type="number" id="goal-capital" value="45000" min="0" step="1000"
                                    class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    oninput="calculateRequiredPMT()">
                            </div>
                            <p class="text-xs text-slate-400 mt-1">Tu patrimonio actual (vinculado arriba)</p>
                        </div>

                        <!-- Tasa Esperada -->
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">
                                游늳 Tasa Esperada Anual (%): <span id="goal-rate-display" class="text-blue-600">8%</span>
                            </label>
                            <input type="range" id="goal-rate" value="8" min="0" max="20" step="0.5"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                oninput="document.getElementById('goal-rate-display').textContent = this.value + '%'; calculateRequiredPMT()">
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>0% (Conservador)</span>
                                <span>10%</span>
                                <span>20% (Agresivo)</span>
                            </div>
                            <p class="text-xs text-blue-500 mt-2">
                                <i class="fa-solid fa-info-circle mr-1"></i>
                                Estrategia actual: <span id="goal-strategy-name">Mixta</span>
                            </p>
                        </div>
                    </div>

                    <!-- Results (Right Side) -->
                    <div
                        class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-6 lg:p-8 flex flex-col justify-center">
                        <div class="text-center">
                            <p class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">
                                El N칰mero M치gico
                            </p>
                            <div class="mb-4">
                                <span class="text-sm text-slate-600">Aporte Mensual Necesario:</span>
                            </div>
                            <div id="goal-result-pmt" class="text-5xl lg:text-6xl font-black text-purple-600 mb-4">
                                $1.500
                            </div>
                            <p class="text-slate-500 mb-6">
                                para alcanzar <span id="goal-result-target"
                                    class="font-bold text-purple-700">$100.000</span>
                                en <span id="goal-result-years" class="font-bold">10</span> a침os
                            </p>

                            <!-- Comparison with current contribution -->
                            <div id="goal-comparison" class="p-4 rounded-xl bg-white shadow-sm border-2 border-dashed">
                                <p class="text-sm text-slate-600 mb-2">Comparaci칩n con tu aporte actual:</p>
                                <div class="flex items-center justify-center gap-3">
                                    <div class="text-center">
                                        <p class="text-xs text-slate-400">Necesitas</p>
                                        <p id="goal-needed" class="text-xl font-bold text-purple-600">$1.500</p>
                                    </div>
                                    <i class="fa-solid fa-arrows-left-right text-slate-300"></i>
                                    <div class="text-center">
                                        <p class="text-xs text-slate-400">Aportas</p>
                                        <p id="goal-current" class="text-xl font-bold text-slate-600">$2.000</p>
                                    </div>
                                </div>
                                <div id="goal-diff-container" class="mt-3 p-3 rounded-lg">
                                    <p id="goal-diff-message" class="font-bold text-sm">
                                        <!-- Will be filled by JS -->
                                    </p>
                                </div>
                            </div>

                            <!-- Bonus: What if I increase rate? -->
                            <div class="mt-6 p-4 bg-white/50 rounded-xl text-left">
                                <p class="text-xs font-bold text-slate-500 uppercase mb-2">
                                    <i class="fa-solid fa-lightbulb text-amber-500 mr-1"></i>Tip
                                </p>
                                <p id="goal-tip" class="text-sm text-slate-600">
                                    Si cambias a una estrategia con mayor retorno, necesitar치s aportar menos dinero
                                    mensualmente.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- SIMULADOR - Outside main so it can show independently -->
    <div id="simulador-wrapper" class="w-full md:max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12 hidden">
        <!-- SECTION: SIMULADOR DE INTER칄S COMPUESTO -->
        <section id="simulador" class="scroll-mt-24">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">
                    <i class="fa-solid fa-calculator text-blue-500 mr-2"></i>Simulador de Inversi칩n
                </h2>
                <p class="text-lg text-slate-500">Compara diferentes estrategias de inversi칩n</p>
            </div>

            <!-- Global Configuration -->
            <div class="card p-6 mb-8 border-l-4 border-blue-500 bg-white shadow-sm">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-blue-500"></i>
                    Configuraci칩n General
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Capital Inicial</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                            <input type="number" id="sim-capital" value="45000" min="0" step="1000"
                                class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Aporte Mensual</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                            <input type="number" id="sim-aporte" value="2000" min="0" step="100"
                                class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Duraci칩n (A침os)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><i
                                    class="fa-regular fa-calendar"></i></span>
                            <input type="number" id="sim-years" value="10" min="1" max="50"
                                class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scenarios Container -->
            <div id="scenarios-container" class="space-y-6 mb-8">
                <!-- Scenarios will be dynamically injected here by renderScenarios() -->
                <!-- Custom Asset Name Input (shown when Personalizado is selected) -->
                <div id="custom-asset-input" class="hidden mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <label class="block text-xs font-bold text-blue-700 mb-1">Nombre del activo
                        personalizado</label>
                    <input type="text" id="sim-custom-name" value="Mi Inversi칩n"
                        class="w-full px-3 py-2 text-sm border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ej: Fondo XYZ, Crypto ABC...">
                </div>

                <!-- Input Fields -->
                <!-- Input Fields (Only Rate Slider remains) -->
                <div class="mt-4">
                    <label class="block text-sm font-bold text-slate-600 mb-1">
                        Rentabilidad Anual Esperada: <span id="sim-rate-display" class="text-blue-600">10%</span>
                    </label>
                    <input type="range" id="sim-rate" value="10" min="0" max="50" step="0.5"
                        class="sim-rate w-full accent-blue-500"
                        oninput="updateScenarioData(1, 'rate', this.value); document.getElementById('sim-rate-display').textContent = this.value + '%'">
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>0%</span>
                        <span>25%</span>
                        <span>50%</span>
                    </div>
                </div>

                <!-- Results Summary (per scenario) -->
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-xs text-slate-500 uppercase">Capital Final</div>
                            <div id="sim-result-final-1" class="sim-result-final text-2xl font-bold text-blue-600">$0
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 uppercase">Ganancia Total</div>
                            <div id="sim-result-gain-1" class="sim-result-gain text-2xl font-bold text-green-600">$0
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-blue-200 grid grid-cols-2 gap-4 text-center text-sm">
                        <div>
                            <span class="text-slate-500">Total Invertido:</span>
                            <span id="sim-result-invested-1"
                                class="sim-result-invested font-bold text-slate-700">$0</span>
                        </div>
                        <div>
                            <span class="text-slate-500">Rendimiento:</span>
                            <span id="sim-result-roi-1" class="sim-result-roi font-bold text-green-600">0%</span>
                        </div>
                    </div>
                </div>
            </div>
    </div>


    <!-- Extra Simulator Content (Controlled via JS for safety) -->
    <div id="simulator-extra-content" class="hidden">
        <!-- Add Scenario Button (moved to end for better UX) -->
        <div class="text-center mb-8">
            <button onclick="addScenario()" id="add-scenario-btn"
                class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2 mx-auto shadow-md hover:shadow-lg">
                <i class="fa-solid fa-plus"></i>
                <span>Agregar Escenario para Comparar</span>
            </button>
        </div>

        <!-- COMPARISON CHART & TABLE (shows all scenarios) -->
        <div class="card p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">
                <i class="fa-solid fa-chart-line mr-2"></i>Comparaci칩n de Escenarios
            </h3>
            <div class="h-[400px] mb-6">
                <canvas id="simChart"></canvas>
            </div>

            <h4 class="text-sm font-bold text-slate-600 mb-2">Comparaci칩n Final</h4>
            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="w-full text-sm" id="comparison-table">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-slate-600">Escenario</th>
                            <th class="px-3 py-2 text-right text-slate-600">Activo</th>
                            <th class="px-3 py-2 text-right text-slate-600">Capital Inicial</th>
                            <th class="px-3 py-2 text-right text-slate-600">Aporte Mensual</th>
                            <th class="px-3 py-2 text-right text-slate-600">A침os</th>
                            <th class="px-3 py-2 text-right text-slate-600">Tasa</th>
                            <th class="px-3 py-2 text-right text-slate-600">Capital Final</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-tbody" class="divide-y divide-slate-100">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </section>
    </div>

    <!-- REBALANCING CALCULATOR SECTION (hidden by default) -->
    <div id="rebalance-wrapper" class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12 hidden">
        <section id="rebalance-section" class="scroll-mt-24">
            <!-- Header -->
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">
                    <i class="fa-solid fa-scale-balanced text-purple-500 mr-2"></i>Calculadora de Rebalanceo
                </h2>
                <p class="text-lg text-slate-500">Calcula exactamente qu칠 comprar o vender para equilibrar tu portafolio
                </p>
            </div>

            <!-- Input Card -->
            <div class="card p-6 mb-6">
                <!-- Quick Load Buttons -->
                <div class="flex flex-wrap items-center gap-2 mb-4 pb-4 border-b border-slate-200">
                    <span class="text-sm font-bold text-slate-600 mr-2">游닌 Cargar Metas:</span>
                    <button onclick="loadRebalanceFromStrategy('normal')"
                        class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg text-xs transition">
                        游꿢 Normie
                    </button>
                    <button onclick="loadRebalanceFromStrategy('sovereign')"
                        class="px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-700 font-bold rounded-lg text-xs transition">
                        游댏 Soberano
                    </button>
                    <button onclick="loadRebalanceFromStrategy('custom')"
                        class="px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold rounded-lg text-xs transition">
                        九 Mi Estrategia Actual
                    </button>
                    <span class="text-slate-300 mx-1">|</span>
                    <select id="rebalance-portfolio-select" onchange="loadRebalanceFromPortfolio(this.value)"
                        class="px-3 py-1.5 bg-purple-50 border border-purple-200 text-purple-700 font-bold rounded-lg text-xs transition cursor-pointer">
                        <option value="">游늬 Mis Portfolios...</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                    <div class="flex-1"></div>
                    <button onclick="saveRebalanceState()"
                        class="px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 font-bold rounded-lg text-xs transition flex items-center gap-1">
                        <i class="fa-solid fa-download"></i> Exportar JSON
                    </button>
                </div>

                <!-- New Money Input -->
                <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-xl">
                    <div class="flex flex-wrap items-center gap-4">
                        <label class="text-sm font-bold text-green-700">
                            <i class="fa-solid fa-money-bill-wave mr-1"></i>
                            游눯 Dinero Nuevo a Invertir (Opcional):
                        </label>
                        <div class="relative flex-1 max-w-xs">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-green-500 font-bold">$</span>
                            <input type="number" id="rebalance-new-money" placeholder="0" min="0" step="100" value="0"
                                class="w-full pl-8 pr-4 py-2 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-right font-bold text-green-700"
                                oninput="updateRebalanceTotals()">
                        </div>
                        <span class="text-xs text-green-600">Tu aporte mensual para rebalancear</span>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800">
                        <i class="fa-solid fa-list-check text-blue-500 mr-2"></i>Mi Portafolio Actual
                    </h3>
                    <button onclick="addRebalanceRow()"
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl transition flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Agregar Activo
                    </button>
                </div>

                <!-- Assets Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-slate-200">
                                <th class="text-left py-3 px-2 text-sm font-bold text-slate-600">Activo</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-slate-600">Valor Actual ($)</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-slate-600">Meta %</th>
                                <th class="text-right py-3 px-2 text-sm font-bold text-slate-400">Meta $</th>
                                <th class="text-center py-3 px-2 text-sm font-bold text-slate-600 w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="rebalance-rows">
                            <!-- Dynamic rows will be inserted here -->
                        </tbody>
                        <tfoot>
                            <tr class="border-t-2 border-slate-300 bg-slate-50">
                                <td class="py-2 px-2 font-bold text-slate-600">
                                    <i class="fa-solid fa-wallet mr-1"></i>Total Actual
                                </td>
                                <td id="rebalance-total-value" class="text-right py-2 px-2 font-bold text-slate-700">$0
                                </td>
                                <td id="rebalance-total-pct" class="text-right py-2 px-2 font-bold">0%</td>
                                <td class="text-right py-2 px-2 text-slate-400">-</td>
                                <td></td>
                            </tr>
                            <tr class="bg-green-50">
                                <td class="py-2 px-2 font-bold text-green-700">
                                    <i class="fa-solid fa-plus-circle mr-1"></i>+ Dinero Nuevo
                                </td>
                                <td id="rebalance-new-money-display"
                                    class="text-right py-2 px-2 font-bold text-green-600">$0</td>
                                <td colspan="2"></td>
                                <td></td>
                            </tr>
                            <tr class="border-t-2 border-purple-300 bg-purple-100">
                                <td class="py-3 px-2 font-bold text-purple-800 text-lg">
                                    <i class="fa-solid fa-chart-pie mr-1"></i>PATRIMONIO FUTURO
                                </td>
                                <td id="rebalance-total-future"
                                    class="text-right py-3 px-2 font-bold text-purple-800 text-xl">$0</td>
                                <td class="text-right py-3 px-2 font-bold text-purple-600">100%</td>
                                <td id="rebalance-total-ideal" class="text-right py-3 px-2 font-bold text-purple-600">$0
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Percentage Validation Bar -->
                <div class="mt-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-slate-600">Suma de Metas:</span>
                        <span id="rebalance-pct-status" class="font-bold text-red-600">0% (Falta 100%)</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                        <div id="rebalance-pct-bar" class="h-full bg-red-500 transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <div class="mt-6 text-center">
                    <button onclick="calculateRebalance()"
                        class="px-8 py-3 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold rounded-xl transition shadow-lg hover:shadow-xl">
                        <i class="fa-solid fa-calculator mr-2"></i> Calcular Rebalanceo
                    </button>
                </div>
            </div>

            <!-- Results Card (hidden initially) -->
            <div id="rebalance-results" class="card p-6 hidden">
                <h3 class="text-lg font-bold text-slate-800 mb-4">
                    <i class="fa-solid fa-clipboard-list text-green-500 mr-2"></i>Plan de Acci칩n
                </h3>
                <div id="rebalance-actions" class="space-y-3">
                    <!-- Dynamic action items will be inserted here -->
                </div>

                <!-- Summary -->
                <div class="mt-6 p-4 bg-slate-100 rounded-xl">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-sm text-slate-500">Total a Comprar</div>
                            <div id="rebalance-total-buy" class="text-xl font-bold text-green-600">$0</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-500">Total a Vender</div>
                            <div id="rebalance-total-sell" class="text-xl font-bold text-red-600">$0</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- PORTFOLIOS MANAGEMENT SECTION (hidden by default) -->
    <div id="portfolios-wrapper" class="w-full md:max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12 hidden">
        <section id="portfolios-section" class="scroll-mt-24">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">
                    <i class="fa-solid fa-folder-open text-green-500 mr-2"></i>Mis Portfolios
                </h2>
                <p class="text-lg text-slate-500">Administra y organiza tus configuraciones guardadas</p>
            </div>

            <!-- Actions Bar -->
            <div class="card p-4 mb-6 flex flex-wrap gap-3 justify-between items-center">
                <div class="flex gap-3">
                    <button onclick="openCreatePortfolioModal()"
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition flex items-center gap-2 shadow-md">
                        <i class="fa-solid fa-plus"></i>
                        <span>Nuevo Portfolio</span>
                    </button>
                    <button onclick="triggerImportPortfolio()"
                        class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition flex items-center gap-2 shadow-md">
                        <i class="fa-solid fa-file-import"></i>
                        <span>Importar</span>
                    </button>
                </div>
                <div class="text-sm text-slate-500">
                    <i class="fa-solid fa-database mr-1"></i>
                    <span id="total-portfolios-count">0</span> portfolios guardados
                </div>
            </div>

            <!-- Portfolios Grid -->
            <div id="portfolios-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Populated by renderPortfoliosGrid() -->
            </div>

            <!-- Empty State -->
            <div id="portfolios-empty-state" class="hidden text-center py-20">
                <i class="fa-solid fa-folder-open text-slate-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-bold text-slate-400 mb-2">No tienes portfolios guardados</h3>
                <p class="text-slate-400 mb-6">Crea tu primera configuraci칩n y gu치rdala para acceder r치pidamente</p>
                <button onclick="setMode('normal')"
                    class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition shadow-lg">
                    <i class="fa-solid fa-plus mr-2"></i>Crear Mi Primer Portfolio
                </button>
            </div>
        </section>
    </div>

    <!-- BACKTESTING SECTION (TIME MACHINE) -->
    <div id="backtesting-wrapper" class="w-full md:max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-8 hidden">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">M치quina del Tiempo 游돓勇</h2>
            <p class="text-lg text-slate-600">
                Viaja al pasado y descubre cu치nto tendr칤as hoy.
            </p>
        </div>

        <!-- CONTROLS ROW - 3 Premium Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <!-- Card 1: Estrategia -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-bullseye text-purple-500"></i> Qu칠 Simular
                </h3>

                <!-- Mode Toggle -->
                <div class="flex gap-2 mb-4">
                    <button type="button" id="bt-mode-asset" onclick="setBacktestMode('asset')"
                        class="flex-1 py-2.5 px-4 rounded-xl border-2 border-purple-500 bg-purple-50 text-purple-700 font-bold text-sm transition shadow-sm hover:shadow-md">
                        <i class="fa-solid fa-chart-line mr-1"></i> Activo Individual
                    </button>
                    <button type="button" id="bt-mode-strategy" onclick="setBacktestMode('strategy')"
                        class="flex-1 py-2.5 px-4 rounded-xl border-2 border-slate-200 bg-white text-slate-600 font-bold text-sm transition hover:border-purple-300 hover:shadow-md">
                        <i class="fa-solid fa-pie-chart mr-1"></i> Estrategia
                    </button>
                </div>

                <!-- Asset Selector -->
                <div id="bt-asset-selector">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Activo</label>
                    <select id="bt-asset"
                        class="w-full p-3 text-sm border border-slate-300 rounded-xl bg-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition shadow-sm hover:shadow-md cursor-pointer">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <!-- Strategy Selector -->
                <div id="bt-strategy-selector" class="hidden">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Estrategia</label>
                    <select id="bt-strategy"
                        class="w-full p-3 text-sm border border-slate-300 rounded-xl bg-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition shadow-sm hover:shadow-md cursor-pointer">
                        <option value="current">游늵 Mi Estrategia Actual</option>
                        <option value="normal">游꿢 Normie (60% S&P + 40% Fondo)</option>
                        <option value="sovereign">游댏 Soberano (35% BTC + 45% S&P + 20% Fondo)</option>
                    </select>
                    <div id="bt-strategy-preview" class="mt-3 p-3 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="text-xs font-bold text-slate-500 mb-1">Composici칩n:</div>
                        <div id="bt-strategy-composition" class="text-xs text-slate-600"></div>
                    </div>
                </div>
            </div>

            <!-- Card 2: Variables -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-coins text-green-500"></i> Inversi칩n
                </h3>

                <div class="space-y-4">
                    <!-- Monto Inicial -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Monto Inicial</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">$</span>
                            <input type="number" id="bt-amount" value="1000" min="0" step="100"
                                class="w-full pl-9 pr-4 py-3 text-base font-medium border border-slate-300 rounded-xl bg-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition shadow-sm hover:shadow-md">
                        </div>
                    </div>

                    <!-- Aporte Mensual -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Aporte Mensual (DCA)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">$</span>
                            <input type="number" id="bt-monthly" value="100" min="0" step="50"
                                class="w-full pl-9 pr-4 py-3 text-base font-medium border border-slate-300 rounded-xl bg-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition shadow-sm hover:shadow-md">
                        </div>
                    </div>

                    <!-- Periodo -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">
                            Periodo: <span id="bt-years-display" class="text-purple-600 font-bold">5</span> a침os atr치s
                        </label>
                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                            <span class="text-xs text-slate-400">1</span>
                            <input type="range" id="bt-years-slider" min="1" max="10" value="5"
                                class="flex-1 h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-purple-600"
                                oninput="document.getElementById('bt-years-display').textContent = this.value">
                            <span class="text-xs text-slate-400">10</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3: Opciones & Acci칩n -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 flex flex-col">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-blue-500"></i> Opciones
                </h3>

                <div class="space-y-3 flex-grow">
                    <!-- Real Return Toggle -->
                    <div class="flex items-center justify-between p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="bt-real-return-toggle" checked
                                class="w-5 h-5 text-amber-500 rounded-lg focus:ring-amber-400">
                            <span class="text-sm font-bold text-slate-700">Retorno Real</span>
                        </label>
                        <select id="bt-currency-perspective"
                            class="text-xs px-2 py-1.5 border border-amber-300 rounded-lg bg-white focus:ring-2 focus:ring-amber-400 outline-none cursor-pointer shadow-sm">
                            <option value="local">游쥟릖 UYU</option>
                            <option value="usd">游쥟릖 USD</option>
                        </select>
                    </div>

                    <!-- Rebalance Toggle (Strategy only) -->
                    <label id="bt-rebalance-row"
                        class="flex items-center justify-between p-3 bg-purple-50 rounded-xl border border-purple-200 cursor-pointer hidden">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="bt-rebalance" checked
                                class="w-5 h-5 text-purple-600 rounded-lg focus:ring-purple-400">
                            <span class="text-sm font-bold text-slate-700">Rebalanceo Anual</span>
                        </div>
                        <span class="group relative cursor-help">
                            <i class="fa-solid fa-circle-info text-purple-400"></i>
                            <span
                                class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-slate-800 text-xs text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-lg">
                                Vende ganancias cada a침o para<br>mantener tu nivel de riesgo original
                            </span>
                        </span>
                    </label>

                    <!-- Ghost Line Toggle (Strategy only) -->
                    <label id="bt-ghost-row"
                        class="flex items-center justify-between p-3 bg-orange-50 rounded-xl border border-orange-200 cursor-pointer hidden">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="bt-show-ghost"
                                class="w-5 h-5 text-orange-500 rounded-lg focus:ring-orange-400">
                            <span class="text-sm font-bold text-slate-700">Comparar Buy & Hold</span>
                        </div>
                        <span class="group relative cursor-help">
                            <i class="fa-solid fa-circle-info text-orange-400"></i>
                            <span
                                class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-slate-800 text-xs text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-lg">
                                Muestra qu칠 pasar칤a si nunca<br>rebalanceas (l칤nea naranja)
                            </span>
                        </span>
                    </label>

                    <!-- Inflation Toggle -->
                    <label
                        class="flex items-center gap-3 p-3 bg-red-50 rounded-xl border border-red-200 cursor-pointer">
                        <input type="checkbox" id="bt-show-inflation" checked
                            class="w-5 h-5 text-red-500 rounded-lg focus:ring-red-400">
                        <span class="text-sm font-bold text-slate-700">Mostrar Inflaci칩n</span>
                    </label>
                </div>

                <!-- Calculate Button -->
                <button onclick="runBacktest()"
                    class="mt-4 w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-chart-line mr-2"></i>Calcular Resultado
                </button>
            </div>
        </div>

        <!-- PANORAMIC CHART -->
        <div class="card p-6 bg-white shadow-lg rounded-xl border border-slate-100 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">游늳 Evoluci칩n Hist칩rica</h3>
                <div id="bt-currency-badge"
                    class="text-xs bg-slate-100 px-3 py-1 rounded-full text-slate-600 flex items-center gap-1">
                    <span id="bt-currency-flag">游쥟릖</span>
                    <span id="bt-currency-code">USD</span>
                </div>
            </div>
            <!-- 16:9 Aspect Ratio Container -->
            <div class="relative w-full" style="padding-bottom: 45%;">
                <div class="absolute inset-0">
                    <canvas id="backtestChart"></canvas>
                </div>
            </div>
            <p class="text-xs text-slate-400 text-center mt-4">
                * Datos hist칩ricos reales (1990-2024). Rendimientos pasados no garantizan resultados futuros.
            </p>
        </div>

        <!-- KPI METRICS CARDS -->
        <div id="bt-kpi-cards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 hidden">
            <!-- CAGR -->
            <div class="bg-white rounded-xl shadow-md border border-slate-100 p-4 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                    <i class="fa-solid fa-chart-line text-purple-500"></i>
                    <span class="text-xs font-bold text-slate-500 uppercase">CAGR</span>
                    <span class="group relative cursor-help">
                        <i class="fa-solid fa-circle-info text-slate-300 text-xs"></i>
                        <span
                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-slate-800 text-xs text-white rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20">
                            Crecimiento Anual<br>Compuesto
                        </span>
                    </span>
                </div>
                <div id="bt-kpi-cagr" class="text-2xl font-bold text-purple-600">--%</div>
                <div class="text-xs text-slate-400">Anual</div>
            </div>

            <!-- Best Year -->
            <div class="bg-white rounded-xl shadow-md border border-slate-100 p-4 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                    <i class="fa-solid fa-arrow-up text-green-500"></i>
                    <span class="text-xs font-bold text-slate-500 uppercase">Mejor A침o</span>
                </div>
                <div id="bt-kpi-best" class="text-2xl font-bold text-green-600">--%</div>
                <div id="bt-kpi-best-year" class="text-xs text-slate-400">----</div>
            </div>

            <!-- Worst Year -->
            <div class="bg-white rounded-xl shadow-md border border-slate-100 p-4 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                    <i class="fa-solid fa-arrow-down text-red-500"></i>
                    <span class="text-xs font-bold text-slate-500 uppercase">Peor A침o</span>
                </div>
                <div id="bt-kpi-worst" class="text-2xl font-bold text-red-600">--%</div>
                <div id="bt-kpi-worst-year" class="text-xs text-slate-400">----</div>
            </div>

            <!-- Max Drawdown -->
            <div class="bg-white rounded-xl shadow-md border border-slate-100 p-4 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                    <i class="fa-solid fa-exclamation-triangle text-amber-500"></i>
                    <span class="text-xs font-bold text-slate-500 uppercase">Max Ca칤da</span>
                    <span class="group relative cursor-help">
                        <i class="fa-solid fa-circle-info text-slate-300 text-xs"></i>
                        <span
                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-800 text-xs text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-lg">
                            Ca칤da m치xima desde un pico hist칩rico<br>
                            <span class="text-amber-400">丘멆잺 Basado en cierres mensuales.</span><br>
                            <span class="text-slate-400">La ca칤da intra-mes puede ser mayor</span><br>
                            <span class="text-slate-400">(ej. COVID: -34% intraday)</span>
                        </span>
                    </span>
                </div>
                <div id="bt-kpi-drawdown" class="text-2xl font-bold text-amber-600">--%</div>
                <div class="text-xs text-slate-400">Cierres mensuales</div>
            </div>

            <!-- Volatility -->
            <div class="bg-white rounded-xl shadow-md border border-slate-100 p-4 text-center col-span-2 md:col-span-1">
                <div class="flex items-center justify-center gap-1 mb-2">
                    <i class="fa-solid fa-wave-square text-blue-500"></i>
                    <span class="text-xs font-bold text-slate-500 uppercase">Volatilidad</span>
                    <span class="group relative cursor-help">
                        <i class="fa-solid fa-circle-info text-slate-300 text-xs"></i>
                        <span
                            class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-slate-800 text-xs text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-lg">
                            Desviaci칩n est치ndar anualizada<br>
                            <span class="text-slate-400">(mensual 칑 갴12)</span>
                        </span>
                    </span>
                </div>
                <div id="bt-kpi-volatility" class="text-2xl font-bold text-blue-600">--%</div>
                <div class="text-xs text-slate-400">Desv. Std</div>
            </div>
        </div>

        <!-- DETAILED RESULTS CARD -->
        <div id="bt-result-card"
            class="card p-6 bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-xl rounded-xl border border-slate-700 hidden">

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <div class="text-slate-400 text-xs uppercase">Valor Final</div>
                    <div class="text-2xl font-bold">
                        <span id="bt-currency-symbol">US$</span><span id="bt-final-value">0</span>
                    </div>
                </div>
                <div>
                    <div class="text-slate-400 text-xs uppercase">Total Invertido</div>
                    <div class="text-xl font-bold text-slate-300">
                        <span class="bt-currency-prefix">US$</span><span id="bt-total-invested">0</span>
                    </div>
                </div>
                <div>
                    <div class="text-slate-400 text-xs uppercase" id="bt-return-label">Retorno Nominal</div>
                    <div class="text-xl font-bold text-green-400" id="bt-total-return">0%</div>
                </div>
                <div>
                    <div class="text-slate-400 text-xs uppercase">Ganancia Neta</div>
                    <div class="text-xl font-bold text-green-400">
                        <span class="bt-currency-prefix">US$</span><span id="bt-net-gain">0</span>
                    </div>
                </div>
            </div>

            <!-- Real Return Section -->
            <div id="bt-real-return-section" class="mt-6 pt-4 border-t border-slate-600">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-fire text-amber-400"></i>
                    <span class="text-sm font-bold text-amber-400">Retorno Real (Poder de Compra)</span>
                    <span class="group relative cursor-help">
                        <i class="fa-solid fa-circle-info text-slate-500 text-xs"></i>
                        <span
                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                            Ganancia despu칠s de descontar inflaci칩n
                        </span>
                    </span>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <div class="text-slate-400 text-xs">Inflaci칩n <span id="bt-inflation-country">(UY)</span></div>
                        <div class="font-bold text-red-400" id="bt-inflation">0%</div>
                    </div>
                    <div>
                        <div class="text-slate-400 text-xs">CAGR Real</div>
                        <div class="font-bold text-blue-400" id="bt-cagr">0%</div>
                    </div>
                    <div>
                        <div class="text-slate-400 text-xs">Retorno Real</div>
                        <div class="font-bold text-green-400" id="bt-real-return">0%</div>
                    </div>
                    <div>
                        <div class="text-slate-400 text-xs">Ganancia Real</div>
                        <div class="font-bold text-green-400" id="bt-real-gain">$0</div>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-3" id="bt-real-explanation"></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD - Centro de Comando (hidden by default) -->
    <div id="dashboard-wrapper" class="hidden min-h-screen transition-colors duration-300"
        style="background-color: var(--bg-primary);">
        <div class="max-w-[1320px] mx-auto px-5 md:px-6 lg:px-8 py-6">

            <!-- Top Bar -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-3">
                    <span class="text-xl font-semibold flex items-center gap-2" style="color: rgba(255,255,255,0.92);">
                        游꺔 Plan Semilla
                    </span>
                    <button onclick="generatePDFReport()"
                        class="px-4 py-2 text-sm font-medium rounded-xl flex items-center gap-2 transition-all hover:shadow-lg"
                        style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">
                        <i class="fa-solid fa-file-lines"></i> Generar Reporte
                    </button>
                    <button onclick="exportDashboardData()"
                        class="px-4 py-2 text-sm font-medium rounded-xl flex items-center gap-2 transition-all hover:shadow-lg"
                        style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">
                        <i class="fa-solid fa-download"></i> Exportar Datos
                    </button>
                </div>
                <div class="relative flex-1 max-w-[360px]">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2"
                        style="color: rgba(255,255,255,0.42);"></i>
                    <input type="text" placeholder="Buscar activo o estrategia..." id="dash-search-input"
                        class="w-full pl-11 pr-4 py-2.5 text-sm rounded-xl outline-none transition-all"
                        style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);"
                        oninput="dashboardSearch(this.value)" onfocus="this.style.borderColor='#C6FF34'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.06)'">
                </div>
                <button onclick=" showDashSettingsModal()" class="p-2.5 rounded-xl transition-all"
                    style="background: #121A23; border: 1px solid rgba(255,255,255,0.06);">
                    <i class="fa-solid fa-gear" style="color: rgba(255,255,255,0.58);"></i>
                </button>
            </div>

            <!-- Asset Returns Ticker Bar -->
            <div class="flex items-center gap-6 mb-5 p-3 rounded-xl overflow-x-auto" id="dash-price-ticker"
                style="background: linear-gradient(90deg, rgba(15,20,27,0.95) 0%, rgba(18,26,35,0.9) 100%); border: 1px solid rgba(255,255,255,0.04);">
                <span class="text-[11px] font-medium px-2 py-1 rounded"
                    style="background: rgba(198,255,52,0.12); color: #C6FF34;">Retorno Anual</span>
                <!-- BTC -->
                <div class="flex items-center gap-2 min-w-fit">
                    <span class="text-[13px] font-medium" style="color: #F7931A;">Bitcoin</span>
                    <span class="text-[14px] font-semibold px-2 py-0.5 rounded" id="ticker-btc-return"
                        style="background: rgba(34,197,94,0.14); color: #22C55E;">+15%/a침o</span>
                </div>
                <div class="w-px h-5" style="background: rgba(255,255,255,0.08);"></div>
                <!-- S&P -->
                <div class="flex items-center gap-2 min-w-fit">
                    <span class="text-[13px] font-medium" style="color: #10B981;">S&P 500</span>
                    <span class="text-[14px] font-semibold px-2 py-0.5 rounded" id="ticker-sp500-return"
                        style="background: rgba(34,197,94,0.14); color: #22C55E;">+9%/a침o</span>
                </div>
                <div class="w-px h-5" style="background: rgba(255,255,255,0.08);"></div>
                <!-- Fondo Liquidez -->
                <div class="flex items-center gap-2 min-w-fit">
                    <span class="text-[13px] font-medium" style="color: #3B82F6;">Fondo Liquidez</span>
                    <span class="text-[14px] font-semibold px-2 py-0.5 rounded" id="ticker-fondo-return"
                        style="background: rgba(34,197,94,0.14); color: #22C55E;">+8%/a침o</span>
                </div>
                <div class="w-px h-5" style="background: rgba(255,255,255,0.08);"></div>
                <!-- Oro -->
                <div class="flex items-center gap-2 min-w-fit">
                    <span class="text-[13px] font-medium" style="color: #FCD34D;">Oro</span>
                    <span class="text-[14px] font-semibold px-2 py-0.5 rounded" id="ticker-gold-return"
                        style="background: rgba(34,197,94,0.14); color: #22C55E;">+5%/a침o</span>
                </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- KPI 1: Patrimonio Total -->
                <div class="p-5 rounded-[14px] transition-all hover:shadow-xl"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[13px] font-medium tracking-wide"
                            style="color: rgba(255,255,255,0.58);">Patrimonio Total</span>
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                            style="background: rgba(185,242,10,0.14);">
                            <i class="fa-solid fa-wallet text-sm" style="color: #C6FF34;"></i>
                        </div>
                    </div>
                    <div class="text-[28px] font-semibold mb-2 cursor-pointer hover:text-[#C6FF34] transition-colors"
                        style="color: rgba(255,255,255,0.92); line-height: 1.15;" id="dash-patrimonio"
                        onclick="editPatrimonio()" title="Click para editar capital">$45,000.00</div>
                    <div class="flex items-center gap-2 text-[12px]" style="color: rgba(255,255,255,0.42);">
                        <i class="fa-solid fa-pencil"></i>
                        <span>Click para modificar</span>
                    </div>
                </div>

                <!-- KPI 2: Retorno Esperado -->
                <div class="p-5 rounded-[14px] transition-all hover:shadow-xl"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[13px] font-medium tracking-wide"
                            style="color: rgba(255,255,255,0.58);">Retorno Esperado (YTD)</span>
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                            style="background: rgba(34,197,94,0.14);">
                            <i class="fa-solid fa-arrow-trend-up text-sm" style="color: #22C55E;"></i>
                        </div>
                    </div>
                    <div class="text-[28px] font-semibold mb-2" style="color: #22C55E; line-height: 1.15;"
                        id="dash-retorno">+12.4%</div>
                    <div class="flex items-center gap-2 text-[12px]" style="color: rgba(255,255,255,0.42);">
                        <i class="fa-solid fa-circle-info"></i>
                        <span>Ajustado por inflaci칩n</span>
                    </div>
                </div>

                <!-- KPI 3: Liquidez Disponible -->
                <div class="p-5 rounded-[14px] transition-all hover:shadow-xl"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[13px] font-medium tracking-wide"
                            style="color: rgba(255,255,255,0.58);">Liquidez Disponible</span>
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                            style="background: rgba(59,130,246,0.14);">
                            <i class="fa-solid fa-money-bill-wave text-sm" style="color: #3B82F6;"></i>
                        </div>
                    </div>
                    <div class="text-[28px] font-semibold mb-2"
                        style="color: rgba(255,255,255,0.92); line-height: 1.15;" id="dash-volatilidad">$9,000.00
                    </div>
                    <div class="flex items-center gap-2 text-[12px]" style="color: rgba(255,255,255,0.42);">
                        <i class="fa-solid fa-landmark"></i>
                        <span>Fondo Rau / Letras</span>
                    </div>
                </div>
            </div>

            <!-- Strategy Selector (above allocation for better UX) -->
            <div class="p-4 rounded-[14px] mb-6"
                style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-lg" style="color: #C6FF34;"></i>
                        <span class="text-[14px] font-medium" style="color: rgba(255,255,255,0.80);">Estrategia
                            Activa</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="setDashMode('normal')" id="dash-mode-normal"
                            class="dash-mode-btn px-4 py-2 text-[12px] font-medium rounded-xl transition-all"
                            style="background: #182231; color: rgba(255,255,255,0.92);">
                            游띠勇 Normie
                        </button>
                        <button onclick="setDashMode('sovereign')" id="dash-mode-sovereign"
                            class="dash-mode-btn px-4 py-2 text-[12px] font-medium rounded-xl transition-all"
                            style="background: transparent; color: rgba(255,255,255,0.58);">
                            丘 Soberano
                        </button>
                        <button onclick="setDashMode('custom')" id="dash-mode-custom"
                            class="dash-mode-btn px-4 py-2 text-[12px] font-medium rounded-xl transition-all"
                            style="background: transparent; color: rgba(255,255,255,0.58);">
                            游꿛 Personalizado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Middle Row: Allocation + Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">

                <!-- Left: Asignaci칩n de Activos -->
                <div class="lg:col-span-5 p-5 rounded-[14px]"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-[13px] font-medium tracking-wide"
                            style="color: rgba(255,255,255,0.58);">Asignaci칩n de Activos</span>
                    </div>

                    <!-- Total Value -->
                    <div class="mb-4">
                        <div class="text-[13px] mb-1" style="color: rgba(255,255,255,0.42);">Distribuci칩n
                            Inteligente
                        </div>
                        <div class="text-[22px] font-semibold" style="color: rgba(255,255,255,0.92);"
                            id="dash-alloc-total">$45,000.00</div>
                    </div>

                    <!-- Asset Bars -->
                    <div id="dash-asset-list" class="space-y-4">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Credit Card Visual -->
                    <div class="mt-5 p-4 rounded-2xl relative overflow-hidden"
                        style="background: linear-gradient(135deg, #0A0C0F 0%, #182231 50%, rgba(185,242,10,0.15) 100%); border: 1px solid rgba(255,255,255,0.08);">
                        <div class="flex justify-between items-start mb-8">
                            <span class="text-[11px] font-bold tracking-widest px-2 py-1 rounded"
                                style="background: rgba(185,242,10,0.20); color: #C6FF34;">PREMIUM</span>
                            <i class="fa-solid fa-seedling text-xl" style="color: #C6FF34;"></i>
                        </div>
                        <div class="text-[18px] font-semibold tracking-wider mb-4"
                            style="color: rgba(255,255,255,0.80); letter-spacing: 2px;">뮉뮉뮉 뮉뮉뮉 뮉뮉뮉 2030</div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="text-[10px] uppercase tracking-wider mb-1"
                                    style="color: rgba(255,255,255,0.42);">Miembro</div>
                                <div class="text-[13px] font-medium" style="color: rgba(255,255,255,0.80);">Plan
                                    Semilla
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] uppercase tracking-wider mb-1"
                                    style="color: rgba(255,255,255,0.42);">Estrategia</div>
                                <div class="text-[13px] font-medium" style="color: #C6FF34;" id="dash-mode-badge">
                                    Modo
                                    Soberano</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Evoluci칩n del Portafolio -->
                <div class="lg:col-span-7 p-5 rounded-[14px]"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                        <div>
                            <span class="text-[13px] font-medium tracking-wide"
                                style="color: rgba(255,255,255,0.58);">Evoluci칩n del Portafolio</span>
                            <div class="text-[22px] font-semibold mt-1" style="color: rgba(255,255,255,0.92);"
                                id="dash-balance-total">$45,000.00</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="setMode('simulador')"
                                class="px-3 py-1.5 text-[12px] font-medium rounded-lg flex items-center gap-1.5 transition-all"
                                style="background: rgba(185,242,10,0.14); color: #C6FF34; border: 1px solid rgba(185,242,10,0.30);">
                                <i class="fa-solid fa-plus"></i> Aportar
                            </button>
                            <button onclick="setMode('rebalance')"
                                class="px-3 py-1.5 text-[12px] font-medium rounded-lg flex items-center gap-1.5 transition-all"
                                style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">
                                <i class="fa-solid fa-scale-balanced"></i> Rebalancear
                            </button>
                            <button onclick="showDashContextMenu(this)" class="p-1.5 rounded-lg"
                                style="background: #121A23; border: 1px solid rgba(255,255,255,0.06);">
                                <i class="fa-solid fa-ellipsis-vertical" style="color: rgba(255,255,255,0.58);"></i>
                            </button>
                        </div>
                    </div>

                    <!-- View Toggle -->
                    <div class="inline-flex rounded-full p-1 mb-4"
                        style="background: #121A23; border: 1px solid rgba(255,255,255,0.06);">
                        <button id="dash-view-bars" onclick="setDashChartView('bars')"
                            class="px-4 py-1.5 text-[12px] font-medium rounded-full transition-all"
                            style="background: #182231; color: rgba(255,255,255,0.92);">
                            Vista Barras
                        </button>
                        <button id="dash-view-line" onclick="setDashChartView('line')"
                            class="px-4 py-1.5 text-[12px] font-medium rounded-full transition-all"
                            style="background: transparent; color: rgba(255,255,255,0.58);">
                            Vista L칤nea
                        </button>
                        <span class="px-3 py-1.5 text-[11px]" style="color: rgba(255,255,255,0.42);">Mostrando 1-1
                            de 1
                            movimientos</span>
                    </div>

                    <!-- Chart Container -->
                    <div class="h-[200px] relative">
                        <canvas id="dash-projection-chart"></canvas>
                    </div>

                    <!-- Footer with Projection Summary + Time Range Buttons -->
                    <div class="flex items-center justify-between mt-3 flex-wrap gap-2">
                        <div class="flex items-center gap-2 text-[12px]" style="color: rgba(255,255,255,0.42);">
                            <i class="fa-solid fa-chart-line"></i>
                            <span id="dash-projection-summary">Calculando proyecci칩n...</span>
                        </div>
                        <!-- Time Range Filter (next to chart) -->
                        <div class="flex items-center gap-1">
                            <button onclick="setDashTimeRange('1M')"
                                class="dash-time-btn px-2 py-1 text-[10px] font-medium rounded-lg transition-all"
                                style="background: #182231; color: rgba(255,255,255,0.92);" data-range="1M">1M</button>
                            <button onclick="setDashTimeRange('3M')"
                                class="dash-time-btn px-2 py-1 text-[10px] font-medium rounded-lg transition-all"
                                style="background: transparent; color: rgba(255,255,255,0.58);"
                                data-range="3M">3M</button>
                            <button onclick="setDashTimeRange('6M')"
                                class="dash-time-btn px-2 py-1 text-[10px] font-medium rounded-lg transition-all"
                                style="background: transparent; color: rgba(255,255,255,0.58);"
                                data-range="6M">6M</button>
                            <button onclick="setDashTimeRange('1A')"
                                class="dash-time-btn px-2 py-1 text-[10px] font-medium rounded-lg transition-all"
                                style="background: transparent; color: rgba(255,255,255,0.58);"
                                data-range="1A">1A</button>
                            <button onclick="setDashTimeRange('YTD')"
                                class="dash-time-btn px-2 py-1 text-[10px] font-medium rounded-lg transition-all"
                                style="background: transparent; color: rgba(255,255,255,0.58);"
                                data-range="YTD">YTD</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Insights & Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Monthly Summary (replaces S&P benchmark) -->
                <div class="p-5 rounded-[14px] transition-all hover:shadow-xl"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[13px] font-medium tracking-wide"
                            style="color: rgba(255,255,255,0.58);">Resumen del Mes</span>
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                            style="background: rgba(59,130,246,0.14);">
                            <i class="fa-solid fa-calendar-check text-sm" style="color: #3B82F6;"></i>
                        </div>
                    </div>
                    <div id="dash-monthly-summary" class="space-y-2">
                        <div class="flex items-center justify-between text-[13px]">
                            <span style="color: rgba(255,255,255,0.70);">Aportaci칩n mensual</span>
                            <button onclick="toggleMonthlyContribution()" id="dash-contrib-status"
                                class="px-2 py-0.5 rounded text-[11px] font-medium cursor-pointer transition-all hover:scale-105"
                                style="background: rgba(251,191,36,0.14); color: #FBBF24;">Pendiente</button>
                        </div>
                        <div class="flex items-center justify-between text-[13px]">
                            <span style="color: rgba(255,255,255,0.70);">Health Score</span>
                            <div class="flex items-center gap-1">
                                <span id="dash-health-score" class="font-semibold" style="color: #22C55E;">85</span>
                                <span style="color: rgba(255,255,255,0.42);">/100</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-[13px]">
                            <span style="color: rgba(255,255,255,0.70);">Retorno YTD</span>
                            <span id="dash-ytd-return" style="color: #22C55E;">+0.0%</span>
                        </div>
                    </div>
                </div>

                <!-- Saved Portfolios -->
                <div class="p-5 rounded-[14px] transition-all hover:shadow-xl cursor-pointer"
                    onclick="setMode('portfolios')"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[13px] font-medium tracking-wide"
                            style="color: rgba(255,255,255,0.58);">Portfolios Guardados</span>
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                            style="background: rgba(168,85,247,0.14);">
                            <i class="fa-solid fa-folder text-sm" style="color: #A855F7;"></i>
                        </div>
                    </div>
                    <div id="dash-portfolios-count" class="text-[28px] font-semibold"
                        style="color: rgba(255,255,255,0.92);">0</div>
                    <div class="text-[12px] mt-1" style="color: rgba(255,255,255,0.42);">
                        <i class="fa-solid fa-arrow-right mr-1"></i> Click para ver todos
                    </div>
                </div>

                <!-- Editable Checklist -->
                <div class="p-5 rounded-[14px] transition-all hover:shadow-xl"
                    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[13px] font-medium tracking-wide" style="color: rgba(255,255,255,0.58);">Mi
                            Checklist</span>
                        <button onclick="addChecklistItem()"
                            class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:scale-110"
                            style="background: rgba(198,255,52,0.14);">
                            <i class="fa-solid fa-plus text-sm" style="color: #C6FF34;"></i>
                        </button>
                    </div>
                    <div id="dash-checklist" class="space-y-2 max-h-[120px] overflow-y-auto">
                        <!-- Items loaded from localStorage -->
                    </div>
                </div>
            </div>

            <!-- Allocation Table -->
            <div class="p-5 rounded-[14px]"
                style="background: #0F141B; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35);">
                <div class="text-[13px] font-medium mb-4" style="color: rgba(255,255,255,0.42);">Detalle de Activos
                </div>

                <!-- Toolbar -->
                <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-[12px]"
                                style="color: rgba(255,255,255,0.42);"></i>
                            <input type="text" placeholder="Buscar transacci칩n..."
                                class="pl-9 pr-4 py-2 text-[13px] rounded-xl w-[240px]"
                                style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">
                        </div>
                        <button onclick="showDateFilterDropdown(this)"
                            class="px-3 py-2 text-[12px] font-medium rounded-xl flex items-center gap-2"
                            style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">
                            <i class="fa-solid fa-calendar"></i> Fecha <i
                                class="fa-solid fa-chevron-down text-[10px]"></i>
                        </button>
                    </div>
                    <button onclick="showImportModal()"
                        class="px-3 py-2 text-[12px] font-medium rounded-xl flex items-center gap-2"
                        style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">
                        <i class="fa-solid fa-file-import"></i> Importar
                    </button>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                                <th class="text-left py-3 px-4 text-[12px] font-semibold"
                                    style="color: rgba(255,255,255,0.58);">ACTIVO</th>
                                <th class="text-left py-3 px-4 text-[12px] font-semibold"
                                    style="color: rgba(255,255,255,0.58);">OPERACI칍N</th>
                                <th class="text-right py-3 px-4 text-[12px] font-semibold"
                                    style="color: rgba(255,255,255,0.58);">MONTO</th>
                                <th class="text-center py-3 px-4 text-[12px] font-semibold"
                                    style="color: rgba(255,255,255,0.58);">ESTADO</th>
                                <th class="text-right py-3 px-4 text-[12px] font-semibold"
                                    style="color: rgba(255,255,255,0.58);">FECHA</th>
                            </tr>
                        </thead>
                        <tbody id="dash-allocation-table">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-4 pt-4"
                    style="border-top: 1px solid rgba(255,255,255,0.06);">
                    <span class="text-[12px]" style="color: rgba(255,255,255,0.42);">Mostrando 1-5 de 24
                        movimientos</span>
                    <div class="flex items-center gap-1">
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center text-[12px]"
                            style="background: #121A23; color: rgba(255,255,255,0.58); border: 1px solid rgba(255,255,255,0.06);"><i
                                class="fa-solid fa-chevron-left"></i></button>
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center text-[12px] font-medium"
                            style="background: #C6FF34; color: #0B0F14;">1</button>
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center text-[12px]"
                            style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">2</button>
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center text-[12px]"
                            style="background: #121A23; color: rgba(255,255,255,0.80); border: 1px solid rgba(255,255,255,0.06);">3</button>
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center text-[12px]"
                            style="background: #121A23; color: rgba(255,255,255,0.58); border: 1px solid rgba(255,255,255,0.06);"><i
                                class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-6 py-4">
                <span class="text-[12px]" style="color: rgba(255,255,255,0.42);">Plan Semilla 춸 2026  Tu camino
                    hacia
                    la libertad financiera 游꺔</span>
            </div>
        </div>
    </div>

    <!-- Rest of content in separate main -->
    <main id="main-secondary-content"
        class="w-full md:max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12 space-y-10 sm:space-y-20">
        <!-- SECTION 3: AI ADVISOR -->



        <section id="ai-advisor" class="scroll-mt-24">
            <div id="ai-container"
                class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl shadow-xl overflow-hidden text-white transition-all duration-500 flex flex-col h-[600px] max-h-[85vh]">
                <div
                    class="p-4 border-b border-white/10 flex justify-between items-center gap-4 bg-black/10 backdrop-blur-sm flex-shrink-0">
                    <div>
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <i class="fa-solid fa-brain"></i> <span id="ai-title">Experto Financiero</span>
                        </h2>
                        <p id="ai-subtitle" class="text-indigo-100 text-xs opacity-90 hidden sm:block">
                            Consulta sobre The Great Reset, Graham, Bitcoin y m치s.
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="clearChatHistory()"
                            class="p-2 bg-white/20 hover:bg-red-500/50 rounded-lg transition"
                            title="Borrar historial del chat">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <button onclick="toggleExpandChat()"
                            class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition" title="Pantalla Completa">
                            <i class="fa-solid fa-expand" id="expand-icon"></i>
                        </button>
                    </div>
                </div>
                <div
                    class="flex flex-col lg:flex-row flex-grow overflow-hidden bg-white text-slate-800 transition-colors duration-500 inner-ai-bg">
                    <div
                        class="hidden lg:flex lg:w-1/4 flex-col p-4 border-r border-slate-200 transition-colors duration-500 inner-border overflow-y-auto bg-slate-50">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Acciones R치pidas
                        </h3>
                        <div id="prompt-buttons" class="space-y-2"></div>
                    </div>
                    <div id="chat-area-wrapper" class="w-full lg:w-3/4 flex flex-col h-full relative">
                        <div id="chat-history"
                            class="flex-grow p-4 overflow-y-auto space-y-4 bg-slate-50/50 transition-colors duration-500 inner-chat-bg">
                            <div class="flex flex-col items-start chat-bubble chat-ai shadow-sm">
                                <div class="font-bold text-xs text-purple-600 mb-1 flex items-center gap-1"><i
                                        class="fa-solid fa-robot"></i> Gemini</div>
                                <span id="welcome-msg">Hola. He le칤do tu biblioteca financiera. 쮿ablamos de c칩mo
                                    proteger tu capital?</span>
                            </div>
                        </div>
                        <div
                            class="p-3 border-t border-slate-100 transition-colors duration-500 inner-border bg-white inner-input-bg flex-shrink-0 z-20">
                            <div class="relative flex items-start gap-2">
                                <textarea id="user-input" placeholder="Escribe tu consulta..." rows="1"
                                    class="w-full p-2.5 pr-10 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent shadow-sm text-sm transition-colors duration-500 input-field resize-none overflow-hidden"
                                    style="min-height: 42px; max-height: 200px;" onkeydown="handleEnter(event)"
                                    oninput="autoResizeTextarea(this)"></textarea>
                                <button onclick="askGemini()"
                                    class="absolute right-2 p-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition shadow-sm flex items-center justify-center w-8 h-8">
                                    <i class="fa-solid fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                            <p class="text-[10px] text-center mt-1 opacity-40 hidden sm:block pt-1">
                                Shift+Enter para nueva l칤nea  Enter para enviar
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 4: CHECKLIST ACTION -->
        <section class="max-w-3xl mx-auto pb-12">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">Pasos Inmediatos</h2>
            <div
                class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-colors duration-500 card">
                <div id="checklist-container"
                    class="divide-y divide-slate-100 transition-colors duration-500 inner-divide"></div>
            </div>
        </section>

        <!-- SECTION 5: TOOLS (Export/Import) -->
        <section class="max-w-3xl mx-auto pb-12">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">Herramientas</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onclick="exportPortfolio()"
                    class="card p-4 flex items-center justify-center gap-3 bg-white hover:bg-slate-50 border border-slate-200 rounded-xl transition-all hover:shadow-md">
                    <i class="fa-solid fa-download text-blue-500 text-xl"></i>
                    <div class="text-left">
                        <div class="font-bold text-slate-700">Exportar Portfolio</div>
                        <div class="text-xs text-slate-400">Guardar como archivo JSON</div>
                    </div>
                </button>
                <label
                    class="card p-4 flex items-center justify-center gap-3 bg-white hover:bg-slate-50 border border-slate-200 rounded-xl transition-all hover:shadow-md cursor-pointer">
                    <i class="fa-solid fa-upload text-green-500 text-xl"></i>
                    <div class="text-left">
                        <div class="font-bold text-slate-700">Importar Portfolio</div>
                        <div class="text-xs text-slate-400">Cargar desde archivo JSON</div>
                    </div>
                    <input type="file" id="import-input" accept=".json" onchange="importPortfolio(event)"
                        class="hidden">
                </label>
            </div>
            <button onclick="resetAllData()"
                class="mt-4 w-full text-center text-sm text-red-400 hover:text-red-600 transition">
                <i class="fa-solid fa-rotate-left mr-1"></i> Reiniciar todos los datos guardados
            </button>
            <p class="text-center text-xs text-slate-400 mt-3">
                <i class="fa-solid fa-circle-info"></i> Tus datos se guardan autom치ticamente en el navegador.
            </p>
        </section>

        <!-- SECTION 6: TRANSACTIONS (Only when backend is available) -->
        <section id="transactions-section" class="max-w-3xl mx-auto pb-12 hidden">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">
                <i class="fa-solid fa-receipt text-emerald-500"></i> Registro de Inversiones
            </h2>

            <!-- Backend Status -->
            <div id="backend-status" class="mb-4 p-3 rounded-lg text-center text-sm">
                <i class="fa-solid fa-server"></i>
                <span id="backend-status-text">Verificando conexi칩n...</span>
            </div>

            <!-- Add Transaction Form -->
            <div class="card p-6 bg-white border border-slate-200 rounded-xl mb-6">
                <h3 class="font-bold text-slate-700 mb-4">Nueva Transacci칩n</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Activo</label>
                        <select id="txn-asset" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <option value="S&P 500">S&P 500</option>
                            <option value="Bitcoin">Bitcoin</option>
                            <option value="Fondo Liquidez">Fondo Liquidez</option>
                            <option value="Oro">Oro</option>
                            <option value="Bonos UI">Bonos UI</option>
                            <option value="Nasdaq 100">Nasdaq 100</option>
                            <option value="Bonos USA">Bonos USA</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Tipo</label>
                        <select id="txn-type" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <option value="buy">Compra</option>
                            <option value="sell">Venta</option>
                            <option value="contribution">Aporte</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Monto (UYU)</label>
                        <input type="number" id="txn-amount" placeholder="10000"
                            class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Fecha</label>
                        <input type="date" id="txn-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Notas (opcional)</label>
                        <input type="text" id="txn-notes" placeholder="Ej: Compra mensual VOO"
                            class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                </div>
                <button onclick="addTransaction()"
                    class="mt-4 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 rounded-lg transition shadow">
                    <i class="fa-solid fa-plus mr-2"></i>Registrar Transacci칩n
                </button>
            </div>

            <!-- Transaction History -->
            <div class="card p-6 bg-white border border-slate-200 rounded-xl">
                <h3 class="font-bold text-slate-700 mb-4">Historial</h3>
                <div id="transactions-list" class="space-y-2">
                    <p class="text-center text-slate-400 text-sm py-4">
                        <i class="fa-solid fa-inbox"></i> No hay transacciones registradas
                    </p>
                </div>
            </div>
        </section>

    </main>

    <script src="historical_data.js"></script>
    <script>
        // --- 1. GLOBAL CONFIG ---

        // =========================================================================
        // CONFIGURACI칍N DEL BACKEND
        // Si el backend est치 corriendo, las llamadas a Gemini ser치n seguras
        // =========================================================================
        const API_BASE_URL = 'http://localhost:5000/api';
        let useBackend = false; // Se detecta autom치ticamente

        // =========================================================================
        // 丘멆잺 FALLBACK: API Key (solo si el backend no est치 disponible)
        // =========================================================================
        let apiKey = "AIzaSyDRy7_Jsz4BOGTRSbDz2hUoPzlUWHJfNew";

        let currentMode = 'normal';
        let currentCapital = 45000;
        let isChatExpanded = false;
        let customAssets = [];

        // Asset Metadata (Color & Estimated Return for Projection)
        const assetMeta = {
            // --- INDICES PRINCIPALES ---
            "S&P 500": { color: '#10B981', ret: 9, vol: 15 },
            "Nasdaq 100": { color: '#8B5CF6', ret: 12, vol: 20 },
            "Total World (VT)": { color: '#3B82F6', ret: 7.5, vol: 14 }, // Nuevo: Exposici칩n Global
            // --- CRIPTO ---
            "Bitcoin": { color: '#F59E0B', ret: 15, vol: 70 },
            "Ethereum": { color: '#6366F1', ret: 14, vol: 80 }, // Agregado por consistencia
            "Solana": { color: '#14F195', ret: 16, vol: 100 }, // Agregado por consistencia
            // --- SECTORES & FACTORES ---
            "Semiconductores (SMH)": { color: '#06B6D4', ret: 14, vol: 35 }, // Nuevo: La apuesta IA
            "Dividendos (SCHD)": { color: '#059669', ret: 8, vol: 12 }, // Nuevo: Defensivo/Income
            "Real Estate (VNQ)": { color: '#D946EF', ret: 8.5, vol: 18 }, // Nuevo: Inmuebles
            "Emergentes (VWO)": { color: '#F97316', ret: 8, vol: 22 }, // Nuevo: China/India
            // --- RENTA FIJA & LOCAL ---
            "Fondo Liquidez UYU": { color: '#3B82F6', ret: 8, vol: 5 },
            "Bonos UI Uruguay": { color: '#6366F1', ret: 10, vol: 8 },
            "Bonos USA (TLT)": { color: '#94A3B8', ret: 4, vol: 10 }, // Ajustado volatilidad TLT (es alta)
            // --- COMMODITIES ---
            "Oro": { color: '#FCD34D', ret: 5, vol: 15 },
            "Plata": { color: '#9CA3AF', ret: 6, vol: 25 }, // Nuevo: Metal industrial
            // --- CASH ---
            "Efectivo": { color: '#64748B', ret: 0, vol: 0 }
        };

        const vibrantColors = [
            '#3B82F6', // Blue
            '#10B981', // Emerald
            '#F59E0B', // Amber
            '#EF4444', // Red
            '#8B5CF6', // Violet
            '#EC4899', // Pink
            '#06B6D4', // Cyan
            '#F97316', // Orange
            '#6366F1', // Indigo
            '#84CC16', // Lime
            '#14B8A6', // Teal
            '#D946EF'  // Fuchsia
        ];

        function getAssetColor(name, index = 0) {
            // 1. Check if it has a predefined color in assetMeta
            if (assetMeta[name] && assetMeta[name].color) {
                return assetMeta[name].color;
            }

            // 2. Assign a vibrant color based on index or name hash
            // Simple hash function for consistent colors for same name
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colorIndex = Math.abs(hash) % vibrantColors.length;

            return vibrantColors[colorIndex];
        }

        // ===== MOBILE MENU TOGGLE =====
        function toggleMobileMenu() {
            const dropdown = document.getElementById('mobile-menu-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function (e) {
            const mobileMenu = document.getElementById('mobile-menu-dropdown');
            const mobileBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                if (!mobileMenu.contains(e.target) && !mobileBtn.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            }
        });

        // ===== GLOBAL THEME SYSTEM =====
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }

            updateThemeIcon();

            // Also update sovereign mode class for compatibility
            document.body.classList.remove('sovereign-mode');
        }

        function applyTheme(theme) {
            const html = document.documentElement;

            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            updateThemeIcon();
            applyDashboardTheme(theme);

            // Remove legacy sovereign mode
            document.body.classList.remove('sovereign-mode');
        }

        // Apply theme specifically to Dashboard elements with inline styles
        function applyDashboardTheme(theme) {
            const dashboard = document.getElementById('dashboard-wrapper');
            if (!dashboard) return;

            const isDark = theme === 'dark';

            // Define color mappings for light mode
            const lightBg = '#ffffff';
            const lightText = '#1e293b';
            const lightBorder = '#e2e8f0';
            const darkWrapperBg = '#0B0F14';
            const lightWrapperBg = '#f8fafc';

            // Update dashboard wrapper background
            dashboard.style.backgroundColor = isDark ? darkWrapperBg : lightWrapperBg;

            // Update all rounded cards - save original styles first
            const cards = dashboard.querySelectorAll('.rounded-xl, .rounded-2xl, .rounded-3xl');
            cards.forEach(card => {
                if (isDark) {
                    // Restore original dark styles
                    if (card.dataset.origBg) {
                        card.style.background = card.dataset.origBg;
                        card.style.borderColor = card.dataset.origBorder || '';
                        card.style.boxShadow = card.dataset.origShadow || '';
                    } else {
                        // No saved original, just clear inline styles (let CSS take over)
                        card.style.background = '';
                        card.style.borderColor = '';
                        card.style.boxShadow = '';
                    }
                } else {
                    // Save original dark styles before applying light
                    const currentBg = card.style.background || window.getComputedStyle(card).background;
                    if (!card.dataset.origBg && currentBg && !currentBg.includes('rgb(255, 255, 255)')) {
                        card.dataset.origBg = currentBg;
                        card.dataset.origBorder = card.style.borderColor || '';
                        card.dataset.origShadow = card.style.boxShadow || '';
                    }
                    // Apply light mode
                    card.style.background = lightBg;
                    card.style.borderColor = lightBorder;
                    card.style.boxShadow = '0 1px 3px 0 rgba(0, 0, 0, 0.1)';
                }
            });

            // Handle elements with inline style backgrounds
            const styledElements = dashboard.querySelectorAll('[style*="background"]');
            styledElements.forEach(el => {
                if (isDark) {
                    if (el.dataset.origBg) {
                        el.style.background = el.dataset.origBg;
                        if (el.dataset.origBorderColor) el.style.borderColor = el.dataset.origBorderColor;
                    }
                } else {
                    const style = el.getAttribute('style') || '';
                    if (style.includes('#121A23') || style.includes('rgba(15,20,27') || style.includes('rgba(18,26,35')) {
                        if (!el.dataset.origBg) {
                            el.dataset.origBg = el.style.background || el.style.backgroundColor;
                            el.dataset.origBorderColor = el.style.borderColor || '';
                        }
                        el.style.background = lightBg;
                        el.style.borderColor = lightBorder;
                    }
                }
            });

            // Update text elements with inline styles
            const textElements = dashboard.querySelectorAll('span, p, h1, h2, h3, h4, h5, label, td, th, div');
            textElements.forEach(el => {
                const style = el.getAttribute('style') || '';
                if (style.includes('color:')) {
                    if (isDark) {
                        if (el.dataset.origTextColor) {
                            el.style.color = el.dataset.origTextColor;
                        }
                    } else {
                        if (!el.dataset.origTextColor && (style.includes('rgba(255') || style.includes('rgb(255'))) {
                            el.dataset.origTextColor = el.style.color;
                            // Don't change accent colors
                            if (!el.className.includes('text-green') && !el.className.includes('text-red') &&
                                !el.className.includes('text-blue') && !el.className.includes('text-amber')) {
                                el.style.color = lightText;
                            }
                        }
                    }
                }
            });

            // Update inputs
            const inputs = dashboard.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (isDark) {
                    if (input.dataset.origInputBg) {
                        input.style.background = input.dataset.origInputBg;
                        input.style.color = input.dataset.origInputColor || '';
                        input.style.borderColor = input.dataset.origInputBorder || '';
                    } else {
                        input.style.background = '';
                        input.style.color = '';
                        input.style.borderColor = '';
                    }
                } else {
                    if (!input.dataset.origInputBg) {
                        input.dataset.origInputBg = input.style.background || window.getComputedStyle(input).background;
                        input.dataset.origInputColor = input.style.color || '';
                        input.dataset.origInputBorder = input.style.borderColor || '';
                    }
                    input.style.background = lightBg;
                    input.style.color = lightText;
                    input.style.borderColor = '#d1d5db';
                }
            });

            // Update buttons (not gradient ones)
            const buttons = dashboard.querySelectorAll('button');
            buttons.forEach(btn => {
                if (!btn.className.includes('from-') && !btn.className.includes('bg-gradient')) {
                    if (isDark) {
                        if (btn.dataset.origBtnBg) {
                            btn.style.background = btn.dataset.origBtnBg;
                            btn.style.color = btn.dataset.origBtnColor || '';
                            btn.style.borderColor = btn.dataset.origBtnBorder || '';
                        } else {
                            btn.style.background = '';
                            btn.style.color = '';
                            btn.style.borderColor = '';
                        }
                    } else {
                        if (!btn.dataset.origBtnBg) {
                            btn.dataset.origBtnBg = btn.style.background || window.getComputedStyle(btn).background;
                            btn.dataset.origBtnColor = btn.style.color || '';
                            btn.dataset.origBtnBorder = btn.style.borderColor || '';
                        }
                        btn.style.background = '#f1f5f9';
                        btn.style.color = '#475569';
                        btn.style.borderColor = lightBorder;
                    }
                }
            });
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            const btn = document.getElementById('theme-toggle-btn');
            const isDark = document.documentElement.classList.contains('dark');

            if (icon) {
                if (isDark) {
                    icon.className = 'fa-solid fa-sun text-sm text-amber-400';
                    if (btn) {
                        btn.className = 'flex items-center justify-center w-9 h-9 rounded-full bg-slate-700 hover:bg-slate-600 text-amber-400 transition-all duration-300 shadow-sm border border-slate-600';
                    }
                } else {
                    icon.className = 'fa-solid fa-moon text-sm';
                    if (btn) {
                        btn.className = 'flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 transition-all duration-300 shadow-sm border border-slate-200';
                    }
                }
            }
        }

        function initTheme() {
            // Check localStorage first
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // Check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        // Initialize theme on page load
        initTheme();
        // ===== END THEME SYSTEM =====

        const config = {
            normal: {
                heroTitle: 'Crecimiento Equilibrado',
                heroDesc: 'Estrategia cl치sica basada en "Stocks for the Long Run". Maximiza inter칠s compuesto.',
                heroTarget: 'Inter칠s Compuesto',
                allocDesc: 'Cartera 60/40 optimizada seg칰n Graham y Bogle.',
                strategy: [
                    '游늳 <strong>Motor (60%):</strong> S&P 500 (VOO). Cobertura contra inflaci칩n a largo plazo.',
                    '游띠勇 <strong>Defensa (40%):</strong> Pesos Uruguayos (Fondo Liquidez). Estabilidad local.',
                    '游눠 <strong>Filosof칤a:</strong> "Time in the market beats timing the market".'
                ],
                assets: [
                    { name: 'S&P 500', ratio: 0.60, color: assetMeta["S&P 500"].color },
                    { name: 'Fondo Liquidez', ratio: 0.40, color: assetMeta["Fondo Liquidez UYU"].color }
                ],
                prompts: [
                    { title: '游늵 An치lisis Graham', q: '쯈u칠 dir칤a Benjamin Graham de esta distribuci칩n 60/40?' },
                    { title: '游쥟릖 Riesgo S&P 500', q: '쯈u칠 pasa con mi inversi칩n si hay recesi칩n en EE.UU.?' },
                    { title: '游눯 Inter칠s Compuesto', q: 'Proyecta mi crecimiento en 10 a침os.' }
                ],
                checklist: [
                    'Abrir cuenta en Ita칰 / Gletir.',
                    'Suscribir Fondo Liquidez Pesos.',
                    'Abrir cuenta eToro (u opci칩n low-cost).',
                    'Comprar VOO (S&P 500) con el resto.'
                ],
                welcome: 'Hola. Soy tu asistente financiero cl치sico. Veo un plan s칩lido. 쮼n qu칠 puedo ayudarte?'
            },
            sovereign: {
                heroTitle: 'Protocolo Fortaleza',
                heroDesc: 'Estrategia "Barbell" (Taleb) para resistir el Great Reset y CBDCs.',
                heroTarget: 'Soberan칤a Total',
                allocDesc: 'Cartera Asim칠trica: Soberan칤a incensurable + Crecimiento agresivo.',
                strategy: [
                    '游댏 <strong>Soberan칤a (35%):</strong> Bitcoin en Auto-custodia. Seguro contra confiscaci칩n.',
                    '游 <strong>Narrativa (45%):</strong> S&P 500 / Tech. Captura de inflaci칩n de activos.',
                    '游쥟릖 <strong>Operativo (20%):</strong> Pesos locales para gastos diarios.'
                ],
                assets: [
                    { name: 'Bitcoin', ratio: 0.35, color: assetMeta["Bitcoin"].color },
                    { name: 'S&P 500', ratio: 0.45, color: assetMeta["S&P 500"].color },
                    { name: 'Fondo Liquidez', ratio: 0.20, color: assetMeta["Fondo Liquidez UYU"].color }
                ],
                prompts: [
                    { title: '游녜勇 Riesgo Agenda 2030', q: 'Analiza c칩mo las CBDC podr칤an afectar mis ahorros y por qu칠 Bitcoin protege.' },
                    { title: '游늴 Colapso Fiat', q: 'Explica la teor칤a de "The Lords of Easy Money".' },
                    { title: '游댏 Auto-Custodia', q: '쮺칩mo saco mis Bitcoin del exchange a una wallet segura?' }
                ],
                checklist: [
                    'Comprar Bitcoin (Binance/P2P).',
                    '<strong>CR칈TICO:</strong> Mover BTC a Wallet Privada.',
                    'Mantener S&P 500 en broker para crecimiento.',
                    'Liquidez m칤nima en banco.'
                ],
                welcome: 'Atenci칩n: Modo Soberano activado. Priorizo privacidad y activos duros seg칰n tus fuentes.'
            },
            custom: {
                heroTitle: 'Tu Dise침o Personalizado',
                heroDesc: 'Modo manual. T칰 decides la asignaci칩n. Verifica tus decisiones con la IA.',
                heroTarget: 'A Medida',
                allocDesc: 'Asignaci칩n definida por el usuario.',
                strategy: ['Define tu propia l칩gica de inversi칩n.', 'Balancea riesgo y retorno a tu gusto.', 'Consulta al experto para validar.'],
                checklist: ['Definir activos y porcentajes.', 'Validar con bot칩n de Auditor칤a IA.', 'Ejecutar compras en broker elegido.'],
                assets: [],
                prompts: [], // Dynamic
                welcome: 'Modo Constructor activado. A침ade activos a la izquierda y audita tu cartera.'
            }
        };

        // --- 2. CUSTOM MODE LOGIC ---

        function addCustomAsset() {
            const name = document.getElementById('customAssetSelect').value;
            const pct = parseFloat(document.getElementById('customAssetPct').value);

            if (!pct || pct <= 0) return alert("Ingresa un porcentaje v치lido");

            const currentTotal = customAssets.reduce((sum, a) => sum + a.ratio * 100, 0);
            if (currentTotal + pct > 100) return alert(`춰Te pasas! Solo queda ${100 - currentTotal}% disponible.`);

            const existing = customAssets.find(a => a.name === name);
            if (existing) {
                existing.ratio += pct / 100;
            } else {
                customAssets.push({
                    name: name,
                    ratio: pct / 100,
                    color: getAssetColor(name, customAssets.length)
                });
            }

            document.getElementById('customAssetPct').value = '';
            renderCustomBuilder();
            updateDashboard();
        }

        function removeCustomAsset(name) {
            customAssets = customAssets.filter(a => a.name !== name);
            renderCustomBuilder();
            updateDashboard();
        }

        function renderCustomBuilder() {
            const list = document.getElementById('custom-asset-list');
            list.innerHTML = '';
            let total = 0;

            customAssets.forEach(asset => {
                total += asset.ratio * 100;
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-white p-2 rounded border border-slate-100 shadow-sm";
                li.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${asset.color}"></div>
                        <span>${asset.name}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-slate-600">${(asset.ratio * 100).toFixed(0)}%</span>
                        <button onclick="removeCustomAsset('${asset.name}')" class="text-red-400 hover:text-red-600">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });

            if (customAssets.length === 0) list.innerHTML = `<li class="text-slate-400 italic text-xs text-center py-4">A침ade activos arriba...</li>`;

            document.getElementById('custom-total-pct').innerText = total.toFixed(0) + '%';
            const bar = document.getElementById('custom-progress-bar');
            bar.style.width = total + '%';
            bar.className = `h-full transition-all ${total > 100 ? 'bg-red-500' : (total === 100 ? 'bg-green-500' : 'bg-blue-500')}`;

            const warning = document.getElementById('custom-warning');
            if (total !== 100) {
                warning.classList.remove('hidden');
                warning.innerText = total < 100 ? `Falta ${100 - total}%` : `Te pasas por ${total - 100}%`;
            } else {
                warning.classList.add('hidden');
            }
        }

        function auditCustomPortfolio() {
            if (customAssets.length === 0) return alert("A침ade activos primero.");
            const text = "Audita mi cartera personalizada actual: " + customAssets.map(a => a.name + " " + (a.ratio * 100).toFixed(0) + "%").join(", ");
            askGemini(text);
            document.getElementById('ai-advisor').scrollIntoView({ behavior: 'smooth' });
        }

        function designPortfolioWithAI() {
            // Plantilla editable con placeholders para que el usuario modifique
            const template = `Dise침a una cartera de inversi칩n diversificada para m칤.

Mi situaci칩n:
- Capital disponible: [INGRESA TU CAPITAL, ej: $45.000]
- Horizonte temporal: [ELIGE: corto/mediano/largo plazo]
- Perfil de riesgo: [ELIGE: conservador/moderado/agresivo]
- Objetivo principal: [DESCRIBE: crecimiento/preservaci칩n/ingresos pasivos]

Los activos disponibles son: S&P 500, Bitcoin, Fondo Liquidez, Oro, Bonos UI, Nasdaq 100, Bonos USA, Efectivo.

Dame una propuesta con porcentajes espec칤ficos que sumen 100%.`;

            // Pegar en el textarea sin enviar
            const textarea = document.getElementById('user-input');
            textarea.value = template;
            autoResizeTextarea(textarea); // Expandir el textarea
            textarea.focus();

            // Scroll al chat
            document.getElementById('ai-advisor').scrollIntoView({ behavior: 'smooth' });

            // Seleccionar el primer placeholder para que sea f치cil editar
            const firstPlaceholder = template.indexOf('[');
            if (firstPlaceholder !== -1) {
                textarea.setSelectionRange(firstPlaceholder, template.indexOf(']') + 1);
            }
        }

        // --- 3. DASHBOARD LOGIC ---

        function toggleExpandChat() {
            const container = document.getElementById('ai-container');
            const icon = document.getElementById('expand-icon');
            isChatExpanded = !isChatExpanded;

            if (isChatExpanded) {
                container.classList.add('chat-expanded');
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
                document.body.style.overflow = 'hidden';
            } else {
                container.classList.remove('chat-expanded');
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
                document.body.style.overflow = 'auto';
            }
        }

        function setMode(mode) {
            // Handle simulador, portfolios, backtesting, rebalance, and dashboard as special modes
            const isSimulador = mode === 'simulador';
            const isPortfolios = mode === 'portfolios';
            const isBacktesting = mode === 'backtesting';
            const isRebalance = mode === 'rebalance';
            const isDashboard = mode === 'dashboard';
            const portfolioMode = (isSimulador || isPortfolios || isBacktesting || isRebalance || isDashboard) ? currentMode : mode;

            if (!isSimulador && !isPortfolios && !isBacktesting && !isRebalance && !isDashboard) {
                currentMode = mode;
            }

            const btns = ['normal', 'sovereign', 'custom', 'simulador', 'portfolios', 'backtesting', 'rebalance', 'dashboard'];

            btns.forEach(b => {
                const el = document.getElementById(`btn-${b}`);
                if (!el) return;

                // Base class for all buttons (use correct sizing from nav)
                const baseClass = "px-2 py-0.5 rounded-full text-[9px] sm:text-[10px] font-bold transition-all whitespace-nowrap";

                if (b === mode) {
                    // Selected/active states
                    if (b === 'simulador') {
                        el.className = `${baseClass} bg-blue-600 text-white shadow`;
                    } else if (b === 'portfolios') {
                        el.className = `${baseClass} bg-green-600 text-white shadow`;
                    } else if (b === 'backtesting') {
                        el.className = `${baseClass} bg-purple-600 text-white shadow`;
                    } else if (b === 'rebalance') {
                        el.className = `${baseClass} bg-purple-600 text-white shadow`;
                    } else if (b === 'dashboard') {
                        el.className = `${baseClass} bg-teal-600 text-white shadow`;
                    } else if (b === 'sovereign') {
                        // Soberano: amber/gold highlight
                        el.className = `${baseClass} bg-amber-500 text-white shadow`;
                    } else if (b === 'normal') {
                        // Normie: blue highlight
                        el.className = `${baseClass} bg-blue-500 text-white shadow`;
                    } else if (b === 'custom') {
                        // Personalizado: emerald/green highlight
                        el.className = `${baseClass} bg-emerald-500 text-white shadow`;
                    }
                } else {
                    // Inactive states - NO border-l to avoid ugly outlines
                    if (b === 'simulador') {
                        el.className = `${baseClass} text-blue-500 hover:text-blue-700`;
                    } else if (b === 'portfolios') {
                        el.className = `${baseClass} text-green-500 hover:text-green-700`;
                    } else if (b === 'backtesting') {
                        el.className = `${baseClass} text-purple-500 hover:text-purple-700`;
                    } else if (b === 'rebalance') {
                        el.className = `${baseClass} text-purple-500 hover:text-purple-700`;
                    } else if (b === 'dashboard') {
                        el.className = `${baseClass} text-teal-500 hover:text-teal-700`;
                    } else {
                        // Normie, Soberano, Personalizado inactive
                        el.className = `${baseClass} text-slate-500 hover:text-slate-700`;
                    }
                }
            });

            // Toggle visibility of sections
            const mainContent = document.getElementById('main-portfolio-content');
            const simuladorWrapper = document.getElementById('simulador-wrapper');
            const simuladorExtra = document.getElementById('simulator-extra-content');
            const portfoliosWrapper = document.getElementById('portfolios-wrapper');
            const backtestingWrapper = document.getElementById('backtesting-wrapper');
            const rebalanceWrapper = document.getElementById('rebalance-wrapper');
            const dashboardWrapper = document.getElementById('dashboard-wrapper');
            const secondaryContent = document.getElementById('main-secondary-content');
            const heroSection = document.querySelector('header');
            const marketsSection = document.getElementById('markets');

            // Helper to hide all
            const hideAll = () => {
                if (mainContent) mainContent.classList.add('hidden');
                if (simuladorWrapper) simuladorWrapper.classList.add('hidden');
                if (simuladorExtra) simuladorExtra.classList.add('hidden');
                if (portfoliosWrapper) portfoliosWrapper.classList.add('hidden');
                if (backtestingWrapper) backtestingWrapper.classList.add('hidden');
                if (rebalanceWrapper) rebalanceWrapper.classList.add('hidden');
                if (dashboardWrapper) dashboardWrapper.classList.add('hidden');
                if (secondaryContent) secondaryContent.classList.add('hidden');
                if (heroSection) heroSection.classList.add('hidden');
                if (marketsSection) marketsSection.classList.add('hidden');
            };

            if (isSimulador) {
                hideAll();
                if (simuladorWrapper) simuladorWrapper.classList.remove('hidden');
                if (simuladorExtra) simuladorExtra.classList.remove('hidden');
                // Simulator initialized via initSimulator()
                return;
            } else if (isPortfolios) {
                hideAll();
                if (portfoliosWrapper) portfoliosWrapper.classList.remove('hidden');
                renderPortfoliosGrid();
                return;
            } else if (isBacktesting) {
                hideAll();
                if (backtestingWrapper) backtestingWrapper.classList.remove('hidden');
                return;
            } else if (isRebalance) {
                hideAll();
                if (rebalanceWrapper) rebalanceWrapper.classList.remove('hidden');
                initRebalanceCalculator();
                return;
            } else if (isDashboard) {
                hideAll();
                if (dashboardWrapper) dashboardWrapper.classList.remove('hidden');
                updateDashboardMode();
                return;
            } else {
                hideAll();
                if (mainContent) mainContent.classList.remove('hidden');
                if (secondaryContent) secondaryContent.classList.remove('hidden');
                if (heroSection) heroSection.classList.remove('hidden');
                if (marketsSection) marketsSection.classList.remove('hidden');
                // Initialize goal planner
                if (typeof initGoalPlanner === 'function') initGoalPlanner();
            }

            // Update portfolio management buttons visibility
            updatePortfolioButtonsVisibility();

            if (mode === 'custom') {
                document.getElementById('strategy-panel').classList.add('hidden');
                document.getElementById('custom-builder').classList.remove('hidden');
                document.getElementById('hero-highlight').innerText = "Tu Dise침o";
                document.getElementById('hero-desc').innerText = "Modo manual. T칰 decides la asignaci칩n.";
            } else {
                document.getElementById('strategy-panel').classList.remove('hidden');
                document.getElementById('custom-builder').classList.add('hidden');
            }

            const promptContainer = document.getElementById('prompt-buttons');
            promptContainer.innerHTML = '';

            let prompts = [];
            if (mode === 'custom') {
                prompts = [
                    { title: '游꿛 Armar Portfolio', q: 'Dise침a una cartera de inversi칩n diversificada para m칤. Tengo ' + formatCurrency(currentCapital) + ' para invertir a largo plazo. Dame una propuesta con porcentajes espec칤ficos.' },
                    { title: '游돗勇 Auditar Cartera', q: 'Analiza mi distribuci칩n personalizada. 쮼s coherente seg칰n Graham y Dalio?' },
                    { title: '游늴 Stress Test', q: '쯈u칠 le pasar칤a a mi cartera personalizada si hay una crisis como la del 2008?' },
                    { title: '游눠 Sugerencias', q: '쯈u칠 activo me falta para estar mejor diversificado?' }
                ];
            } else {
                prompts = config[mode].prompts;
            }

            prompts.forEach(p => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-2 rounded-lg border transition bg-white border-slate-200 hover:border-purple-400 hover:shadow-md`;
                btn.onclick = () => askGemini(p.q);
                btn.innerHTML = `<div class="font-semibold text-xs text-slate-700">${p.title}</div><div class="text-[10px] mt-1 text-slate-400 leading-tight">${p.q}</div>`;
                promptContainer.appendChild(btn);
            });

            // Theme is now controlled by global toggle, not by strategy selection

            updateDashboard();
        }

        function recalcReturnFromAssets() {
            updateDashboard(); // Forces recalc of weighted return
        }

        function updateDashboard() {
            const inputVal = document.getElementById('capitalInput').value;
            currentCapital = parseFloat(inputVal) || 0;
            const data = config[currentMode];

            if (currentMode !== 'custom') {
                document.getElementById('hero-highlight').innerText = data.heroTitle;
                document.getElementById('hero-highlight').className = currentMode === 'sovereign' ? 'text-amber-400' : 'text-blue-600';
                document.getElementById('hero-desc').innerHTML = data.heroDesc;
                document.getElementById('alloc-desc').innerText = data.allocDesc;
            }
            document.getElementById('breakdown-total').innerText = formatCurrency(currentCapital);

            // Strategy List Logic - Explicit Population for Normie/Sovereign
            if (currentMode !== 'custom') {
                const stratList = document.getElementById('strategy-list');
                stratList.innerHTML = '';
                if (data.strategy && data.strategy.length > 0) {
                    data.strategy.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = item;
                        stratList.appendChild(li);
                    });
                }
            }

            // Checklist Logic
            const checkContainer = document.getElementById('checklist-container');
            checkContainer.innerHTML = '';
            if (data.checklist && data.checklist.length > 0) {
                data.checklist.forEach(step => {
                    const label = document.createElement('label');
                    label.className = "flex items-center p-4 cursor-pointer transition group hover:bg-opacity-50 " + (currentMode === 'sovereign' ? "hover:bg-slate-800" : "hover:bg-slate-50");
                    label.innerHTML = `<input type="checkbox" class="w-5 h-5 rounded focus:ring-blue-500 border-gray-300 ${currentMode === 'sovereign' ? 'accent-amber-500' : 'text-blue-600'}"><span class="ml-3 text-sm transition ${currentMode === 'sovereign' ? 'text-slate-300 group-hover:text-amber-400' : 'text-slate-700 group-hover:text-blue-700'}">${step}</span>`;
                    checkContainer.appendChild(label);
                });
            }

            let activeAssets = [];
            if (currentMode === 'custom') {
                activeAssets = customAssets.map(a => ({ ...a, val: Math.round(currentCapital * a.ratio) }));
            } else {
                activeAssets = data.assets.map(a => ({
                    name: a.name,
                    color: a.color,
                    val: Math.round(currentCapital * a.ratio),
                    ratio: a.ratio
                }));
            }

            // Update Breakdown UI
            const assetBreakdown = document.getElementById('asset-breakdown');
            assetBreakdown.innerHTML = '';
            if (activeAssets.length === 0 && currentMode === 'custom') {
                assetBreakdown.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">Define tu cartera a la izquierda.</p>';
            } else {
                activeAssets.forEach(asset => {
                    const pct = (asset.ratio * 100).toFixed(0) + '%';
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div class="flex justify-between text-sm font-medium mb-1">
                            <span class="${currentMode === 'sovereign' ? 'text-slate-200' : 'text-slate-700'}">${asset.name}</span>
                            <span class="${currentMode === 'sovereign' ? 'text-slate-400' : 'text-slate-500'}">${formatCurrency(asset.val)} (${pct})</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                            <div class="h-2 rounded-full" style="width: ${pct}; background-color: ${asset.color}"></div>
                        </div>
                    `;
                    assetBreakdown.appendChild(div);
                });
            }

            // DYNAMIC PROJECTION CALCULATION
            let weightedReturn = 0;
            let totalRatio = 0;
            activeAssets.forEach(a => {
                let ret = 8; // default fallback
                const key = Object.keys(assetMeta).find(k => a.name.includes(k));
                if (key) ret = assetMeta[key].ret;
                weightedReturn += ret * a.ratio;
                totalRatio += a.ratio;
            });

            // FIX: Ensure 0 assets = 0 return
            if (totalRatio > 0) weightedReturn = weightedReturn / totalRatio;
            else weightedReturn = 0; // Was 8, now 0. Corrects phantom growth.

            // Only update input if we just recalculated context (avoids overwriting user manual edit on just projection calls, though updateDashboard is usually full recalc)
            // Ideally we want to update the SUGGESTED return.
            document.getElementById('expectedReturn').value = weightedReturn.toFixed(1);

            updateAllocationChart(activeAssets);
            updateProjection();
        }

        // --- 4. CHART LOGIC ---
        let allocChart = null;
        function updateAllocationChart(assets) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            if (allocChart) allocChart.destroy();

            const data = assets.length ? assets.map(a => a.val) : [1];
            const colors = assets.length ? assets.map(a => a.color) : ['#e2e8f0'];
            const labels = assets.length ? assets.map(a => a.name) : ['Sin Datos'];

            allocChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 10 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: currentMode === 'sovereign' ? '#CBD5E1' : '#334155', usePointStyle: true, padding: 20 } }, tooltip: { backgroundColor: currentMode === 'sovereign' ? 'rgba(15, 23, 42, 0.95)' : 'rgba(30, 41, 59, 0.9)', callbacks: { label: function (context) { return ` ${formatCurrency(context.raw)}`; } } } } }
            });
        }

        let growthChart = null;
        function updateProjection() {
            // Check if Monte Carlo mode is enabled
            if (typeof projectionMode !== 'undefined' && projectionMode === 'montecarlo') {
                updateProjectionMonteCarlo();
                return;
            }

            const monthly = parseFloat(document.getElementById('monthlyContrib').value) || 0;
            const years = parseInt(document.getElementById('yearsProj').value) || 10;
            const rate = parseFloat(document.getElementById('expectedReturn').value) || 0;

            let balance = currentCapital;
            let mattress = currentCapital;
            const labels = [];
            const dataInvested = [];
            const dataMattress = [];
            const monthlyRate = rate / 100 / 12;

            for (let year = 0; year <= years; year++) {
                labels.push('A침o ' + year);
                dataInvested.push(Math.round(balance));
                dataMattress.push(Math.round(mattress));
                if (year < years) {
                    for (let m = 0; m < 12; m++) {
                        balance = (balance + monthly) * (1 + monthlyRate);
                        mattress += monthly;
                    }
                }
            }

            const ctx = document.getElementById('growthChart').getContext('2d');
            if (growthChart) growthChart.destroy();
            const lineColor = currentMode === 'sovereign' ? '#F59E0B' : '#10B981';
            const areaColor = currentMode === 'sovereign' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)';
            const gridColor = currentMode === 'sovereign' ? '#334155' : '#E2E8F0';
            const textColor = currentMode === 'sovereign' ? '#94A3B8' : '#64748B';

            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Proyecci칩n Cartera', data: dataInvested, borderColor: lineColor, backgroundColor: areaColor, fill: true, tension: 0.4 },
                        { label: 'Capital sin Invertir', data: dataMattress, borderColor: textColor, borderDash: [5, 5], tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false }, ticks: { color: textColor } }, y: { grid: { color: gridColor }, ticks: { color: textColor, callback: function (value) { return '$' + value / 1000 + 'k'; } } } }, plugins: { legend: { labels: { color: textColor } }, tooltip: { mode: 'index', intersect: false } } }
            });
        }

        // === GOAL PLANNER (Modo Objetivo) - Reverse Engineering PMT ===

        // Calculate required monthly payment to reach a goal
        // Formula: PMT = (FV - PV * (1 + r)^n) / (((1 + r)^n - 1) / r)
        // Where: FV = Future Value (goal), PV = Present Value (capital), r = monthly rate, n = periods
        function calculateRequiredPMT() {
            // Get inputs
            const goalTarget = parseFloat(document.getElementById('goal-target')?.value) || 100000;
            const goalYears = parseInt(document.getElementById('goal-years')?.value) || 10;
            const goalCapital = parseFloat(document.getElementById('goal-capital')?.value) || 0;
            const goalRate = parseFloat(document.getElementById('goal-rate')?.value) || 8;

            // Get current monthly contribution for comparison
            const currentMonthly = parseFloat(document.getElementById('monthlyContrib')?.value) || 2000;

            // Calculate required PMT
            const n = goalYears * 12; // Total months
            const r = goalRate / 100 / 12; // Monthly rate

            let requiredPMT = 0;

            if (r === 0) {
                // Special case: 0% interest (simple division)
                requiredPMT = (goalTarget - goalCapital) / n;
            } else {
                // Compound interest formula for PMT
                // FV = PV * (1+r)^n + PMT * ((1+r)^n - 1) / r
                // Solving for PMT:
                // PMT = (FV - PV * (1+r)^n) / (((1+r)^n - 1) / r)
                const compoundFactor = Math.pow(1 + r, n);
                const futureCapital = goalCapital * compoundFactor;
                const annuityFactor = (compoundFactor - 1) / r;

                requiredPMT = (goalTarget - futureCapital) / annuityFactor;
            }

            // Ensure non-negative (if goal is already reached with capital growth, PMT = 0)
            requiredPMT = Math.max(0, requiredPMT);

            // Update UI - Main result
            const pmtFormatted = '$' + Math.round(requiredPMT).toLocaleString('es-UY');
            document.getElementById('goal-result-pmt').textContent = pmtFormatted;
            document.getElementById('goal-needed').textContent = pmtFormatted;
            document.getElementById('goal-result-target').textContent = '$' + goalTarget.toLocaleString('es-UY');
            document.getElementById('goal-result-years').textContent = goalYears;

            // Update comparison
            document.getElementById('goal-current').textContent = '$' + currentMonthly.toLocaleString('es-UY');

            const difference = currentMonthly - requiredPMT;
            const diffContainer = document.getElementById('goal-diff-container');
            const diffMessage = document.getElementById('goal-diff-message');

            if (difference >= 0) {
                // Sufficient - Green
                diffContainer.className = 'mt-3 p-3 rounded-lg bg-green-100';
                diffMessage.className = 'font-bold text-sm text-green-700';
                diffMessage.innerHTML = `<i class="fa-solid fa-check-circle mr-1"></i>춰Vas bien! Te sobran $${Math.round(difference).toLocaleString('es-UY')}/mes`;
            } else {
                // Shortfall - Red
                diffContainer.className = 'mt-3 p-3 rounded-lg bg-red-100';
                diffMessage.className = 'font-bold text-sm text-red-700';
                diffMessage.innerHTML = `<i class="fa-solid fa-exclamation-triangle mr-1"></i>Te faltan $${Math.round(Math.abs(difference)).toLocaleString('es-UY')}/mes`;
            }

            // Update tip based on rate
            const tipEl = document.getElementById('goal-tip');
            const higherRatePMT = calculatePMTWithRate(goalTarget, goalCapital, goalYears, goalRate + 2);
            const savings = requiredPMT - higherRatePMT;

            if (savings > 0) {
                tipEl.innerHTML = `<strong>Tip:</strong> Con un retorno de ${goalRate + 2}% (mayor riesgo), necesitar칤as solo <strong>$${Math.round(higherRatePMT).toLocaleString('es-UY')}/mes</strong>  ahorrar칤as $${Math.round(savings).toLocaleString('es-UY')}/mes.`;
            } else {
                tipEl.innerHTML = `<strong>Tip:</strong> Tu capital inicial ya cubre gran parte de la meta. El inter칠s compuesto trabaja a tu favor.`;
            }

            // Update strategy name
            let strategyName = 'Mixta';
            if (typeof currentMode !== 'undefined') {
                if (currentMode === 'normal') strategyName = 'Normie (Conservadora)';
                else if (currentMode === 'sovereign') strategyName = 'Soberano (Agresiva)';
                else if (currentMode === 'custom') strategyName = 'Personalizada';
            }
            document.getElementById('goal-strategy-name').textContent = strategyName;
        }

        // Helper function to calculate PMT with a specific rate
        function calculatePMTWithRate(goalTarget, goalCapital, goalYears, rate) {
            const n = goalYears * 12;
            const r = rate / 100 / 12;

            if (r === 0) return (goalTarget - goalCapital) / n;

            const compoundFactor = Math.pow(1 + r, n);
            const futureCapital = goalCapital * compoundFactor;
            const annuityFactor = (compoundFactor - 1) / r;

            return Math.max(0, (goalTarget - futureCapital) / annuityFactor);
        }

        // Initialize goal planner with current values
        function initGoalPlanner() {
            // Sync with current capital
            const goalCapitalInput = document.getElementById('goal-capital');
            if (goalCapitalInput && typeof currentCapital !== 'undefined') {
                goalCapitalInput.value = currentCapital;
            }

            // Sync with expected return
            const goalRateInput = document.getElementById('goal-rate');
            const expectedReturnInput = document.getElementById('expectedReturn');
            if (goalRateInput && expectedReturnInput) {
                goalRateInput.value = expectedReturnInput.value || 8;
                document.getElementById('goal-rate-display').textContent = goalRateInput.value + '%';
            }

            // Calculate initial PMT
            calculateRequiredPMT();
        }

        // Make functions globally accessible
        window.calculateRequiredPMT = calculateRequiredPMT;
        window.initGoalPlanner = initGoalPlanner;

        // === PDF REPORT GENERATOR ===

        async function generatePDFReport() {
            // Show loading indicator
            const loadingBtn = event.target.closest('button');
            const originalContent = loadingBtn.innerHTML;
            loadingBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generando PDF...';
            loadingBtn.disabled = true;

            // ===== CAPTURE USER INPUT BEFORE REFRESH =====
            // This is critical because setMode() might reset inputs to defaults
            const userRateInput = parseFloat(document.getElementById('expectedReturn')?.value);
            console.log('PDF Generation - User Input Rate (Before Refresh):', userRateInput);

            // ===== FORCE REFRESH CURRENT MODE DATA =====
            // Re-read currentMode to ensure we have the latest
            console.log('PDF Generation - Current Mode:', currentMode);

            // Force chart updates with current mode data
            if (typeof setMode === 'function') {
                setMode(currentMode); // Force refresh

                // RESTORE USER INPUT IF IT WAS VALID
                // This ensures the chart reflects the user's custom rate if setMode reset it
                if (!isNaN(userRateInput) && userRateInput > 0) {
                    const rateInputEl = document.getElementById('expectedReturn');
                    if (rateInputEl) {
                        rateInputEl.value = userRateInput;
                        // Trigger updateProjection to ensure charts match the PDF numbers
                        if (typeof updateProjection === 'function') updateProjection();
                    }
                }
            }

            // Wait for charts to render (increased to 1200ms to ensure animations complete)
            await new Promise(r => setTimeout(r, 1200));

            // Get current data
            const today = new Date().toLocaleDateString('es-UY', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            const strategyNames = {
                normal: 'Protocolo Normie',
                sovereign: 'Protocolo Fortaleza',
                custom: 'Estrategia Personalizada'
            };
            const strategyName = strategyNames[currentMode] || 'Estrategia';

            const strategyDescriptions = {
                normal: 'Cartera cl치sica 60/40 optimizada para crecimiento a largo plazo',
                sovereign: 'Estrategia Barbell para protecci칩n patrimonial y soberan칤a financiera',
                custom: 'Asignaci칩n personalizada definida por el usuario'
            };
            const strategyDesc = strategyDescriptions[currentMode] || '';

            const capitalFormatted = (currentCapital || 0).toLocaleString('es-UY');

            // ===== GET CORRECT ASSETS FROM CURRENT MODE =====
            let assets = [];
            if (currentMode === 'custom' && customAssets && customAssets.length > 0) {
                assets = customAssets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    color: a.color || '#6366f1',
                    returnRate: a.returnRate || 8
                }));
            } else if (config[currentMode] && config[currentMode].assets) {
                assets = config[currentMode].assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    color: a.color || '#6366f1',
                    returnRate: a.returnRate || 8
                }));
            }

            // ===== GET RATE FROM USER INPUT (PRIORITY) =====
            // Use the value captured BEFORE the refresh to be 100% sure
            const inputRate = userRateInput;

            // ===== RECALCULATE WEIGHTED RETURN FROM ASSETS (REFERENCE) =====
            let calculatedRate = 0;
            assets.forEach(a => {
                calculatedRate += (a.returnRate || 8) * a.ratio;
            });

            // Use input rate if valid, otherwise calculated, otherwise default
            let finalRate = 8;
            if (!isNaN(inputRate) && inputRate > 0) {
                finalRate = inputRate;
            } else if (calculatedRate > 0) {
                finalRate = calculatedRate;
            }

            console.log('PDF Generation - Final Rate used:', finalRate.toFixed(2) + '%');

            // Calculate total percent
            let totalPercent = 0;
            assets.forEach(a => totalPercent += Math.round(a.ratio * 100));

            // ===== CAPTURE CHARTS AS HIGH-RES IMAGES =====
            let allocationChartImg = '';
            let projectionChartImg = '';

            try {
                const allocCanvas = document.getElementById('allocationChart');
                if (allocCanvas && allocCanvas.getContext) {
                    allocationChartImg = allocCanvas.toDataURL('image/png', 1.0);
                }
            } catch (e) { console.error('Error capturing allocation chart:', e); }

            try {
                const projCanvas = document.getElementById('projectionChart');
                if (projCanvas && projCanvas.getContext) {
                    projectionChartImg = projCanvas.toDataURL('image/png', 1.0);
                }
            } catch (e) { console.error('Error capturing projection chart:', e); }

            // ===== PROJECTION CALCULATIONS WITH FINAL RATE =====
            const monthly = parseFloat(document.getElementById('monthlyContrib')?.value) || 2000;
            const rate = finalRate; // Use finalized priority rate

            const projections = [
                { years: 5, value: calculateFutureValue(currentCapital, monthly, rate, 5) },
                { years: 10, value: calculateFutureValue(currentCapital, monthly, rate, 10) },
                { years: 15, value: calculateFutureValue(currentCapital, monthly, rate, 15) },
                { years: 20, value: calculateFutureValue(currentCapital, monthly, rate, 20) }
            ];

            // ===== BUILD A4-SIZED PDF DOCUMENT =====
            // A4 at 96dpi = 794px x 1123px
            const pdfHTML = `
                <div id="pdf-report" style="
                    width: 794px;
                    min-height: 1123px;
                    background: #ffffff;
                    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                    color: #1e293b;
                    margin: 0;
                    padding: 0;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                    color-adjust: exact !important;
                ">
                    <style>
                        * { 
                            -webkit-print-color-adjust: exact !important; 
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            box-sizing: border-box;
                        }
                        #pdf-report * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    </style>
                    
                    <!-- ===== DARK HEADER (150px tall) ===== -->
                    <div style="
                        background: #1e293b !important;
                        height: 150px;
                        padding: 30px 40px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <!-- Left: Logo & Branding -->
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="
                                width: 56px; height: 56px;
                                background: linear-gradient(135deg, #22c55e, #10b981) !important;
                                border-radius: 14px;
                                display: flex; align-items: center; justify-content: center;
                                font-size: 28px;
                            ">游꺔</div>
                            <div>
                                <h1 style="color: #ffffff !important; font-size: 32px; font-weight: 300; margin: 0; letter-spacing: -1px;">Plan Semilla</h1>
                                <p style="color: rgba(255,255,255,0.6) !important; font-size: 11px; margin: 6px 0 0 0; text-transform: uppercase; letter-spacing: 3px;">Investment Report</p>
                            </div>
                        </div>
                        
                        <!-- Right: Title -->
                        <div style="text-align: right;">
                            <h2 style="color: #ffffff !important; font-size: 22px; font-weight: 200; margin: 0; letter-spacing: 1px;">REPORTE DE ESTRATEGIA</h2>
                            <p style="color: rgba(255,255,255,0.5) !important; font-size: 12px; margin: 8px 0 0 0;">${today}</p>
                        </div>
                    </div>
                    
                    <!-- ===== EXECUTIVE SUMMARY BAR ===== -->
                    <div style="
                        background: linear-gradient(90deg, #0f766e, #14b8a6) !important;
                        padding: 20px 40px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <p style="color: rgba(255,255,255,0.7) !important; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin: 0;">Estrategia Seleccionada</p>
                            <p style="color: #ffffff !important; font-size: 18px; font-weight: 600; margin: 4px 0 0 0;">${strategyName}</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="color: rgba(255,255,255,0.7) !important; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin: 0;">Capital Inicial</p>
                            <p style="color: #ffffff !important; font-size: 28px; font-weight: 700; margin: 4px 0 0 0; font-family: 'Courier New', monospace;">$${capitalFormatted}</p>
                        </div>
                        <div style="text-align: right; max-width: 280px;">
                            <p style="color: rgba(255,255,255,0.8) !important; font-size: 11px; margin: 0; line-height: 1.4;">${strategyDesc}</p>
                        </div>
                    </div>
                    
                    <!-- ===== SECTION 1: ASSET ALLOCATION ===== -->
                    <div style="padding: 35px 40px 25px;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="display: inline-block; width: 4px; height: 22px; background: linear-gradient(180deg, #10b981, #3b82f6) !important; border-radius: 2px;"></span>
                            Asignaci칩n de Activos
                        </h3>
                        
                        <div style="display: flex; gap: 30px; align-items: center;">
                            <!-- Donut Chart with Border -->
                            <div style="
                                flex: 0 0 300px;
                                min-width: 300px;
                                max-width: 300px;
                                background: #f8fafc !important;
                                border: 1px solid #e2e8f0;
                                border-radius: 16px;
                                padding: 10px;
                                text-align: center;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                            ">
                                ${allocationChartImg ?
                    `<img src="${allocationChartImg}" style="width: 280px; height: auto; display: block; margin: 0 auto;">` :
                    `<div style="width: 280px; height: 280px; background: #e2e8f0; border-radius: 50%;"></div>`
                }
                                <p style="font-size: 10px; color: #64748b; margin: 10px 0 0 0; text-transform: uppercase; letter-spacing: 1px;">Distribuci칩n del Portfolio</p>
                            </div>
                            
                            <!-- Zebra Table -->
                            <div style="flex: 1;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #1e293b !important;">
                                            <th style="padding: 12px 14px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #ffffff !important;">Activo</th>
                                            <th style="padding: 12px 14px; text-align: center; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #ffffff !important;">Asignaci칩n</th>
                                            <th style="padding: 12px 14px; text-align: right; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #ffffff !important;">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${assets.map((asset, i) => {
                    const pct = Math.round(asset.ratio * 100);
                    const value = Math.round(currentCapital * asset.ratio);
                    const bgColor = i % 2 === 0 ? '#ffffff' : '#f1f5f9';
                    return `
                                                <tr style="background: ${bgColor} !important;">
                                                    <td style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                                        <div style="display: flex; align-items: center; gap: 10px;">
                                                            <div style="width: 12px; height: 12px; background: ${asset.color} !important; border-radius: 3px;"></div>
                                                            <span style="font-weight: 500; color: #1e293b;">${asset.name}</span>
                                                        </div>
                                                    </td>
                                                    <td style="padding: 14px; text-align: center; font-weight: 700; color: #0f172a; font-size: 16px; border-bottom: 1px solid #e2e8f0;">${pct}%</td>
                                                    <td style="padding: 14px; text-align: right; color: #64748b; font-family: 'Courier New', monospace; border-bottom: 1px solid #e2e8f0;">$${value.toLocaleString('es-UY')}</td>
                                                </tr>
                                            `;
                }).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important;">
                                            <td style="padding: 14px; font-weight: 700; color: #065f46;">TOTAL</td>
                                            <td style="padding: 14px; text-align: center; font-weight: 800; font-size: 18px; color: #059669;">${totalPercent}%</td>
                                            <td style="padding: 14px; text-align: right; font-weight: 700; color: #059669; font-family: 'Courier New', monospace;">$${currentCapital.toLocaleString('es-UY')}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ===== SECTION 2: PROJECTIONS ===== -->
                    <div style="padding: 25px 40px; background: #f8fafc !important;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="display: inline-block; width: 4px; height: 22px; background: linear-gradient(180deg, #8b5cf6, #ec4899) !important; border-radius: 2px;"></span>
                            Proyecci칩n de Crecimiento
                        </h3>
                        
                            Basado en aporte mensual de <strong style="color: #1e293b;">$${monthly.toLocaleString('es-UY')}</strong> con retorno esperado de <strong style="color: #1e293b;">${rate.toLocaleString('es-UY', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%</strong> anual
                        </p>
                        
                        ${projectionChartImg ? `
                        <div style="
                            background: #ffffff !important;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 20px;
                            text-align: center;
                        ">
                            <img src="${projectionChartImg}" style="max-width: 100%; height: auto; max-height: 200px; object-fit: contain;">
                        </div>
                        ` : ''}
                        
                        <!-- Value Cards -->
                        <div style="display: flex; gap: 12px;">
                            ${projections.map((p, i) => {
                    const borderColors = ['#10b981', '#3b82f6', '#8b5cf6', '#0ea5e9'];
                    const borderColor = borderColors[i];
                    return `
                                    <div style="
                                        flex: 1;
                                        background: #ffffff !important;
                                        border: 1px solid #e2e8f0;
                                        border-top: 4px solid ${borderColor};
                                        border-radius: 8px;
                                        padding: 16px 12px;
                                        text-align: center;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                                    ">
                                        <p style="font-size: 9px; color: #64748b; margin: 0 0 8px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">En ${p.years} a침os</p>
                                        <p style="font-size: 18px; font-weight: 700; font-family: 'Courier New', monospace; color: #1e293b; margin: 0;">$${Math.round(p.value).toLocaleString('es-UY')}</p>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                    
                    <!-- ===== FOOTER ===== -->
                    <div style="
                        background: #0f172a !important;
                        padding: 25px 40px;
                        margin-top: auto;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;">游꺔</span>
                                <span style="font-size: 14px; font-weight: 600; color: #ffffff !important;">Plan Semilla</span>
                            </div>
                            <p style="font-size: 10px; color: rgba(255,255,255,0.5) !important; margin: 0;">Versi칩n 2.0  ${today}</p>
                        </div>
                        
                        <div style="
                            background: rgba(251, 191, 36, 0.15) !important;
                            border: 1px solid rgba(251, 191, 36, 0.4);
                            border-radius: 8px;
                            padding: 12px 16px;
                        ">
                            <p style="color: #fbbf24 !important; font-size: 10px; margin: 0; line-height: 1.5;">
                                丘멆잺 <strong>AVISO LEGAL:</strong> Este reporte es una simulaci칩n con fines educativos generada por Plan Semilla. 
                                No constituye asesoramiento financiero regulado. Las proyecciones est치n basadas en rendimientos hist칩ricos que no garantizan resultados futuros.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            // ===== CREATE INVISIBLE CONTAINER =====
            const container = document.createElement('div');
            container.innerHTML = pdfHTML;
            container.style.position = 'absolute'; // Changed from fixed to absolute to avoid viewport clipping
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.zIndex = '-1'; // Ensure it's behind everything
            document.body.appendChild(container);

            const element = container.querySelector('#pdf-report');

            // ===== CONFIGURE html2pdf OPTIONS =====
            const opt = {
                margin: 0,
                filename: `Plan_Semilla_Reporte_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 3,  // Retina quality
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    scrollY: 0, // Critical: force top of document capture
                    scrollX: 0
                },
                jsPDF: {
                    unit: 'px',
                    format: [794, 1123],  // A4 dimensions
                    orientation: 'portrait',
                    hotfixes: ['px_scaling']
                }
            };

            // ===== GENERATE PDF =====
            html2pdf().set(opt).from(element).save().then(() => {
                // Cleanup
                document.body.removeChild(container);
                loadingBtn.innerHTML = originalContent;
                loadingBtn.disabled = false;
            }).catch(err => {
                console.error('PDF generation error:', err);
                document.body.removeChild(container);
                loadingBtn.innerHTML = originalContent;
                loadingBtn.disabled = false;
                alert('Error generando PDF. Intenta nuevamente.');
            });
        }

        // Helper: Calculate future value with compound interest


































        // Helper: Calculate future value with compound interest
        function calculateFutureValue(pv, pmt, rate, years) {
            const r = rate / 100 / 12;
            const n = years * 12;

            if (r === 0) return pv + (pmt * n);

            // FV = PV * (1+r)^n + PMT * ((1+r)^n - 1) / r
            const compoundFactor = Math.pow(1 + r, n);
            return pv * compoundFactor + pmt * ((compoundFactor - 1) / r);
        }

        // Make PDF function globally accessible
        window.generatePDFReport = generatePDFReport;

        // --- MONTE CARLO SIMULATION ENGINE ---

        let projectionMode = 'simple'; // 'simple' | 'montecarlo'

        // Toggle between Simple and Monte Carlo projection modes
        function setProjectionMode(mode) {
            projectionMode = mode;

            const simpleBtn = document.getElementById('proj-mode-simple');
            const montecarloBtn = document.getElementById('proj-mode-montecarlo');

            if (mode === 'simple') {
                simpleBtn.classList.add('bg-white', 'shadow', 'text-blue-600');
                simpleBtn.classList.remove('text-slate-600');
                montecarloBtn.classList.remove('bg-white', 'shadow', 'text-blue-600');
                montecarloBtn.classList.add('text-slate-600');
            } else {
                montecarloBtn.classList.add('bg-white', 'shadow', 'text-blue-600');
                montecarloBtn.classList.remove('text-slate-600');
                simpleBtn.classList.remove('bg-white', 'shadow', 'text-blue-600');
                simpleBtn.classList.add('text-slate-600');
            }

            updateProjection();
        }

        // Gaussian random number generator (Box-Muller transform)
        function gaussianRandom() {
            const u1 = Math.random();
            const u2 = Math.random();
            return Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        }

        // Percentile calculation
        function percentile(arr, p) {
            const sorted = [...arr].sort((a, b) => a - b);
            const index = (p / 100) * (sorted.length - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index - lower;
            return sorted[lower] * (1 - weight) + sorted[upper] * weight;
        }

        // Get current portfolio volatility based on allocation
        function getCurrentPortfolioVolatility() {
            // Check if using a strategy or individual asset
            if (typeof currentAllocation !== 'undefined' && currentAllocation && Object.keys(currentAllocation).length > 0) {
                return calculatePortfolioVolatility(currentAllocation);
            }
            // Default volatility for simple portfolio
            return 20;
        }

        // Calculate weighted portfolio volatility from allocation
        function calculatePortfolioVolatility(allocation) {
            // Asset volatilities (annualized %)
            const assetVolatilities = {
                bitcoin: 70, sp500: 15, nasdaq: 20, ethereum: 80, solana: 100,
                gold: 15, fondoLiquidez: 5, bonosTesoro: 10, bonosUI: 8
            };

            let totalVol = 0;
            let totalWeight = 0;

            for (const [asset, weight] of Object.entries(allocation)) {
                const pct = typeof weight === 'object' ? weight.percentage : weight;
                if (pct > 0) {
                    const assetVol = assetVolatilities[asset] || simAssetData[asset]?.volatility || 20;
                    totalVol += (pct / 100) * assetVol;
                    totalWeight += pct;
                }
            }

            return totalWeight > 0 ? totalVol : 20;
        }

        /**
        * Run Monte Carlo simulation using Geometric Brownian Motion
        * @param {number} initialCapital - Starting capital
        * @param {number} monthlyContrib - Monthly contribution
        * @param {number} years - Years to project
        * @param {number} expectedReturn - Annual expected return (%)
        * @param {number} volatility - Annualized volatility (%)
        * @param {number} numSimulations - Number of simulations (default 1000)
        * @returns {Object} { median: [], p10: [], p90: [], labels: [] }
        */
        function runMonteCarloSimulation(initialCapital, monthlyContrib, years, expectedReturn, volatility, numSimulations =
            1000) {
            const months = years * 12;
            const monthlyReturn = expectedReturn / 100 / 12;
            const monthlyVol = volatility / 100 / Math.sqrt(12);

            // Store all simulation paths (yearly values)
            const allSimulations = [];

            for (let sim = 0; sim < numSimulations; sim++) {
                const path = [initialCapital];
                let balance = initialCapital;

                for (let m = 1; m <= months; m++) {
                    // Geometric Brownian Motion:
                    // S(t+1) = S(t) * exp((풮 - 픢/2)*dt + 픢*sqrt(dt)*Z)
                    const z = gaussianRandom();
                    const drift = monthlyReturn - (monthlyVol * monthlyVol) / 2;
                    const shock = monthlyVol * z;
                    const growthFactor = Math.exp(drift + shock);

                    // Add contribution first, then apply growth
                    balance = (balance + monthlyContrib) * growthFactor;

                    // Prevent negative values (floor at 0)
                    balance = Math.max(0, balance);

                    // Store yearly values
                    if (m % 12 === 0) {
                        path.push(balance);
                    }
                }

                allSimulations.push(path);
            }

            // Calculate percentiles for each year
            const numPoints = years + 1;
            const median = [], p10 = [], p90 = [];
            const labels = Array.from({ length: numPoints }, (_, i) => `A침o ${i} `);

            for (let year = 0; year < numPoints; year++) {
                const valuesAtYear = allSimulations.map(sim => sim[year]);

                p10.push(Math.round(percentile(valuesAtYear, 10)));
                median.push(Math.round(percentile(valuesAtYear, 50)));
                p90.push(Math.round(percentile(valuesAtYear, 90)));
            }

            return { median, p10, p90, labels };
        }

        // Render Monte Carlo probability cone chart
        function renderMonteCarloChart(results) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            if (growthChart) growthChart.destroy();

            const lineColor = currentMode === 'sovereign' ? '#F59E0B' : '#10B981';
            const bandColor = currentMode === 'sovereign' ? 'rgba(245, 158, 11, 0.25)' : 'rgba(16, 185, 129, 0.25)';
            const gridColor = currentMode === 'sovereign' ? '#334155' : '#E2E8F0';
            const textColor = currentMode === 'sovereign' ? '#94A3B8' : '#64748B';

            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results.labels,
                    datasets: [
                        // P90 Upper band (for fill)
                        {
                            label: 'Escenario Optimista (P90)',
                            data: results.p90,
                            borderColor: lineColor,
                            borderWidth: 1,
                            borderDash: [3, 3],
                            backgroundColor: bandColor,
                            fill: '+1',
                            tension: 0.4,
                            pointRadius: 0
                        },
                        // P10 Lower band
                        {
                            label: 'Escenario Pesimista (P10)',
                            data: results.p10,
                            borderColor: lineColor,
                            borderWidth: 1,
                            borderDash: [3, 3],
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        // Median line
                        {
                            label: 'Escenario M치s Probable (Mediana)',
                            data: results.median,
                            borderColor: lineColor,
                            borderWidth: 3,
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: lineColor
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    if (value >= 1000000) {
                                        return context.dataset.label + ': $' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                    return context.dataset.label + ': $' + Math.round(value / 1000) + 'k';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        },
                        y: {
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: function (value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Monte Carlo projection update
        function updateProjectionMonteCarlo() {
            const monthly = parseFloat(document.getElementById('monthlyContrib').value) || 0;
            const years = parseInt(document.getElementById('yearsProj').value) || 10;
            const rate = parseFloat(document.getElementById('expectedReturn').value) || 8;

            // Get portfolio volatility
            const volatility = getCurrentPortfolioVolatility();

            // Run 1000 simulations
            const results = runMonteCarloSimulation(currentCapital, monthly, years, rate, volatility, 1000);

            // Render the probability cone chart
            renderMonteCarloChart(results);
        }

        // --- 5. GEMINI EXPERT LOGIC ---

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-UY', {
                style: 'currency', currency: 'UYU',
                maximumFractionDigits: 0
            }).format(value);
        }
        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({
                behavior: 'smooth', block: 'start'
            });
        }

        function getContextPrompt() {
            // =================================================================
            // BIBLIOTECA FINANCIERA COMPLETA (75+ fuentes)
            // Emula el conocimiento de NotebookLM con fuentes expl칤citas
            // =================================================================

            const SYSTEM_PROMPT = `
        Eres un asesor financiero experto con conocimiento profundo de las siguientes fuentes.DEBES citar estas fuentes
        cuando respondas, indicando autor y libro espec칤fico.

        === TU BIBLIOTECA DE CONOCIMIENTO ===

        游닄 VALUE INVESTING & AN츼LISIS FUNDAMENTAL:
        - "The Intelligent Investor" - Benjamin Graham(biblia del value investing)
            - "Security Analysis: Principles and Technique" - Benjamin Graham & David Dodd
                - "Common Stocks and Uncommon Profits" - Philip Fisher
                    - "One Up on Wall Street" - Peter Lynch
                        - "You Can Be a Stock Market Genius" - Joel Greenblatt
                            - "The Little Book That Still Beats the Market" - Joel Greenblatt
                                - "Expectations Investing" - Michael Mauboussin
                                    - "Dear Shareholder: Best Executive Letters" - Warren Buffett, Prem Watsa

        游늳 ESTRATEGIA E INVERSI칍N A LARGO PLAZO:
        - "Stocks for the Long Run" - Jeremy Siegel(retornos hist칩ricos del mercado)
            - "A Random Walk Down Wall Street" - Burton Malkiel
                - "The Little Book of Common Sense Investing" - John Bogle
                    - "The Bogleheads' Guide to Investing" - Taylor Larimore
                        - "How to Make Money in Stocks" - William O'Neil (sistema CAN SLIM)

        游 FINANZAS CONDUCTUALES & PSICOLOG칈A:
        - "Thinking, Fast and Slow" - Daniel Kahneman(sesgos cognitivos)
            - "Misbehaving: The Making of Behavioral Economics" - Richard Thaler
                - "Fooled by Randomness" - Nassim Taleb
                    - "The Black Swan" - Nassim Taleb(eventos improbables de alto impacto)
                        - "Irrational Exuberance" - Robert Shiller
                            - "Animal Spirits" - George Akerlof & Robert Shiller
                                - "Beyond Greed and Fear" - Hersh Shefrin
                                    - "Investment Psychology Explained" - Martin Pring

        游눯 HISTORIA DEL DINERO & CRISIS FINANCIERAS:
        - "The Ascent of Money" - Niall Ferguson
            - "Debt: The First 5,000 Years" - David Graeber
                - "Money: The True Story of a Made-Up Thing" - Jacob Goldstein
                    - "A Monetary History of the United States" - Milton Friedman
                        - "Manias, Panics, and Crashes" - Charles Kindleberger
                            - "This Time Is Different: Eight Centuries" - Reinhart & Rogoff
                            - "Essays on the Great Depression" - Ben Bernanke
                                - "Big Debt Crises" - Ray Dalio
                                    - "How Countries Go Broke" - estudios de deuda soberana

        游낁 LA FED, BANCOS CENTRALES & POL칈TICA MONETARIA:
        - "The Lords of Easy Money" - Christopher Leonard(cr칤tica a la Fed)
            - "Secrets of the Federal Reserve" - Eustace Mullins
                - "Too Big to Fail" - Andrew Ross Sorkin(crisis 2008)

        游깴 MACROECONOM칈A & ORDEN MUNDIAL:
        - "Capital in the Twenty-First Century" - Thomas Piketty
            - "The Rise and Fall of American Growth" - Robert Gordon
                - "Capitalism in America: A History" - Alan Greenspan
                    - "The Changing World Order" - Ray Dalio(ciclos de imperios)
                        - "Naked Economics" - Charles Wheelan
                            - "Complexity and the Economy" - W.Brian Arthur

        丘멆잺 GREAT RESET, CBDCs & RIESGOS SIST칄MICOS:
        - "COVID-19: The Great Reset" - Klaus Schwab(WEF)
            - "The Great Narrative" - Klaus Schwab
                - "Understanding CBDC: Money and Blockchain" - an치lisis de monedas digitales
                    - "Against the Gods: The Remarkable Story of Risk" - Peter Bernstein

        游늵 TRADING CUANTITATIVO & SISTEM츼TICO:
        - "Advances in Financial Machine Learning" - Marcos L칩pez de Prado
            - "The Man Who Solved the Market" - Gregory Zuckerman(Jim Simons)
                - "Market Wizards" - Jack Schwager
                    - "Systematic Trading" - Robert Carver
                        - "Active Portfolio Management" - Grinold & Kahn
                        - "Modern Portfolio Theory and Investment Analysis" - Elton & Gruber
                        - "Technical Analysis of Stock Trends" - Edwards & Magee
                        - "Options, Futures, and Other Derivatives" - John Hull
                            - "Reminiscences of a Stock Operator" - Edwin Lef칟vre(Jesse Livermore)
                                - "Memoirs of Extraordinary Popular Delusions" - Charles Mackay

        游녬 DINAST칈AS & GRANDES FORTUNAS:
        - "Titan: The Life of John D. Rockefeller, Sr." - Ron Chernow
            - "The Snowball: Warren Buffett" - Alice Schroeder
                - "The 38 Letters from J.D. Rockefeller to His Son"
                - "John D. Rockefeller on Making Money"
                - "The House of Medici: Its Rise and Fall" - Christopher Hibbert
                    - "Medici Money" - Tim Parks
                        - "Nathan Mayer Rothschild and the Creation of a Dynasty"
                        - "Fortune's Children: Fall of the House of Vanderbilt"
                        - "Astor: Rise and Fall of an American Fortune"
                        - "Du Pont Dynasty: Behind the Nylon Curtain"
                        - "Kochland: Secret History of Koch Industries"
                        - "Empire of Pain: The Sackler Dynasty"
                        - "Bernie Madoff, the Wizard of Lies"

        游닀 OTROS RECURSOS:
        - "More Than You Know" - Michael Mauboussin
            - "Moving Beyond Modern Portfolio Theory"
            - "The Austrian School of Economics"
            - "El Inversor Inteligente"(edici칩n en espa침ol)
            - "Manual del Inversor"(ebook)

            === AUTORES CLAVE Y SUS FILOSOF칈AS ===

         Benjamin Graham: Margen de seguridad, valor intr칤nseco, Mr.Market
         Warren Buffett: Comprar negocios, no acciones.C칤rculo de competencia.
         Ray Dalio: Principios, diversificaci칩n, ciclos de deuda
         Nassim Taleb: Antifragilidad, Black Swans, skin in the game
         John Bogle: Indexaci칩n, costos bajos, largo plazo
         Peter Lynch: Invierte en lo que conoces, tenbaggers
         Jeremy Siegel: Acciones superan bonos a largo plazo
         Klaus Schwab: Great Reset, stakeholder capitalism, 4ta revoluci칩n
         Daniel Kahneman: Sesgos cognitivos, Sistema 1 vs Sistema 2

            === INSTRUCCIONES DE FORMATO DE RESPUESTA ===

                FORMATO ESTRICTO:
        1. NO uses emojis en tus respuestas
        2. Usa Markdown estructurado:
        - ** Negritas ** para conceptos clave y nombres de autores
            - Bullet points(-) para listas de 3 + items
                - NO uses tablas markdown(no se renderizan bien), usa bullets en su lugar
                    - Encabezados(##, ###) para secciones si la respuesta es larga
        3. Estructura tus respuestas as칤:
        - P치rrafo introductorio breve(1 - 2 oraciones)
            - Desarrollo con puntos clave(m치ximo 5 - 7 bullets)
                - Conclusi칩n / recomendaci칩n(1 oraci칩n)
        4. Cita fuentes: "Seg칰n **Benjamin Graham** en *The Intelligent Investor*..."
        5. NO uses listas de emojis ni formato tipo redes sociales
        6. Mant칠n respuestas CONCISAS(m치ximo 400 palabras) a menos que el usuario pida m치s detalle
        7. Responde en espa침ol

        INSTRUCCIONES DE CONTENIDO:
        1. SIEMPRE cita al menos 1 - 2 fuentes espec칤ficas de tu biblioteca
        2. Si el tema es sobre riesgo sist칠mico o CBDC, prioriza Schwab, Dalio y "Lords of Easy Money"
        3. Si es sobre value investing, prioriza Graham, Buffett, Lynch
        4. Si es sobre psicolog칤a, prioriza Kahneman, Thaler, Taleb
        5. Incluye datos espec칤ficos o cifras cuando sea posible

        CAPACIDAD ESPECIAL - SUGERIR CAMBIOS AL PORTFOLIO:
        Si el usuario te pide ayuda para dise침ar o modificar su cartera personalizada, puedes sugerir una distribuci칩n
        espec칤fica usando EXACTAMENTE este formato JSON al final de tu respuesta:

        \`\`\`portfolio-suggestion
        {
        "assets": [
        {"name": "S&P 500", "percentage": 40},
        {"name": "Bitcoin", "percentage": 20},
        {"name": "Fondo Liquidez", "percentage": 40}
        ],
        "rationale": "Breve explicaci칩n de por qu칠 esta distribuci칩n"
        }
        \`\`\`

        IMPORTANTE: Solo incluye este bloque si el usuario EXPL칈CITAMENTE te pide dise침ar, sugerir o modificar su
        cartera. El usuario ver치 un bot칩n para aplicar tu sugerencia.

        `;

            // Contexto espec칤fico seg칰n el modo actual
            let modeContext = "";

            if (currentMode === 'custom') {
                const assetsStr = customAssets.map(a => `- ${a.name}: ${(a.ratio * 100).toFixed(0)}%`).join('\n');
                modeContext = `
        === SITUACI칍N ACTUAL DEL USUARIO ===
        MODO: Personalizado (dise침칩 su propia cartera)
        CARTERA:
        ${assetsStr}
        CAPITAL: ${formatCurrency(currentCapital)}

        INSTRUCCIONES ESPEC칈FICAS:
        - Act칰a como auditor financiero senior
        - Eval칰a la cartera citando a Graham (diversificaci칩n), Dalio (balance), y Taleb (antifragilidad)
        - Si >50% en un solo activo, advierte sobre concentraci칩n (cita Lynch o Graham)
        - Si 100% cripto, habla de volatilidad y Black Swans (Taleb)
        - Si muy conservador, advierte sobre inflaci칩n erosionando capital (Siegel)
        `;
            } else if (currentMode === 'sovereign') {
                modeContext = `
        === SITUACI칍N ACTUAL DEL USUARIO ===
        MODO: Soberano (preocupado por Agenda 2030, CBDCs, p칠rdida de privacidad financiera)
        ESTRATEGIA: 35% Bitcoin, 45% S&P 500, 20% Liquidez
        CAPITAL: ${formatCurrency(currentCapital)}

        INSTRUCCIONES ESPEC칈FICAS:
        - Valida las preocupaciones citando "The Great Reset" (Schwab), "Lords of Easy Money" (Leonard)
        - Explica Bitcoin como cobertura usando "The Changing World Order" (Dalio)
        - Menciona "Understanding CBDC" para el contexto de monedas digitales
        - Discute la importancia de activos "duros" y auto-custodia
        - Cita Taleb sobre antifragilidad ante cisnes negros sist칠micos
        `;
            } else {
                modeContext = `
        === SITUACI칍N ACTUAL DEL USUARIO ===
        MODO: Normie (estrategia cl치sica de largo plazo)
        ESTRATEGIA: 60% S&P 500, 40% Fondo Liquidez Pesos
        CAPITAL: ${formatCurrency(currentCapital)}

        INSTRUCCIONES ESPEC칈FICAS:
        - Enf칩cate en el poder del inter칠s compuesto a largo plazo (Siegel "Stocks for the Long Run")
        - Cita a Bogle sobre costos bajos e indexaci칩n
        - Menciona a Graham sobre el temperamento del inversor
        - Usa datos hist칩ricos de retornos del S&P 500 (Siegel documenta 6.5-7% real anual)
        - Recomienda paciencia y "time in the market vs timing the market"
        `;
            }

            return SYSTEM_PROMPT + modeContext;
        }

        async function askGemini(presetText = null) {
            const input = document.getElementById('user-input');
            const history = document.getElementById('chat-history');
            const text = presetText || input.value.trim();
            if (!text) return;

            const userBubble = document.createElement('div');
            userBubble.className = `flex flex-col items-end chat-bubble chat-user shadow-sm`;
            userBubble.innerHTML = `<div class="font-bold text-xs mb-1 opacity-75">T칰</div>${text}`;
            history.appendChild(userBubble);
            if (!presetText) input.value = '';

            const wrapper = document.getElementById('chat-history');
            wrapper.scrollTop = wrapper.scrollHeight;

            const loadingBubble = document.createElement('div');
            loadingBubble.className = `flex flex-col items-start chat-bubble chat-ai shadow-sm`;
            loadingBubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
            history.appendChild(loadingBubble);
            wrapper.scrollTop = wrapper.scrollHeight;

            try {
                let aiText = '';
                const context = getContextPrompt();

                // Try backend first (more secure - API key hidden)
                if (useBackend) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/chat`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: text, mode: currentMode, context: context })
                        });
                        const data = await response.json();
                        aiText = data.response || 'Sin respuesta del servidor.';
                    } catch (backendError) {
                        console.warn('Backend not available, falling back to direct API');
                        useBackend = false;
                    }
                }

                // Fallback: Direct Gemini API call
                if (!aiText) {
                    let currentKey = apiKey && apiKey.length > 5 ? apiKey : null;
                    if (!currentKey) throw new Error('Falta API Key');

                    const response = await
                        fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${currentKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: context + "\n\nPregunta del usuario: " + text }] }],
                                    generationConfig: {
                                        maxOutputTokens: 4096,
                                        temperature: 0.7
                                    }
                                })
                            });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error.message || 'Error de API');
                    }

                    aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sin respuesta.';
                }

                // Check for portfolio suggestion in the response
                const portfolioMatch = aiText.match(/```portfolio-suggestion\s*([\s\S]*?)```/);
                let suggestionHtml = '';

                if (portfolioMatch) {
                    try {
                        const suggestion = JSON.parse(portfolioMatch[1]);
                        // Remove the code block from displayed text
                        aiText = aiText.replace(/```portfolio-suggestion[\s\S]*?```/, '');

                        // Create apply button and save suggestion globally
                        const suggestionId = 'suggestion-' + Date.now();
                        window[suggestionId] = suggestion;
                        window.lastPortfolioSuggestion = suggestion; // Save for iteration

                        const assetsText = suggestion.assets.map(a => `${a.name}: ${a.percentage}%`).join(', ');

                        suggestionHtml = `
        <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
            <div class="flex items-center gap-2 mb-2">
                <i class="fa-solid fa-lightbulb text-purple-500"></i>
                <span class="font-bold text-purple-700">Sugerencia de Cartera</span>
            </div>
            <div class="text-sm text-slate-600 mb-3">
                ${suggestion.assets.map(a => `<span
                    class="inline-block bg-white px-2 py-1 rounded mr-2 mb-1 border">${a.name}:
                    ${a.percentage}%</span>`).join('')}
            </div>
            <p class="text-xs text-slate-500 mb-3">${suggestion.rationale || ''}</p>
            <div class="flex gap-2">
                <button onclick="iteratePortfolioSuggestion()"
                    class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded-lg font-bold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-pen"></i> Quiero cambios
                </button>
                <button onclick="applySuggestedPortfolio('${suggestionId}')"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold transition shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> Aplicar
                </button>
            </div>
        </div>
        `;
                    } catch (e) {
                        console.error('Error parsing portfolio suggestion:', e);
                    }
                }

                history.removeChild(loadingBubble);
                const aiBubble = document.createElement('div');
                aiBubble.className = `flex flex-col items-start chat-bubble chat-ai shadow-sm prose text-sm`;
                aiBubble.innerHTML = `<div class="font-bold text-xs mb-1 opacity-75"><i class="fa-solid fa-robot"></i> Gemini
        </div>${marked.parse(aiText)}${suggestionHtml}`;
                history.appendChild(aiBubble);
                wrapper.scrollTop = wrapper.scrollHeight;

                // Save chat history
                saveChatHistory();

            } catch (e) {
                history.removeChild(loadingBubble);
                const errorBubble = document.createElement('div');
                errorBubble.className = `flex flex-col items-start chat-bubble chat-ai shadow-sm text-red-500`;
                errorBubble.innerHTML = `<strong>Error:</strong> ${e.message}. Verifica tu configuraci칩n.`;
                history.appendChild(errorBubble);
            }
        }

        function applySuggestedPortfolio(suggestionId) {
            const suggestion = window[suggestionId];
            if (!suggestion || !suggestion.assets) {
                alert('Error: No se pudo obtener la sugerencia.');
                return;
            }

            // Clear current assets and apply suggestion
            customAssets = [];
            const assetColors = {
                "S&P 500": '#10B981',
                "Bitcoin": '#F59E0B',
                "Fondo Liquidez": '#3B82F6',
                "Oro": '#FCD34D',
                "Bonos UI": '#6366F1',
                "Nasdaq 100": '#8B5CF6',
                "Bonos USA": '#94A3B8',
                "Efectivo": '#64748B'
            };

            suggestion.assets.forEach(asset => {
                customAssets.push({
                    name: asset.name,
                    ratio: asset.percentage / 100,
                    color: assetColors[asset.name] || '#64748B'
                });
            });

            // Switch to custom mode if not already
            if (currentMode !== 'custom') {
                setMode('custom');
            }

            renderCustomBuilder();
            updateDashboard();
            saveState();

            // Show success modal instead of alert
            document.getElementById('success-modal').classList.remove('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
        }

        function closeSuccessModalAndScroll() {
            closeSuccessModal();
            scrollToSection('allocation');
        }

        function iteratePortfolioSuggestion() {
            // Get the last suggestion to include context
            const lastSuggestion = window.lastPortfolioSuggestion;
            let portfolioContext = '';

            if (lastSuggestion && lastSuggestion.assets) {
                const assetsText = lastSuggestion.assets.map(a => `${a.name}: ${a.percentage}%`).join(', ');
                portfolioContext = `\n\nTu propuesta actual es: ${assetsText}\n\n`;
            }

            // Pre-fill textarea with context-aware message
            const textarea = document.getElementById('user-input');
            textarea.value = `Me gusta la propuesta, pero quisiera hacerle estos cambios
        espec칤ficos:${portfolioContext}CAMBIOS REQUERIDOS:
        - [ESCRIBE AQU칈 QU칄 QUIERES CAMBIAR, ej: "m치s Bitcoin, menos Bonos"]

        IMPORTANTE: Mant칠n todos los activos que no mencione, solo modifica lo que te pido. Dame la nueva distribuci칩n
        completa con porcentajes que sumen 100%.`;

            autoResizeTextarea(textarea);
            textarea.focus();

            // Select placeholder
            const start = textarea.value.indexOf('[');
            const end = textarea.value.indexOf(']') + 1;
            if (start !== -1 && end > start) {
                textarea.setSelectionRange(start, end);
            }
        }

        function handleEnter(e) {
            // Shift+Enter = nueva l칤nea, Enter solo = enviar
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askGemini();
            }
        }

        function autoResizeTextarea(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set height to scrollHeight (content height), respecting max-height
            const maxHeight = parseInt(textarea.style.maxHeight) || 200;
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = newHeight + 'px';
            // Show scrollbar if content exceeds max-height
            textarea.style.overflowY = textarea.scrollHeight > maxHeight ? 'auto' : 'hidden';
        }

        // --- 6. PERSISTENCE (LocalStorage) ---

        function saveState() {
            const state = {
                currentMode: currentMode,
                currentCapital: currentCapital,
                customAssets: customAssets,
                monthlyContrib: document.getElementById('monthlyContrib').value,
                yearsProj: document.getElementById('yearsProj').value,
                expectedReturn: document.getElementById('expectedReturn').value
            };
            localStorage.setItem('portfolioState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('portfolioState');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    currentCapital = state.currentCapital || 45000;
                    document.getElementById('capitalInput').value = currentCapital;
                    customAssets = state.customAssets || [];
                    document.getElementById('monthlyContrib').value = state.monthlyContrib || 2000;
                    document.getElementById('yearsProj').value = state.yearsProj || 10;
                    if (state.expectedReturn) {
                        document.getElementById('expectedReturn').value = state.expectedReturn;
                    }
                    // Set mode last to trigger full update
                    setMode(state.currentMode || 'normal');
                    if (state.currentMode === 'custom') {
                        renderCustomBuilder();
                    }
                    return true;
                } catch (e) {
                    console.error('Error loading state:', e);
                    return false;
                }
            }
            return false;
        }

        function saveChatHistory() {
            const chatHistory = document.getElementById('chat-history');
            localStorage.setItem('chatHistory', chatHistory.innerHTML);
        }

        function loadChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                document.getElementById('chat-history').innerHTML = saved;
            }
        }

        function clearChatHistory() {
            // Show custom modal instead of browser confirm
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        function confirmClearChat() {
            localStorage.removeItem('chatHistory');
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = `
        <div class="flex flex-col items-start chat-bubble chat-ai shadow-sm">
            <div class="font-bold text-xs text-purple-600 mb-1 flex items-center gap-1">
                <i class="fa-solid fa-robot"></i> Gemini
            </div>
            <span>九 Historial borrado. 쮼n qu칠 puedo ayudarte?</span>
        </div>
        `;
            closeConfirmModal();
        }

        // --- Portfolio Modal Functions ---
        function showClearPortfolioModal() {
            if (customAssets.length === 0) {
                alert('No hay activos para borrar.');
                return;
            }
            document.getElementById('portfolio-modal').classList.remove('hidden');
        }

        function closePortfolioModal() {
            document.getElementById('portfolio-modal').classList.add('hidden');
        }

        function confirmClearPortfolio() {
            customAssets = [];
            renderCustomBuilder();
            updateDashboard();
            saveState();
            closePortfolioModal();
        }

        // --- Reset All Modal Functions ---
        function resetAllData() {
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('reset-modal').classList.add('hidden');
        }

        function confirmResetAll() {
            localStorage.removeItem('portfolioState');
            localStorage.removeItem('chatHistory');
            customAssets = [];
            currentMode = 'normal';
            currentCapital = 45000;
            closeResetModal();
            location.reload();
        }

        // --- 7. EXPORT/IMPORT PORTFOLIO ---

        function exportPortfolio() {
            // Prepare assets object with percentages
            const assetsObj = {};

            if (currentMode === 'custom') {
                if (customAssets && customAssets.length > 0) {
                    customAssets.forEach(asset => {
                        assetsObj[asset.name] = (asset.ratio || 0) * 100;
                    });
                }
            } else if (config[currentMode] && config[currentMode].assets) {
                config[currentMode].assets.forEach(asset => {
                    assetsObj[asset.name] = (asset.ratio || 0) * 100;
                });
            }

            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                mode: currentMode,
                capital: currentCapital,
                assets: assetsObj,
                settings: {
                    monthlyContrib: parseFloat(document.getElementById('monthlyContrib').value) || 2000,
                    yearsProj: parseInt(document.getElementById('yearsProj').value) || 10,
                    expectedReturn: parseFloat(document.getElementById('expectedReturn').value) || 8
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${currentMode}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Portfolio exportado correctamente', '九 Exportado', 'success');
        }

        function importPortfolio(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Validate structure
                    if (!data.mode) {
                        throw new Error('Formato de archivo inv치lido: falta el modo');
                    }

                    // Prepare assets object
                    let importedAssets = {};

                    // Handle custom mode with assets
                    if (data.mode === 'custom' && data.assets && Object.keys(data.assets).length > 0) {
                        // Check if assets are in percentage (0-100) or ratio (0-1)
                        // Our export format uses percentages (0-100)
                        importedAssets = data.assets;
                    } else if ((data.mode === 'normal' || data.mode === 'sovereign') && data.assets) {
                        importedAssets = data.assets;
                    } else if (config[data.mode] && config[data.mode].assets) {
                        // Fallback to default assets if not present in file
                        config[data.mode].assets.forEach(asset => {
                            importedAssets[asset.name] = (asset.ratio || 0) * 100;
                        });
                    }

                    // Create new portfolio object
                    const newPortfolio = {
                        id: generateUUID(),
                        name: `Importado ${new Date().toLocaleDateString()}`, // Default name, user can rename
                        timestamp: Date.now(),
                        data: {
                            mode: data.mode,
                            assets: importedAssets,
                            timestamp: Date.now()
                        }
                    };

                    // Save to storage
                    const portfoliosData = getSavedPortfolios();
                    portfoliosData.portfolios.push(newPortfolio);
                    localStorage.setItem('savedPortfolios', JSON.stringify(portfoliosData));

                    showNotification('Portfolio importado y guardado en tu lista', '九 Importado', 'success');

                    // If in portfolios mode, refresh the grid
                    if (currentMode === 'portfolios') {
                        renderPortfoliosGrid();
                    } else {
                        // Optional: Ask user if they want to go to portfolios view?
                        // For now, let's switch to portfolios view to show the imported item
                        setMode('portfolios');
                    }
                } catch (err) {
                    showNotification('Error al importar: ' + err.message, '仇 Error', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- 8. MULTIPLE PORTFOLIOS MANAGEMENT ---

        // Generate simple UUID
        function generateUUID() {
            return 'portfolio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Get all saved portfolios from localStorage
        function getSavedPortfolios() {
            const stored = localStorage.getItem('savedPortfolios');
            if (!stored) {
                return {
                    portfolios: [],
                    activePortfolioId: null
                };
            }
            return JSON.parse(stored);
        }

        // Get current portfolio state
        function getCurrentPortfolioData() {
            const data = {
                mode: currentMode,
                assets: {},
                timestamp: Date.now()
            };

            console.log('getCurrentPortfolioData - mode:', currentMode);
            console.log('customAssets:', customAssets);

            // Capture asset allocations based on mode
            if (currentMode === 'custom') {
                // Get custom assets from customAssets array
                if (customAssets && customAssets.length > 0) {
                    console.log('customAssets array:', JSON.stringify(customAssets, null, 2));
                    customAssets.forEach((asset, index) => {
                        console.log(`Asset ${index}:`, asset, 'Keys:', Object.keys(asset));
                        // customAssets uses 'ratio' (0-1), convert to percentage (0-100)
                        data.assets[asset.name] = (asset.ratio || 0) * 100;
                    });
                }
                console.log('Custom mode - captured assets:', data.assets);
            } else if (currentMode === 'normal' || currentMode === 'sovereign') {
                // Get predefined mode allocations from config
                const modeConfig = config[currentMode];
                if (modeConfig && modeConfig.allocation) {
                    Object.keys(modeConfig.allocation).forEach(key => {
                        if (modeConfig.allocation[key] > 0) {
                            data.assets[key] = modeConfig.allocation[key];
                        }
                    });
                }
                console.log('Predefined mode - captured assets:', data.assets);
            }

            return data;
        }

        // Save portfolio to localStorage
        function savePortfolioToStorage(name, data) {
            const portfolios = getSavedPortfolios();

            const newPortfolio = {
                id: generateUUID(),
                name: name,
                timestamp: Date.now(),
                data: data
            };

            portfolios.portfolios.push(newPortfolio);
            portfolios.activePortfolioId = newPortfolio.id;

            localStorage.setItem('savedPortfolios', JSON.stringify(portfolios));
            return newPortfolio.id;
        }

        // Load portfolio by ID
        function loadPortfolio(id) {
            const portfolios = getSavedPortfolios();
            const portfolio = portfolios.portfolios.find(p => p.id === id);

            if (!portfolio) {
                console.error('Portfolio not found:', id);
                return false;
            }

            // Set mode
            setMode(portfolio.data.mode);

            // Apply allocations
            if (portfolio.data.mode === 'custom') {
                // Load custom assets - convert percentage (0-100) to ratio (0-1)
                customAssets = Object.keys(portfolio.data.assets).map((name, index) => ({
                    name: name,
                    ratio: (portfolio.data.assets[name] || 0) / 100,
                    color: getAssetColor(name, index)
                }));
                renderCustomBuilder();
            } else {
                // Load predefined allocations
                allocation = { ...portfolio.data.assets };
            }

            // Update dashboard
            updateDashboard();

            // Mark as active
            portfolios.activePortfolioId = id;
            localStorage.setItem('savedPortfolios', JSON.stringify(portfolios));

            return true;
        }

        // Delete portfolio by ID
        function deletePortfolio(id) {
            const portfolios = getSavedPortfolios();
            portfolios.portfolios = portfolios.portfolios.filter(p => p.id !== id);

            // If deleted portfolio was active, clear active
            if (portfolios.activePortfolioId === id) {
                portfolios.activePortfolioId = null;
            }

            localStorage.setItem('savedPortfolios', JSON.stringify(portfolios));
            renderPortfolioList();
        }

        // Rename portfolio
        function renamePortfolio(id, newName) {
            const portfolios = getSavedPortfolios();
            const portfolio = portfolios.portfolios.find(p => p.id === id);

            if (portfolio) {
                portfolio.name = newName;
                localStorage.setItem('savedPortfolios', JSON.stringify(portfolios));
                renderPortfolioList();
            }
        }

        // Render portfolio list (placeholder - will be implemented in Phase 3)
        function renderPortfolioList() {
            const container = document.getElementById('portfolio-list-container');
            if (!container) return;

            const portfoliosData = getSavedPortfolios();
            const portfolios = portfoliosData.portfolios;

            // Update badge count
            const badge = document.getElementById('portfolio-count-badge');
            if (badge && portfolios.length > 0) {
                badge.textContent = portfolios.length;
                badge.classList.remove('hidden');
            } else if (badge) {
                badge.classList.add('hidden');
            }

            if (portfolios.length === 0) {
                container.innerHTML = `
        <div class="p-6 text-center text-slate-400">
            <i class="fa-solid fa-folder-open text-4xl mb-2"></i>
            <p class="text-sm">No tienes portfolios guardados</p>
            <p class="text-xs mt-1">Configura tu cartera y presiona "Guardar"</p>
        </div>
        `;
                return;
            }

            // Sort by most recent
            const sorted = [...portfolios].sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = sorted.map(portfolio => {
                const isActive = portfolio.id === portfoliosData.activePortfolioId;
                const date = new Date(portfolio.timestamp);
                const timeAgo = getTimeAgo(date);

                return `
                    <div class="portfolio-item p-3 hover:bg-slate-50 border-b border-slate-100 cursor-pointer transition ${isActive ? 'bg-green-50 border-l-4 border-l-green-500' : ''}"
                        onclick="loadPortfolio('${portfolio.id}'); togglePortfolioDropdown();">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-slate-800 flex items-center gap-2">
                                    ${portfolio.name}
                                    ${isActive ? '<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">Activo</span>' : ''}
                                </div>
                                <div class="text-xs text-slate-500 mt-1">
                                    <i class="fa-solid fa-clock mr-1"></i>${timeAgo} 
                                    <span class="capitalize">${portfolio.data.mode}</span>
                                </div>
                            </div>
                            <div class="flex gap-1" onclick="event.stopPropagation()">
                                <button onclick="showRenamePrompt('${portfolio.id}', '${portfolio.name.replace(/'/g, "\\'")}')"
                                    class="text-slate-400 hover:text-blue-600 p-1.5 rounded hover:bg-blue-50 transition"
                                    title="Renombrar">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                                <button onclick="confirmDeletePortfolio('${portfolio.id}', '${portfolio.name.replace(/'/g, "\\'")}')"
                                    class="text-slate-400 hover:text-red-600 p-1.5 rounded hover:bg-red-50 transition"
                                    title="Eliminar">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get "time ago" string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                a침o: 31536000,
                mes: 2592000,
                semana: 604800,
                d칤a: 86400,
                hora: 3600,
                minuto: 60
            };

            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) {
                    return `Hace ${interval} ${name}${interval > 1 ? (name === 'mes' ? 'es' : 's') : ''} `;
                }
            }
            return 'Reci칠n';
        }

        // Modal functions
        function openSaveModal() {
            const modal = document.getElementById('save-portfolio-modal');
            const input = document.getElementById('portfolio-name-input');
            if (modal && input) {
                modal.classList.remove('hidden');
                input.value = '';
                setTimeout(() => input.focus(), 100);
            }
        }

        function closeSaveModal() {
            const modal = document.getElementById('save-portfolio-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function confirmSavePortfolio() {
            const input = document.getElementById('portfolio-name-input');
            const name = input?.value.trim();

            if (!name) {
                showNotification('Por favor ingresa un nombre para tu portfolio', 'Nombre requerido', 'warning');
                return;
            }

            // Get current portfolio data
            const data = getCurrentPortfolioData();

            // Save to localStorage
            const id = savePortfolioToStorage(name, data);

            // Close modal
            closeSaveModal();

            // Update list
            renderPortfolioList();

            // Show success message
            showNotification(`Portfolio "${name}" guardado correctamente`, '九 Guardado', 'success');

            // Render grid if in portfolios mode
            if (currentMode === 'portfolios') {
                renderPortfoliosGrid();
            }
        }

        // Dropdown functions
        function togglePortfolioDropdown() {
            const dropdown = document.getElementById('portfolios-dropdown');
            if (!dropdown) return;

            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                renderPortfolioList();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('portfolios-dropdown');
            const btn = document.getElementById('portfolios-dropdown-btn');
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });





        // Export single portfolio as JSON
        function exportSinglePortfolio(id) {
            const portfoliosData = getSavedPortfolios();
            const portfolio = portfoliosData.portfolios.find(p => p.id === id);

            if (!portfolio) {
                showNotification('Portfolio no encontrado', 'Error', 'error');
                return;
            }

            // Create export object with just the data
            const exportData = {
                ...portfolio.data,
                savedAt: portfolio.timestamp
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${portfolio.name.replace(/[^a-z0-9]/gi, '_')}_portfolio.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification(`Portfolio "${portfolio.name}" exportado correctamente`, '九 Exportado', 'success');
        }

        // Trigger import from portfolios section
        function triggerImportPortfolio() {
            document.getElementById('import-input')?.click();
        }

        // Load portfolio and switch to its mode
        function loadPortfolioAndSwitch(id) {
            if (loadPortfolio(id)) {
                showNotification('Portfolio cargado correctamente', '九 칄xito', 'success');
            }
        }

        // Lightweight Toast Notification (non-blocking feedback)
        function showToast(message, type = 'success') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 z-50 px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 transition-all duration-300';

            // Style based on type
            const styles = {
                success: { bg: 'rgba(34,197,94,0.95)', icon: 'fa-check-circle', color: '#fff' },
                error: { bg: 'rgba(239,68,68,0.95)', icon: 'fa-times-circle', color: '#fff' },
                warning: { bg: 'rgba(251,191,36,0.95)', icon: 'fa-exclamation-circle', color: '#0B0F14' },
                info: { bg: 'rgba(59,130,246,0.95)', icon: 'fa-info-circle', color: '#fff' }
            };
            const style = styles[type] || styles.success;

            toast.style.cssText = `background: ${style.bg}; color: ${style.color}; backdrop-filter: blur(10px);`;
            toast.innerHTML = `
                <i class="fa-solid ${style.icon}"></i>
                <span class="text-sm font-medium">${message}</span>
            `;

            document.body.appendChild(toast);

            // Animate in
            toast.style.transform = 'translateX(100%)';
            toast.style.opacity = '0';
            requestAnimationFrame(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            });

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Beautiful Notification Modal (replaces alert)
        function showNotification(message, title = 'Notificaci칩n', type = 'success') {
            const modal = document.getElementById('notification-modal');
            const icon = document.getElementById('notification-icon');
            const iconContent = document.getElementById('notification-icon-content');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            const btn = document.getElementById('notification-btn');

            if (!modal) return;

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;

            // Set style based on type
            if (type === 'success') {
                icon.className = 'w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4';
                iconContent.className = 'fa-solid fa-check text-green-500 text-2xl';
                btn.className = 'w-full px-6 py-2.5 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition shadow-lg shadow-green-500/30';
            } else if (type === 'error') {
                icon.className = 'w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4';
                iconContent.className = 'fa-solid fa-xmark text-red-500 text-2xl';
                btn.className = 'w-full px-6 py-2.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition shadow-lg shadow-red-500/30';
            } else if (type === 'warning') {
                icon.className = 'w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4';
                iconContent.className = 'fa-solid fa-exclamation text-yellow-500 text-2xl';
                btn.className = 'w-full px-6 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-xl transition shadow-lg shadow-yellow-500/30';
            } else {  // info
                icon.className = 'w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4';
                iconContent.className = 'fa-solid fa-info text-blue-500 text-2xl';
                btn.className = 'w-full px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition shadow-lg shadow-blue-500/30';
            }

            modal.classList.remove('hidden');
        }

        function closeNotification() {
            const modal = document.getElementById('notification-modal');
            if (modal) modal.classList.add('hidden');
        }

        // Beautiful Confirmation Modal (replaces confirm)
        let confirmationCallback = null;

        function showConfirmation(message, title = '쮼st치s seguro?', onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const titleEl = document.getElementById('confirmation-title');
            const messageEl = document.getElementById('confirmation-message');
            const btn = document.getElementById('confirmation-btn');

            if (!modal) return;

            titleEl.textContent = title;
            messageEl.textContent = message;

            confirmationCallback = onConfirm;

            btn.onclick = function () {
                if (confirmationCallback) confirmationCallback();
                cancelConfirmation();
            };

            modal.classList.remove('hidden');
        }

        function cancelConfirmation() {
            const modal = document.getElementById('confirmation-modal');
            if (modal) modal.classList.add('hidden');
            confirmationCallback = null;
        }

        // Render Portfolios Grid (for dedicated section)
        function renderPortfoliosGrid() {
            const grid = document.getElementById('portfolios-grid');
            const emptyState = document.getElementById('portfolios-empty-state');
            const countEl = document.getElementById('total-portfolios-count');

            if (!grid) return;

            const portfoliosData = getSavedPortfolios();
            const portfolios = portfoliosData.portfolios;

            if (countEl) countEl.textContent = portfolios.length;

            if (portfolios.length === 0) {
                grid.classList.add('hidden');
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            if (emptyState) emptyState.classList.add('hidden');

            // Sort by most recent
            const sorted = [...portfolios].sort((a, b) => b.timestamp - a.timestamp);

            grid.innerHTML = sorted.map(portfolio => {
                const isActive = portfolio.id === portfoliosData.activePortfolioId;
                const date = new Date(portfolio.timestamp);
                const timeAgo = getTimeAgo(date);

                // Get emoji based on mode
                const modeEmojis = {
                    'normal': '游꺔',
                    'sovereign': '游녬',
                    'custom': '游꿛'
                };
                const emoji = modeEmojis[portfolio.data.mode] || '游늵';

                return `
                    <div class="card p-5 hover:shadow-xl transition cursor-pointer ${isActive ? 'ring-2 ring-green-500' : ''}" onclick="loadPortfolioAndSwitch('${portfolio.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <div class="text-3xl">${emoji}</div>
                            ${isActive ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full">Activo</span>' : ''}
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 mb-1 truncate">${portfolio.name}</h3>
                        <p class="text-sm text-slate-500 mb-4 capitalize">${portfolio.data.mode}</p>
                        <div class="text-xs text-slate-400 mb-4">
                            <i class="fa-solid fa-clock mr-1"></i>${timeAgo}
                        </div>
                        <div class="flex gap-2" onclick="event.stopPropagation()">
                            <button onclick="exportSinglePortfolio('${portfolio.id}')" class="flex-1 px-3 py-1.5 bg-purple-50 hover:bg-purple-100 text-purple-600 rounded-lg transition text-xs font-semibold" title="Exportar">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <button onclick="openEditModal('${portfolio.id}')" class="flex-1 px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg transition text-xs font-semibold" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="confirmDeletePortfolioNew('${portfolio.id}', '${portfolio.name.replace(/'/g, "\\'")}')" class="flex-1 px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition text-xs font-semibold" title="Eliminar">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Export single portfolio as JSON
        function exportSinglePortfolio(id) {
            const portfoliosData = getSavedPortfolios();
            const portfolio = portfoliosData.portfolios.find(p => p.id === id);

            if (!portfolio) {
                showNotification('Portfolio no encontrado', 'Error', 'error');
                return;
            }

            // Create export object with just the data
            const exportData = {
                ...portfolio.data,
                savedAt: portfolio.timestamp
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${portfolio.name.replace(/[^a-z0-9]/gi, '_')} _portfolio.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification(`Portfolio "${portfolio.name}" exportado correctamente`, '九 Exportado', 'success');
        }

        // Trigger import from portfolios section
        function triggerImportPortfolio() {
            document.getElementById('import-input')?.click();
        }

        // Load portfolio and switch to its mode
        function loadPortfolioAndSwitch(id) {
            if (loadPortfolio(id)) {
                showNotification('Portfolio cargado correctamente', '九 칄xito', 'success');
            }
        }

        // New confirm delete with beautiful modal
        function confirmDeletePortfolioNew(id, name) {
            showConfirmation(
                `Portfolio "${name}" ser치 eliminado permanentemente`,
                '쮼liminar portfolio?',
                () => {
                    deletePortfolio(id);
                    renderPortfoliosGrid();
                    showNotification(`Portfolio "${name}" eliminado`, '九 Eliminado', 'success');
                }
            );
        }

        // Show/hide portfolio buttons based on mode
        function updatePortfolioButtonsVisibility() {
            const saveBtn = document.getElementById('save-portfolio-btn');

            // Show save button in all modes except simulador and portfolios
            const isPortfolioMode = currentMode !== 'simulador' && currentMode !== 'portfolios';

            if (saveBtn) {
                if (isPortfolioMode) {
                    saveBtn.classList.remove('hidden');
                    saveBtn.classList.add('flex');
                } else {
                    saveBtn.classList.add('hidden');
                    saveBtn.classList.remove('flex');
                }
            }
        }

        // --- EDIT PORTFOLIO MODAL FUNCTIONS ---

        function openCreatePortfolioModal() {
            document.getElementById('edit-portfolio-id').value = ''; // Empty ID means new portfolio
            document.getElementById('edit-portfolio-name').value = '';
            document.querySelector('#edit-portfolio-modal h3').textContent = 'Crear Nuevo Portfolio';

            const list = document.getElementById('edit-assets-list');
            list.innerHTML = '';

            // Add initial empty row
            addAssetToEdit();
            updateEditTotal();

            document.getElementById('edit-portfolio-modal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const portfoliosData = getSavedPortfolios();
            const portfolio = portfoliosData.portfolios.find(p => p.id === id);

            if (!portfolio) return;

            document.getElementById('edit-portfolio-id').value = id;
            document.getElementById('edit-portfolio-name').value = portfolio.name;
            document.querySelector('#edit-portfolio-modal h3').textContent = 'Editar Portfolio';

            const list = document.getElementById('edit-assets-list');
            list.innerHTML = '';

            // Convert assets to array for rendering
            const assets = Object.keys(portfolio.data.assets).map(key => ({
                name: key,
                percentage: portfolio.data.assets[key]
            }));

            if (assets.length === 0) {
                // Add one empty row if no assets
                addAssetToEdit();
            } else {
                assets.forEach(asset => addAssetRow(asset.name, asset.percentage));
            }

            updateEditTotal();
            document.getElementById('edit-portfolio-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-portfolio-modal').classList.add('hidden');
        }

        function addAssetToEdit() {
            addAssetRow('', 0);
        }

        function addAssetRow(name, percentage) {
            const list = document.getElementById('edit-assets-list');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center asset-row';
            div.innerHTML = `
                <input type="text" placeholder="Nombre Activo" value="${name}" class="flex-grow px-3 py-2 border border-slate-300 rounded-lg text-sm asset-name">
                <div class="relative w-24">
                    <input type="number" placeholder="%" value="${percentage}" min="0" max="100" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm asset-pct" oninput="updateEditTotal()">
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs">%</span>
                </div>
                <button onclick="this.parentElement.remove(); updateEditTotal()" class="text-red-400 hover:text-red-600 p-2">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        function updateEditTotal() {
            const inputs = document.querySelectorAll('.asset-pct');
            let total = 0;
            inputs.forEach(input => total += parseFloat(input.value) || 0);

            const totalEl = document.getElementById('edit-total-percentage');
            totalEl.textContent = `Total: ${total.toFixed(1)}%`;

            if (Math.abs(total - 100) < 0.1) {
                totalEl.className = 'text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-600';
            } else {
                totalEl.className = 'text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-600';
            }
        }

        function saveEditedPortfolio() {
            const id = document.getElementById('edit-portfolio-id').value;
            const name = document.getElementById('edit-portfolio-name').value.trim();

            if (!name) {
                showNotification('El nombre es obligatorio', 'Error', 'error');
                return;
            }

            const rows = document.querySelectorAll('.asset-row');
            const newAssets = {};
            let total = 0;

            rows.forEach(row => {
                const assetName = row.querySelector('.asset-name').value.trim();
                const assetPct = parseFloat(row.querySelector('.asset-pct').value) || 0;

                if (assetName && assetPct > 0) {
                    newAssets[assetName] = assetPct;
                    total += assetPct;
                }
            });

            if (Math.abs(total - 100) > 0.5) {
                showNotification(`El total debe ser 100 % (actual: ${total.toFixed(1)}%)`, 'Error de suma', 'warning');
                return;
            }

            const portfoliosData = getSavedPortfolios();

            if (id) {
                // EDIT EXISTING PORTFOLIO
                const index = portfoliosData.portfolios.findIndex(p => p.id === id);
                if (index !== -1) {
                    portfoliosData.portfolios[index].name = name;
                    portfoliosData.portfolios[index].data.assets = newAssets;
                    portfoliosData.portfolios[index].data.mode = 'custom';

                    localStorage.setItem('savedPortfolios', JSON.stringify(portfoliosData));
                    showNotification('Portfolio actualizado correctamente', '九 Guardado', 'success');
                }
            } else {
                // CREATE NEW PORTFOLIO
                const newPortfolio = {
                    id: generateUUID(),
                    name: name,
                    timestamp: Date.now(),
                    data: {
                        mode: 'custom',
                        assets: newAssets,
                        timestamp: Date.now()
                    }
                };
                portfoliosData.portfolios.push(newPortfolio);
                localStorage.setItem('savedPortfolios', JSON.stringify(portfoliosData));
                showNotification('Nuevo portfolio creado correctamente', '九 Creado', 'success');
            }

            closeEditModal();
            renderPortfoliosGrid();
        }

        // --- 9. AUTO-SAVE ON CHANGES ---

        // Wrap updateDashboard to auto-save
        const originalUpdateDashboard = updateDashboard;
        updateDashboard = function () {
            originalUpdateDashboard();
            saveState();
        };

        // Wrap updateProjection to auto-save
        const originalUpdateProjection = updateProjection;
        updateProjection = function () {
            originalUpdateProjection();
            saveState();
        };

        // Save chat after each message
        const originalAskGemini = askGemini;
        askGemini = async function (presetText = null) {
            await originalAskGemini(presetText);
            saveChatHistory();
        };

        // --- 9. SIMULADOR DE INTER칄S COMPUESTO (MULTIPLE SCENARIOS) ---

        let simChart = null;
        let scenarios = [
            {
                id: 1,
                name: 'Escenario 1',
                asset: 'sp500',
                capital: 45000,
                aporte: 2000,
                years: 10,
                rate: 10,
                color: '#3B82F6' // Blue
            }
        ];
        let nextScenarioId = 2;

        const scenarioColors = ['#3B82F6', '#10B981', '#F59E0B']; // Blue, Green, Orange

        const simAssetData = {
            sp500: { name: 'S&P 500', rate: 9, volatility: 15, currency: 'USD', emoji: '游늳' },
            nasdaq: { name: 'Nasdaq 100', rate: 12, volatility: 20, currency: 'USD', emoji: '游눹' },
            vt: { name: 'Total World (VT)', rate: 7.5, volatility: 14, currency: 'USD', emoji: '游깴' },
            bitcoin: { name: 'Bitcoin', rate: 15, volatility: 70, currency: 'USD', emoji: '' },
            ethereum: { name: 'Ethereum', rate: 14, volatility: 80, currency: 'USD', emoji: '具' },
            solana: { name: 'Solana', rate: 16, volatility: 100, currency: 'USD', emoji: '餃' },
            smh: { name: 'Semiconductores (SMH)', rate: 14, volatility: 35, currency: 'USD', emoji: '游뱄' },
            schd: { name: 'Dividendos (SCHD)', rate: 8, volatility: 12, currency: 'USD', emoji: '游눶' },
            vnq: { name: 'Real Estate (VNQ)', rate: 8.5, volatility: 18, currency: 'USD', emoji: '游끽' },
            vwo: { name: 'Emergentes (VWO)', rate: 8, volatility: 22, currency: 'USD', emoji: '游깶' },
            fondoLiquidez: { name: 'Fondo Liquidez UYU', rate: 8, volatility: 5, currency: 'UYU', emoji: '游낁' },
            bonosUI: { name: 'Bonos UI Uruguay', rate: 10, volatility: 8, currency: 'UI', emoji: '游닆' },
            bonosTesoro: { name: 'Bonos USA (TLT)', rate: 4, volatility: 10, currency: 'USD', emoji: '游쥟릖' },
            gold: { name: 'Oro', rate: 5, volatility: 15, currency: 'USD', emoji: '游볞' },
            silver: { name: 'Plata', rate: 6, volatility: 25, currency: 'USD', emoji: '游볟' },
            cash: { name: 'Efectivo', rate: 0, volatility: 0, currency: 'USD', emoji: '游눳' },
            custom_rate: { name: 'Personalizado', rate: 10, volatility: 20, currency: 'Var', emoji: '丘뙖잺' }
        };

        // ALIASES FOR COMPATIBILITY (Map "S&P 500" -> sp500 object)
        // This ensures config object keys (which are names) resolve correctly
        Object.keys(simAssetData).forEach(key => {
            const asset = simAssetData[key];
            if (asset.name && !simAssetData[asset.name]) {
                simAssetData[asset.name] = asset;
            }
        });

        function addScenario() {
            console.log('addScenario called, current scenarios:', scenarios.length);

            if (scenarios.length >= 3) {
                alert('M치ximo 3 escenarios para comparar');
                return;
            }

            // Get current values from scenario 1
            const baseScenario = scenarios[0];

            const newScenario = {
                id: nextScenarioId++,
                name: `Escenario ${scenarios.length + 1}`,
                asset: 'btc', // Default to Bitcoin for comparison
                capital: baseScenario.capital,
                aporte: baseScenario.aporte,
                years: baseScenario.years,
                rate: 30, // Bitcoin's default rate
                color: scenarioColors[scenarios.length]
            };

            scenarios.push(newScenario);
            console.log('Scenario added! New scenarios array:', scenarios);
            console.log('Array now has', scenarios.length, 'scenarios');

            renderScenarios();
        }

        function removeScenario(id) {
            if (scenarios.length <= 1) {
                alert('Debe haber al menos un escenario');
                return;
            }
            scenarios = scenarios.filter(s => s.id !== id);
            renderScenarios();
            updateAllSimulations();
        }

        // ===== SIMULATOR MODE TOGGLE =====
        let simMode = 'asset'; // 'asset' or 'strategy'
        let selectedSimStrategy = 'normal';

        function setSimMode(mode) {
            simMode = mode;

            const assetBtn = document.getElementById('sim-mode-asset');
            const strategyBtn = document.getElementById('sim-mode-strategy');
            const assetSection = document.getElementById('sim-asset-section');
            const strategySection = document.getElementById('sim-strategy-section');
            const customInput = document.getElementById('custom-asset-input');

            if (mode === 'asset') {
                assetBtn.className = 'py-2 px-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm transition shadow-sm hover:shadow-md';
                strategyBtn.className = 'py-2 px-4 rounded-xl border-2 border-slate-200 bg-white text-slate-600 font-bold text-sm transition hover:border-blue-300 hover:shadow-md';
                if (assetSection) assetSection.classList.remove('hidden');
                if (strategySection) strategySection.classList.add('hidden');
            } else {
                assetBtn.className = 'py-2 px-4 rounded-xl border-2 border-slate-200 bg-white text-slate-600 font-bold text-sm transition hover:border-blue-300 hover:shadow-md';
                strategyBtn.className = 'py-2 px-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm transition shadow-sm hover:shadow-md';
                if (assetSection) assetSection.classList.add('hidden');
                if (strategySection) strategySection.classList.remove('hidden');
                if (customInput) customInput.classList.add('hidden');

                // Calculate and display strategy returns
                updateSimStrategyReturns();
                selectSimStrategy(selectedSimStrategy);
            }
        }

        function updateSimStrategyReturns() {
            // Calculate weighted returns for each strategy
            const strategies = {
                normal: { sp500: 60, fondoLiquidez: 40 },
                sovereign: { bitcoin: 35, sp500: 45, fondoLiquidez: 20 },
                custom: currentAllocation
            };

            const assetReturns = {
                bitcoin: 30, sp500: 10, nasdaq: 12, ethereum: 25, solana: 35,
                gold: 7, fondoLiquidez: 8, bonosTesoro: 4.5, bonosUI: 8.5
            };

            for (const [strategyKey, allocation] of Object.entries(strategies)) {
                let weightedReturn = 0;
                for (const [asset, pct] of Object.entries(allocation)) {
                    const rate = assetReturns[asset] || simAssetData[asset]?.rate || 8;
                    weightedReturn += (pct / 100) * rate;
                }

                const displayEl = document.getElementById(`sim-${strategyKey === 'custom' ? 'custom' : strategyKey}-return`);
                if (displayEl) {
                    displayEl.textContent = `~${weightedReturn.toFixed(1)}% anual`;
                }
            }
        }

        function selectSimStrategy(strategyKey) {
            selectedSimStrategy = strategyKey;

            // Strategy definitions
            const strategies = {
                normal: { sp500: 60, fondoLiquidez: 40 },
                sovereign: { bitcoin: 35, sp500: 45, fondoLiquidez: 20 },
                custom: currentAllocation
            };

            const strategyNames = {
                normal: 'Normie',
                sovereign: 'Soberano',
                custom: 'Personalizado'
            };

            // Update button styling
            document.querySelectorAll('.sim-strategy-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-slate-200', 'bg-white');
            });

            const selectedBtn = document.getElementById(`sim-strategy-${strategyKey}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-slate-200', 'bg-white');
                selectedBtn.classList.add('border-blue-500', 'bg-blue-50');
            }

            // Calculate weighted return
            const allocation = strategies[strategyKey] || {};
            const assetReturns = {
                bitcoin: 30, sp500: 10, nasdaq: 12, ethereum: 25, solana: 35,
                gold: 7, fondoLiquidez: 8, bonosTesoro: 4.5, bonosUI: 8.5
            };

            let weightedReturn = 0;
            const compositionParts = [];

            for (const [asset, pct] of Object.entries(allocation)) {
                if (pct > 0) {
                    const rate = assetReturns[asset] || simAssetData[asset]?.rate || 8;
                    weightedReturn += (pct / 100) * rate;

                    const assetNames = {
                        bitcoin: 'Bitcoin', sp500: 'S&P 500', nasdaq: 'Nasdaq',
                        ethereum: 'Ethereum', solana: 'Solana', gold: 'Oro',
                        fondoLiquidez: 'Fondo Liquidez', bonosTesoro: 'Bonos USA', bonosUI: 'Bonos UI'
                    };
                    compositionParts.push(`${assetNames[asset] || asset}: ${pct}% `);
                }
            }

            // Update composition preview
            const compositionEl = document.getElementById('sim-strategy-composition');
            if (compositionEl) {
                compositionEl.textContent = compositionParts.length > 0
                    ? compositionParts.join(' | ')
                    : 'Sin asignaci칩n definida';
            }

            // Update rate slider and scenario
            const rateSlider = document.getElementById('sim-rate');
            const rateDisplay = document.getElementById('sim-rate-display');
            if (rateSlider && rateDisplay) {
                rateSlider.value = Math.round(weightedReturn);
                rateDisplay.textContent = Math.round(weightedReturn) + '%';
            }

            // Update scenario 1 with strategy data
            const scenario = scenarios.find(s => s.id === 1);
            if (scenario) {
                scenario.asset = `strategy_${strategyKey} `;
                scenario.rate = Math.round(weightedReturn);
                scenario.customName = `Estrategia ${strategyNames[strategyKey]} `;
            }

            updateAllSimulations();
        }

        function selectSimAsset(scenarioId, assetKey) {
            const scenario = scenarios.find(s => s.id === scenarioId);
            if (!scenario) return;

            scenario.asset = assetKey;
            scenario.name = `Escenario ${scenarioId} `;

            // Update Title UI
            const titleEl = document.getElementById(`scenario-title-${scenarioId}`);
            if (titleEl) {
                const numberSpan = titleEl.querySelector('span');
                titleEl.innerHTML = '';
                if (numberSpan) titleEl.appendChild(numberSpan);
                titleEl.appendChild(document.createTextNode(` Escenario ${scenarioId} `));
            }

            const asset = simAssetData[assetKey];

            // Update rate if not custom
            if (assetKey !== 'custom_rate') {
                scenario.rate = asset.rate;
            }

            // Update card UI
            const card = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (card) {
                // Update all asset buttons in this card
                card.querySelectorAll('.sim-asset-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-slate-200', 'bg-white');
                });

                // Find selected button (unified format)
                const selectedBtn = card.querySelector(`#sim-btn-${assetKey}-${scenarioId}`);

                if (selectedBtn) {
                    selectedBtn.classList.remove('border-slate-200', 'bg-white');
                    selectedBtn.classList.add('border-blue-500', 'bg-blue-50');
                }

                // Update rate display for scenario 1
                if (scenarioId === 1) {
                    const rateSlider = document.getElementById('sim-rate');
                    const rateDisplay = document.getElementById('sim-rate-display');
                    if (rateSlider && rateDisplay) {
                        rateSlider.value = scenario.rate;
                        rateDisplay.textContent = scenario.rate + '%';
                    }
                } else {
                    // Update for scenarios 2-3
                    const rateSlider = card.querySelector('.sim-rate');
                    const rateDisplay = card.querySelector('.sim-rate-display');
                    if (rateSlider && rateDisplay) {
                        rateSlider.value = scenario.rate;
                        rateDisplay.textContent = scenario.rate + '%';
                    }
                }

                // Show/hide custom input (only for scenario 1)
                if (scenarioId === 1) {
                    const customInput = document.getElementById('custom-asset-input');
                    if (customInput) {
                        if (assetKey === 'custom_rate') {
                            customInput.classList.remove('hidden');
                        } else {
                            customInput.classList.add('hidden');
                        }
                    }
                }
            }

            updateAllSimulations();
        }

        function updateScenarioData(scenarioId, field, value) {
            const scenario = scenarios.find(s => s.id === scenarioId);
            if (!scenario) return;
            scenario[field] = parseFloat(value) || 0;
            updateAllSimulations();
        }

        function calcCompoundInterest(principal, monthlyContrib, annualRate, years) {
            const monthlyRate = annualRate / 100 / 12;
            const months = years * 12;

            if (monthlyRate === 0) {
                return principal + (monthlyContrib * months);
            }

            const fvPrincipal = principal * Math.pow(1 + monthlyRate, months);
            const fvContribs = monthlyContrib * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);

            return fvPrincipal + fvContribs;
        }

        function calculateScenario(scenario) {
            const maxYears = Math.max(...scenarios.map(s => s.years));
            const yearlyData = [];
            const labels = [];

            for (let y = 0; y <= maxYears; y++) {
                if (y <= scenario.years) {
                    const
                        value = calcCompoundInterest(scenario.capital, scenario.aporte, scenario.rate, y);
                    yearlyData.push(value);
                } else { yearlyData.push(null); } if (labels.length <= y) {
                    labels.push(y === 0
                        ? 'Inicio' : `A침o ${y} `);
                }
            } const finalValue = calcCompoundInterest(scenario.capital,
                scenario.aporte, scenario.rate, scenario.years); const totalInvested = scenario.capital +
                    (scenario.aporte * 12 * scenario.years); const gain = finalValue - totalInvested; const
                        roi = totalInvested > 0 ? ((gain / totalInvested) * 100) : 0;

            return {
                yearlyData,
                labels,
                finalValue,
                totalInvested,
                gain,
                roi
            };
        }

        function updateAllSimulations() {
            console.log('updateAllSimulations called with', scenarios.length, 'scenarios');

            // Calculate all scenarios
            const results = scenarios.map(s => ({
                scenario: s,
                ...calculateScenario(s)
            }));

            // Update each scenario card with its results
            results.forEach(result => {
                let finalEl, gainEl, investedEl, roiEl;

                if (result.scenario.id === 1) {
                    finalEl = document.getElementById('sim-result-final-1');
                    gainEl = document.getElementById('sim-result-gain-1');
                    investedEl = document.getElementById('sim-result-invested-1');
                    roiEl = document.getElementById('sim-result-roi-1');
                } else {
                    const card = document.querySelector(`[data-scenario-id="${result.scenario.id}"]`);
                    if (card) {
                        finalEl = card.querySelector('.sim-result-final');
                        gainEl = card.querySelector('.sim-result-gain');
                        investedEl = card.querySelector('.sim-result-invested');
                        roiEl = card.querySelector('.sim-result-roi');
                    }
                }

                if (finalEl) finalEl.textContent = formatCurrency(result.finalValue);
                if (gainEl) gainEl.textContent = formatCurrency(result.gain);
                if (investedEl) investedEl.textContent = formatCurrency(result.totalInvested);
                if (roiEl) roiEl.textContent = result.roi.toFixed(1) + '%';
            });

            // Update comparison chart
            updateComparisonChart(results);
            // Update comparison table
            updateComparisonTable(results);
        }

        function getAssetName(assetKey) {
            if (!assetKey) return 'Desconocido';
            if (assetKey.startsWith('strategy_')) {
                const strategy = assetKey.replace('strategy_', '');
                const names = { normal: 'Normie', sovereign: 'Soberano', custom: 'Personalizado' };
                return names[strategy] || strategy;
            }
            return simAssetData[assetKey]?.name || assetKey;
        }

        function getAssetEmoji(assetKey) {
            if (!assetKey) return '仇';
            if (assetKey.startsWith('strategy_')) {
                const strategy = assetKey.replace('strategy_', '');
                const emojis = { normal: '游꿢', sovereign: '游댏', custom: '九' };
                return emojis[strategy] || '游늵';
            }
            return simAssetData[assetKey]?.emoji || '游눯';
        }

        function updateComparisonChart(results) {
            console.log('updateComparisonChart called with', results.length, 'scenarios');

            const ctx = document.getElementById('simChart');
            if (!ctx) {
                console.error('simChart canvas not found!');
                return;
            }

            if (simChart) {
                simChart.destroy();
            }

            const maxYears = Math.max(...scenarios.map(s => s.years));
            const labels = [];
            for (let y = 0; y <= maxYears; y++) { labels.push(y === 0 ? 'Inicio' : `A침o ${y} `); } const
                datasets = results.map(result => {
                    const assetName = getAssetName(result.scenario.asset);
                    console.log(`Creating dataset for ${result.scenario.name} with color ${result.scenario.color} `);
                    return {
                        label: `${result.scenario.name} (${assetName})`,
                        data: result.yearlyData,
                        borderColor: result.scenario.color,
                        backgroundColor: result.scenario.color + '20',
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0.4
                    };
                });

            console.log('Creating chart with', datasets.length, 'datasets');

            simChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10,
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#e2e8f0',
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            console.log('Chart created successfully');
        }

        function updateComparisonTable(results) {
            const tbody = document.getElementById('comparison-tbody');
            if (!tbody) return;

            tbody.innerHTML = results.map((result, idx) => {
                const s = result.scenario;
                const assetName = getAssetName(s.asset);
                const assetEmoji = getAssetEmoji(s.asset);
                return `
                    <tr style="border-left: 4px solid ${s.color}">
                        <td class="px-3 py-2">${s.name}</td>
                        <td class="px-3 py-2 text-right">${assetEmoji} ${assetName}</td>
                        <td class="px-3 py-2 text-right">${formatCurrency(s.capital)}</td>
                        <td class="px-3 py-2 text-right">${formatCurrency(s.aporte)}</td>
                        <td class="px-3 py-2 text-right">${s.years}</td>
                        <td class="px-3 py-2 text-right">${s.rate}%</td>
                        <td class="px-3 py-2 text-right font-bold" style="color: ${s.color}">${formatCurrency(result.finalValue)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderScenarios() {
            console.log('renderScenarios called with', scenarios.length, 'scenarios');

            const container = document.getElementById('scenarios-container');
            if (!container) {
                console.error('scenarios-container not found!');
                return;
            }

            // FULL RE-RENDER approach
            container.innerHTML = '';

            // Safety check for empty scenarios
            if (scenarios.length === 0) {
                // Default Scenario 1 if absolutely empty logic reached
                scenarios.push({ id: 1, name: 'Escenario 1', color: '#3B82F6', asset: 'sp500', years: 10, capital: 10000, aporte: 500, rate: 10 });
            }

            scenarios.forEach((scenario, idx) => {
                const card = createSimplifiedScenarioCard(scenario, idx + 1);
                container.appendChild(card);

                // Restore Inputs Values
                const rateSlider = card.querySelector('.sim-rate');
                if (rateSlider) rateSlider.value = scenario.rate;

                const rateDisplay = card.querySelector('.sim-rate-display');
                if (rateDisplay) rateDisplay.textContent = scenario.rate + '%';
            });

            // Update button visibility
            const addBtn = document.getElementById('add-scenario-btn');
            if (addBtn) {
                addBtn.style.display = scenarios.length >= 3 ? 'none' : 'flex';
            }

            // Update simulations
            setTimeout(() => {
                updateAllSimulations();
            }, 100);
        }

        function createSimplifiedScenarioCard(scenario, number) {
            const colorClasses = {
                '#3B82F6': 'border-blue-500 bg-blue-50',
                '#10B981': 'border-green-500 bg-green-50',
                '#F59E0B': 'border-orange-500 bg-orange-50'
            };

            const card = document.createElement('div');
            // FIX: Correct class name without spaces, keep scenario-card for selector
            card.className = `scenario-card card p-6 border-2 ${colorClasses[scenario.color] || 'border-gray-500'}`;
            card.setAttribute('data-scenario-id', scenario.id);

            // All available assets for selection (Dynamic from Data)
            // FIX: Filter out aliases (where key == name) AND custom_rate
            const availableAssets = Object.keys(simAssetData)
                .filter(k => k !== 'custom_rate' && simAssetData[k].name !== k);

            // Check if current scenario is using a strategy
            const isStrategyMode = scenario.asset?.startsWith('strategy_');
            const currentStrategy = isStrategyMode ? scenario.asset.replace('strategy_', '') : 'normal';

            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 id="scenario-title-${scenario.id}" class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-8 h-8 text-white rounded-full flex items-center justify-center text-sm" style="background-color: ${scenario.color}">${number}</span>
                        ${scenario.name}
                    </h3>
                    <button onclick="removeScenario(${scenario.id})" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Mode Toggle -->
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Modo de Carga</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="setScenarioMode(${scenario.id}, 'asset')"
                                class="scenario-mode-btn-${scenario.id} py-2 px-3 rounded-xl border-2 ${!isStrategyMode ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 bg-white text-slate-600'} font-bold text-xs transition hover:shadow-md">
                                <i class="fa-solid fa-chart-line mr-1"></i> Activo
                            </button>
                            <button type="button" onclick="setScenarioMode(${scenario.id}, 'strategy')"
                                class="scenario-mode-btn-${scenario.id} py-2 px-3 rounded-xl border-2 ${isStrategyMode ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 bg-white text-slate-600'} font-bold text-xs transition hover:shadow-md">
                                <i class="fa-solid fa-pie-chart mr-1"></i> Estrategia
                            </button>
                        </div>
                    </div>

                    <!-- Asset Selector (Individual Mode) -->
                    <div class="scenario-asset-section-${scenario.id} ${isStrategyMode ? 'hidden' : ''}">
                        <label class="block text-sm font-bold text-slate-600 mb-2">Tipo de Activo</label>
                        <div class="grid grid-cols-3 gap-2">
                            ${availableAssets.map(assetKey => {
                const asset = simAssetData[assetKey];
                const selected = scenario.asset === assetKey;
                return `
                                    <button onclick="selectSimAsset(${scenario.id}, '${assetKey}')"
                                        id="sim-btn-${assetKey}-${scenario.id}"
                                        class="sim-asset-btn p-2 rounded-lg border-2 ${selected ? 'border-blue-500 bg-blue-50' : 'border-slate-200 bg-white'} text-center transition hover:shadow-md">
                                        <div class="text-xl">${asset.emoji}</div>
                                        <div class="text-[10px] font-bold text-slate-700">${asset.name.split(' ')[0]}
                                        </div>
                                    </button>
                                    `;
            }).join('')}
                        </div>
                    </div>

                    <!-- Strategy Selector (Strategy Mode) -->
                    <div class="scenario-strategy-section-${scenario.id} ${!isStrategyMode ? 'hidden' : ''}">
                        <label class="block text-sm font-bold text-slate-600 mb-2">Estrategia</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="selectScenarioStrategy(${scenario.id}, 'normal')"
                                class="scenario-strategy-btn-${scenario.id} p-3 rounded-xl border-2 ${currentStrategy === 'normal' ? 'border-blue-500 bg-blue-50' : 'border-slate-200 bg-white'} text-center transition hover:shadow-md">
                                <div class="text-xl mb-1">游꿢</div>
                                <div class="text-xs font-bold text-slate-700">Normie</div>
                                <div class="text-[10px] text-slate-400">~9%</div>
                            </button>
                            <button onclick="selectScenarioStrategy(${scenario.id}, 'sovereign')"
                                class="scenario-strategy-btn-${scenario.id} p-3 rounded-xl border-2 ${currentStrategy === 'sovereign' ? 'border-blue-500 bg-blue-50' : 'border-slate-200 bg-white'} text-center transition hover:shadow-md">
                                <div class="text-xl mb-1">游댏</div>
                                <div class="text-xs font-bold text-slate-700">Soberano</div>
                                <div class="text-[10px] text-slate-400">~15%</div>
                            </button>
                            <button onclick="selectScenarioStrategy(${scenario.id}, 'custom')"
                                class="scenario-strategy-btn-${scenario.id} p-3 rounded-xl border-2 ${currentStrategy === 'custom' ? 'border-blue-500 bg-blue-50' : 'border-slate-200 bg-white'} text-center transition hover:shadow-md">
                                <div class="text-xl mb-1">九</div>
                                <div class="text-xs font-bold text-slate-700">Personal</div>
                                <div class="text-[10px] text-slate-400">Tu %</div>
                            </button>
                        </div>
                    </div>

                    <!-- Rate Slider -->
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-1">
                            Rentabilidad Anual: <span
                                id="sim-rate-display-${scenario.id}" class="sim-rate-display text-blue-600">${scenario.rate}%</span>
                        </label>
                        <input type="range" id="sim-rate-${scenario.id}" class="sim-rate w-full accent-blue-500" value="${scenario.rate}"
                            min="0" max="50" step="0.5"
                            oninput="updateScenarioData(${scenario.id}, 'rate', this.value); document.getElementById('sim-rate-display-${scenario.id}').textContent = this.value + '%'">
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>0%</span>
                                <span>25%</span>
                                <span>50%</span>
                            </div>
                    </div>

                    <!-- Results Summary -->
                    <div class="p-3 rounded-lg border-2"
                        style="border-color: ${scenario.color}; background-color: ${scenario.color}10">
                        <div class="grid grid-cols-2 gap-3 text-center text-sm">
                            <div>
                                <div class="text-xs text-slate-500 uppercase">Capital Final</div>
                                <div id="sim-result-final-${scenario.id}" class="sim-result-final text-xl font-bold"
                                    style="color: ${scenario.color}">$0</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 uppercase">Ganancia</div>
                                <div id="sim-result-gain-${scenario.id}" class="sim-result-gain text-xl font-bold text-green-600">$0</div>
                            </div>
                        </div>
                         <div class="mt-2 pt-2 border-t border-slate-200 grid grid-cols-2 gap-2 text-center text-xs">
                            <div>
                                <span class="text-slate-500">Invertido:</span>
                                <span id="sim-result-invested-${scenario.id}" class="sim-result-invested font-bold text-slate-700">$0</span>
                            </div>
                            <div>
                                <span class="text-slate-500">ROI:</span>
                                <span id="sim-result-roi-${scenario.id}" class="sim-result-roi font-bold text-green-600">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // Set mode for any scenario (asset vs strategy)
        function setScenarioMode(scenarioId, mode) {
            const card = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (!card) return;

            const assetSection = card.querySelector(`.scenario-asset-section-${scenarioId}`);
            const strategySection = card.querySelector(`.scenario-strategy-section-${scenarioId}`);
            const modeButtons = card.querySelectorAll(`.scenario-mode-btn-${scenarioId}`);

            if (mode === 'asset') {
                modeButtons[0]?.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
                modeButtons[0]?.classList.remove('border-slate-200', 'bg-white', 'text-slate-600');
                modeButtons[1]?.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
                modeButtons[1]?.classList.add('border-slate-200', 'bg-white', 'text-slate-600');
                if (assetSection) assetSection.classList.remove('hidden');
                if (strategySection) strategySection.classList.add('hidden');
            } else {
                modeButtons[1]?.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
                modeButtons[1]?.classList.remove('border-slate-200', 'bg-white', 'text-slate-600');
                modeButtons[0]?.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
                modeButtons[0]?.classList.add('border-slate-200', 'bg-white', 'text-slate-600');
                if (assetSection) assetSection.classList.add('hidden');
                if (strategySection) strategySection.classList.remove('hidden');

                // Select first strategy if none selected
                selectScenarioStrategy(scenarioId, 'normal');
            }
        }

        // Select strategy for any scenario
        function selectScenarioStrategy(scenarioId, strategyKey) {
            const scenario = scenarios.find(s => s.id === scenarioId);
            if (!scenario) return;

            // Strategy definitions
            const strategies = {
                normal: { sp500: 60, fondoLiquidez: 40 },
                sovereign: { bitcoin: 35, sp500: 45, fondoLiquidez: 20 },
                custom: (typeof currentAllocation !== 'undefined' && currentAllocation) ? currentAllocation : {
                    sp500: 100
                }
            };

            const strategyNames = {
                normal: 'Normie',
                sovereign: 'Soberano',
                custom: 'Personalizado'
            };

            const assetReturns = {
                bitcoin: 30, sp500: 10, nasdaq: 12, ethereum: 25, solana: 35,
                gold: 7, fondoLiquidez: 8, bonosTesoro: 4.5, bonosUI: 8.5
            };

            // Calculate weighted return
            const allocation = strategies[strategyKey] || {};
            let weightedReturn = 0;
            let totalWeight = 0;
            const compositionParts = [];

            for (const [asset, weight] of Object.entries(allocation)) {
                // Handle raw numbers or objects with percentage
                const pct = typeof weight === 'object' ? weight.percentage : weight;
                totalWeight += pct;

                if (pct > 0) {
                    const rate = assetReturns[asset] || simAssetData[asset]?.rate || 8;
                    weightedReturn += (pct / 100) * rate;

                    const assetName = simAssetData[asset]?.name || asset;
                    compositionParts.push(`${assetName}: ${pct}% `);
                }
            }

            if (isNaN(weightedReturn) || weightedReturn <= 0) {
                console.warn('Weighted return invalid, defaulting to 8%');
                weightedReturn = 8;
            }

            // Update scenario
            scenario.asset = `strategy_${strategyKey}`;
            scenario.rate = Math.round(weightedReturn);
            scenario.name = `Estrategia ${strategyNames[strategyKey]}`;

            // Update Title UI
            const titleEl = document.getElementById(`scenario-title-${scenarioId}`);
            if (titleEl) {
                const numberSpan = titleEl.querySelector('span');
                titleEl.innerHTML = '';
                if (numberSpan) titleEl.appendChild(numberSpan);
                titleEl.appendChild(document.createTextNode(` Estrategia ${strategyNames[strategyKey]}`));
            }

            // Update UI
            const card = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (card) {
                // Update strategy buttons
                const strategyBtns = card.querySelectorAll(`.scenario-strategy-btn-${scenarioId}`);
                strategyBtns.forEach(btn => {
                    const onclick = btn.getAttribute('onclick');
                    if (onclick && onclick.includes(`'${strategyKey}'`)) {
                        btn.classList.remove('border-slate-200', 'bg-white');
                        btn.classList.add('border-blue-500', 'bg-blue-50');
                    } else {
                        btn.classList.remove('border-blue-500', 'bg-blue-50');
                        btn.classList.add('border-slate-200', 'bg-white');
                    }
                });

                // Update rate slider
                // Try finding by class first, then by ID if scenario 1
                let rateSlider = card.querySelector('.sim-rate');
                if (!rateSlider && scenarioId === 1) rateSlider = document.getElementById('sim-rate');

                const rateDisplay = card.querySelector('.sim-rate-display') ||
                    document.getElementById('sim-rate-display'); // Fallback for scenario 1

                if (rateSlider) {
                    rateSlider.value = scenario.rate;
                }
                if (rateDisplay) {
                    rateDisplay.textContent = scenario.rate + '%';
                }

                // Update Composition Text
                const compEl = card.querySelector('#sim-strategy-composition') ||
                    card.querySelector('.sim-strategy-composition');
                if (compEl) {
                    compEl.textContent = compositionParts.join(', ');
                }
            }

            updateAllSimulations();
        }

        // ===== DASHBOARD FUNCTIONS =====

        let dashAllocationChart = null;
        let dashProjectionChart = null;

        function updateDashboardMode() {
            // Get current state
            const capital = currentCapital || 45000;
            const monthly = parseFloat(document.getElementById('monthlyContrib')?.value) || 2000;

            // Get mode info
            const modeConfig = config[currentMode];
            const modeName = currentMode === 'normal' ? 'Modo Normie' :
                currentMode === 'sovereign' ? 'Modo Soberano' : 'Modo Personalizado';

            // ===== GET ALLOCATION DATA (FIX: use .assets not .allocation) =====
            let allocationData = [];
            if (currentMode === 'custom' && customAssets.length > 0) {
                allocationData = customAssets.map(a => ({
                    name: a.name,
                    ratio: a.ratio || 0,
                    value: capital * (a.ratio || 0),
                    color: a.color || getAssetColor(a.name)
                }));
            } else if (modeConfig && modeConfig.assets && modeConfig.assets.length > 0) {
                // FIX: Use modeConfig.assets (array) instead of modeConfig.allocation
                allocationData = modeConfig.assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio || 0,
                    value: capital * (a.ratio || 0),
                    color: a.color || getAssetColor(a.name)
                }));
            }

            // ===== CALCULATE REAL PORTFOLIO RETURN (weighted by ratios) =====
            const portfolioReturn = allocationData.reduce((sum, asset) => {
                const assetReturn = assetMeta[asset.name]?.ret || 0;
                return sum + (assetReturn * asset.ratio);
            }, 0);

            // ===== CALCULATE REAL LIQUIDITY (only liquid assets) =====
            const liquidAssets = ['Fondo Liquidez', 'Efectivo', 'Bonos UI', 'Bonos USA'];
            const liquidityValue = allocationData
                .filter(a => liquidAssets.some(la => a.name.toLowerCase().includes(la.toLowerCase())))
                .reduce((sum, a) => sum + a.value, 0);

            // ===== UPDATE KPIs =====
            const patrimonioEl = document.getElementById('dash-patrimonio');
            if (patrimonioEl) patrimonioEl.textContent = '$' + capital.toLocaleString('en-US', { minimumFractionDigits: 2 });

            const retornoEl = document.getElementById('dash-retorno');
            if (retornoEl) retornoEl.textContent = '+' + portfolioReturn.toFixed(1) + '%';

            const volatilityEl = document.getElementById('dash-volatilidad');
            if (volatilityEl) volatilityEl.textContent = '$' + liquidityValue.toLocaleString('en-US', { minimumFractionDigits: 2 });

            // Update mode badge
            const badge = document.getElementById('dash-mode-badge');
            if (badge) badge.textContent = modeName;

            // Update totals
            const allocTotalEl = document.getElementById('dash-alloc-total');
            if (allocTotalEl) allocTotalEl.textContent = '$' + capital.toLocaleString('en-US', { minimumFractionDigits: 2 });

            const balanceTotalEl = document.getElementById('dash-balance-total');
            if (balanceTotalEl) balanceTotalEl.textContent = '$' + capital.toLocaleString('en-US', { minimumFractionDigits: 2 });

            // Update asset list (premium bars)
            updateDashAssetList(allocationData);

            // Update allocation table (transaction-style)
            updateDashAllocationTable(allocationData);

            // Update projection chart with REAL portfolio return
            updateDashProjectionChart(capital, monthly, portfolioReturn / 100);

            // ===== UPDATE BENCHMARK COMPARISON =====
            const benchmarkReturn = 9; // S&P 500 historical ~9%
            const difference = portfolioReturn - benchmarkReturn;
            const benchmarkEl = document.getElementById('dash-benchmark-comparison');
            if (benchmarkEl) {
                if (difference >= 0) {
                    benchmarkEl.textContent = '+' + difference.toFixed(1) + '% mejor';
                    benchmarkEl.style.color = '#22C55E';
                } else {
                    benchmarkEl.textContent = difference.toFixed(1) + '% menor';
                    benchmarkEl.style.color = '#EF4444';
                }
            }

            // ===== UPDATE SAVED PORTFOLIOS COUNT =====
            const portfoliosCountEl = document.getElementById('dash-portfolios-count');
            if (portfoliosCountEl) {
                const saved = JSON.parse(localStorage.getItem('savedPortfolios') || '[]');
                portfoliosCountEl.textContent = saved.length;
            }

            // ===== UPDATE NEXT ACTIONS =====
            const actionsEl = document.getElementById('dash-next-actions');
            if (actionsEl) {
                const hasCustom = customAssets.length > 0;
                const hasPortfolios = (JSON.parse(localStorage.getItem('savedPortfolios') || '[]')).length > 0;

                let actionsHtml = '';
                if (hasPortfolios) {
                    actionsHtml += `<div class="flex items-center gap-2 text-[13px]" style="color: rgba(255,255,255,0.80);">
                        <i class="fa-solid fa-circle-check text-green-500"></i>
                        <span>Portfolios guardados disponibles</span>
                    </div>`;
                }
                actionsHtml += `<div class="flex items-center gap-2 text-[13px]" style="color: rgba(255,255,255,0.58);">
                    <i class="fa-regular fa-circle"></i>
                    <span>Revisar aportaci칩n mensual</span>
                </div>`;
                if (!hasCustom) {
                    actionsHtml += `<div class="flex items-center gap-2 text-[13px]" style="color: rgba(255,255,255,0.58);">
                        <i class="fa-regular fa-circle"></i>
                        <span>Crear portfolio personalizado</span>
                    </div>`;
                }
                actionsEl.innerHTML = actionsHtml;
            }

            // Update price ticker
            updatePriceTicker();

            // Update checklist and monthly summary
            renderChecklist();
            updateMonthlySummary();

            // Update strategy selector buttons
            document.querySelectorAll('.dash-mode-btn').forEach(btn => {
                const btnMode = btn.id.replace('dash-mode-', '');
                if (btnMode === currentMode) {
                    btn.style.background = '#182231';
                    btn.style.color = 'rgba(255,255,255,0.92)';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'rgba(255,255,255,0.58)';
                }
            });
        }

        function updateDashAssetList(data) {
            const container = document.getElementById('dash-asset-list');
            if (!container) return;

            if (data.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-size: 13px;">No hay activos configurados</p>';
                return;
            }

            // Use asset colors or fallback to neon lime
            container.innerHTML = data.map((asset, i) => {
                const pct = Math.round(asset.ratio * 100);
                const value = asset.value || 0;
                const color = asset.color || '#C6FF34';
                return `
                    <div class="flex items-center justify-between">
                        <span class="text-[13px] font-medium" style="color: rgba(255,255,255,0.80);">${asset.name}</span>
                        <div class="flex items-center gap-3">
                            <span class="text-[12px]" style="color: rgba(255,255,255,0.50);">$${value.toLocaleString('en-US', { minimumFractionDigits: 0 })}</span>
                            <span class="text-[13px] font-semibold" style="color: ${color};">${pct}%</span>
                        </div>
                    </div>
                    <div class="w-full rounded-full h-2 mb-3" style="background: rgba(255,255,255,0.08);">
                        <div class="h-2 rounded-full transition-all" style="width: ${pct}%; background: ${color};"></div>
                    </div>
                `;
            }).join('');
        }

        function updateDashAllocationTable(data) {
            const tbody = document.getElementById('dash-allocation-table');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center" style="color: rgba(255,255,255,0.5);">No hay activos en este modo</td></tr>';
                return;
            }

            // Generate rows with real asset data
            tbody.innerHTML = data.map((asset, i) => {
                const pct = Math.round(asset.ratio * 100);
                const value = asset.value || 0;
                const emoji = getAssetEmoji(asset.name);
                const expectedReturn = assetMeta[asset.name]?.ret || 0;
                const isPositive = expectedReturn >= 0;

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);">
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center text-lg" style="background: rgba(185,242,10,0.10);">${emoji}</div>
                                <div>
                                    <span class="text-[13px] font-medium block" style="color: rgba(255,255,255,0.80);">${asset.name}</span>
                                    <span class="text-[11px]" style="color: rgba(255,255,255,0.40);">${pct}% del portfolio</span>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-right">
                            <span class="text-[13px] font-semibold" style="color: #C6FF34;">$${value.toLocaleString('en-US', { minimumFractionDigits: 0 })}</span>
                        </td>
                        <td class="py-3 px-4 text-right">
                            <span class="text-[13px] font-medium" style="color: ${isPositive ? '#22C55E' : '#EF4444'};">${isPositive ? '+' : ''}${expectedReturn}% anual</span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="w-full rounded-full h-1.5" style="background: rgba(255,255,255,0.08); width: 60px; margin: 0 auto;">
                                <div class="h-1.5 rounded-full" style="width: ${pct}%; background: ${asset.color || '#C6FF34'};"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAssetEmoji(name) {
            const lower = name.toLowerCase();
            if (lower.includes('bitcoin') || lower.includes('btc')) return '';
            if (lower.includes('ethereum') || lower.includes('eth')) return '';
            if (lower.includes('s&p') || lower.includes('spy') || lower.includes('voo')) return '游늵';
            if (lower.includes('nasdaq') || lower.includes('qqq')) return '游눹';
            if (lower.includes('oro') || lower.includes('gold')) return '游볞';
            if (lower.includes('bono') || lower.includes('bond')) return '游닆';
            if (lower.includes('liquidez') || lower.includes('cash') || lower.includes('dolar')) return '游눳';
            if (lower.includes('letra') || lower.includes('ui')) return '游끹勇';
            if (lower.includes('real estate') || lower.includes('inmueble')) return '游';
            return '游늳';
        }

        function updateDashProjectionChart(capital, monthly, rate) {
            // Use the current chart view setting
            updateDashProjectionChartWithType(capital, monthly, rate, dashChartView || 'bars');
        }

        // ===== DASHBOARD INTERACTIVE FEATURES =====

        let dashChartView = 'bars';
        let dashSettingsOpen = false;
        let dashContextMenuOpen = false;

        // Toggle between bar and line chart views
        function setDashChartView(view) {
            dashChartView = view;

            // Update button states
            const barsBtn = document.getElementById('dash-view-bars');
            const lineBtn = document.getElementById('dash-view-line');

            if (barsBtn && lineBtn) {
                if (view === 'bars') {
                    barsBtn.style.background = '#182231';
                    barsBtn.style.color = 'rgba(255,255,255,0.92)';
                    lineBtn.style.background = 'transparent';
                    lineBtn.style.color = 'rgba(255,255,255,0.58)';
                } else {
                    lineBtn.style.background = '#182231';
                    lineBtn.style.color = 'rgba(255,255,255,0.92)';
                    barsBtn.style.background = 'transparent';
                    barsBtn.style.color = 'rgba(255,255,255,0.58)';
                }
            }

            // Re-render chart with new type - use REAL portfolio return
            const capital = currentCapital || 45000;
            const monthly = parseFloat(document.getElementById('monthlyContrib')?.value) || 2000;

            // Calculate real portfolio return from current mode assets
            const modeConfig = config[currentMode];
            let allocationData = [];
            if (currentMode === 'custom' && customAssets.length > 0) {
                allocationData = customAssets;
            } else if (modeConfig && modeConfig.assets) {
                allocationData = modeConfig.assets;
            }
            const portfolioReturn = allocationData.reduce((sum, asset) => {
                const assetReturn = assetMeta[asset.name]?.ret || 0;
                return sum + (assetReturn * (asset.ratio || 0));
            }, 0);
            const rate = portfolioReturn / 100;

            updateDashProjectionChartWithType(capital, monthly, rate, view);
        }

        function updateDashProjectionChartWithType(capital, monthly, rate, chartType) {
            const ctx = document.getElementById('dash-projection-chart');
            if (!ctx) return;

            if (dashProjectionChart) {
                dashProjectionChart.destroy();
            }

            // Generate 12-month FUTURE projection labels
            const now = new Date();
            const labels = [];
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            for (let i = 0; i < 12; i++) {
                const futureDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                labels.push(monthNames[futureDate.getMonth()]);
            }

            // Calculate projected values with monthly compounding + contributions
            const monthlyRate = rate / 12;
            const values = [];
            let currentValue = capital;
            for (let i = 0; i < 12; i++) {
                values.push(Math.round(currentValue));
                currentValue = currentValue * (1 + monthlyRate) + monthly;
            }

            // Final projected value for display
            const finalValue = values[values.length - 1];
            const projectedGain = finalValue - capital;
            const projectedPct = ((finalValue - capital) / capital * 100).toFixed(1);

            // Update projection summary text
            const summaryEl = document.getElementById('dash-projection-summary');
            if (summaryEl) {
                summaryEl.innerHTML = `En 12 meses: <span style="color: #C6FF34; font-weight: 600;">$${finalValue.toLocaleString()}</span> (+$${projectedGain.toLocaleString()}, ${projectedPct}%)`;
            }

            if (chartType === 'line') {
                // Line chart configuration for smooth projection curve
                dashProjectionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Proyecci칩n',
                            data: values,
                            borderColor: '#C6FF34',
                            backgroundColor: 'rgba(198, 255, 52, 0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#C6FF34',
                            pointBorderColor: '#0F141B',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#182231',
                                titleColor: 'rgba(255,255,255,0.80)',
                                bodyColor: '#C6FF34',
                                borderColor: 'rgba(255,255,255,0.10)',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: (ctx) => 'Proyectado: $' + ctx.parsed.y.toLocaleString()
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: 'rgba(255,255,255,0.42)', font: { size: 11 } },
                                border: { display: false }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.06)' },
                                ticks: {
                                    color: 'rgba(255,255,255,0.42)',
                                    callback: (v) => '$' + (v / 1000).toFixed(0) + 'k'
                                },
                                border: { display: false }
                            }
                        }
                    }
                });
            } else {
                // Bar chart with growing bars showing projection
                const bgColors = values.map((v, i) => {
                    if (i === 0) return '#C6FF34'; // Current month highlighted
                    return '#182231';
                });

                dashProjectionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Valor Proyectado',
                            data: values,
                            backgroundColor: bgColors,
                            borderWidth: 0,
                            borderRadius: 6,
                            barThickness: 28
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#182231',
                                titleColor: 'rgba(255,255,255,0.80)',
                                bodyColor: '#C6FF34',
                                borderColor: 'rgba(255,255,255,0.10)',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: (ctx) => 'Proyectado: $' + ctx.parsed.y.toLocaleString()
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: 'rgba(255,255,255,0.42)', font: { size: 10 } },
                                border: { display: false }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.06)' },
                                ticks: {
                                    color: 'rgba(255,255,255,0.42)',
                                    callback: (v) => '$' + (v / 1000).toFixed(0) + 'k'
                                },
                                border: { display: false }
                            }
                        }
                    }
                });
            }
        }

        // Settings/Config Modal
        function toggleDashTheme() {
            showDashSettingsModal();
        }

        // ===== EDITABLE PATRIMONIO =====
        function editPatrimonio() {
            const patrimonioEl = document.getElementById('dash-patrimonio');
            if (!patrimonioEl) return;

            // Get current value
            const currentText = patrimonioEl.textContent;
            const currentValue = parseFloat(currentText.replace(/[$,]/g, '')) || currentCapital || 45000;

            // Create inline input
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.min = '1000';
            input.max = '10000000';
            input.step = '1000';
            input.className = 'text-[28px] font-semibold w-full bg-transparent border-b-2 border-[#C6FF34] outline-none';
            input.style.color = '#C6FF34';
            input.style.lineHeight = '1.15';

            // Replace text with input
            patrimonioEl.innerHTML = '';
            patrimonioEl.appendChild(input);
            input.focus();
            input.select();

            // Handle blur and enter
            const saveValue = () => {
                const newValue = parseFloat(input.value) || 45000;
                currentCapital = newValue;

                // Save to localStorage
                localStorage.setItem('currentCapital', newValue);

                // Update display
                patrimonioEl.textContent = '$' + newValue.toLocaleString('en-US', { minimumFractionDigits: 2 });
                patrimonioEl.onclick = () => editPatrimonio();

                // Refresh dashboard with new capital
                updateDashboardMode();

                // Show toast
                showNotification('Capital actualizado a $' + newValue.toLocaleString(), '游눯 Guardado', 'success');
            };

            input.addEventListener('blur', saveValue);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    patrimonioEl.textContent = '$' + currentValue.toLocaleString('en-US', { minimumFractionDigits: 2 });
                    patrimonioEl.onclick = () => editPatrimonio();
                }
            });
        }

        // ===== DASHBOARD SEARCH =====
        function dashboardSearch(query) {
            const searchQuery = query.toLowerCase().trim();
            const assetList = document.getElementById('dash-asset-list');
            const allocationTable = document.getElementById('dash-allocation-table');

            if (!searchQuery) {
                // Reset view - show all
                updateDashboardMode();
                return;
            }

            // Get current allocation data
            const modeConfig = config[currentMode];
            let allocationData = [];
            if (currentMode === 'custom' && customAssets.length > 0) {
                allocationData = customAssets;
            } else if (modeConfig && modeConfig.assets) {
                allocationData = modeConfig.assets;
            }

            // Filter assets by search query
            const filtered = allocationData.filter(a =>
                a.name.toLowerCase().includes(searchQuery)
            );

            // Update displays with filtered data
            const capital = currentCapital || 45000;
            const filteredWithValues = filtered.map(a => ({
                name: a.name,
                ratio: a.ratio || 0,
                value: capital * (a.ratio || 0),
                color: a.color || getAssetColor(a.name)
            }));

            updateDashAssetList(filteredWithValues);
            updateDashAllocationTable(filteredWithValues);

            // Show result count
            const countEl = document.querySelector('[data-dash-search-count]');
            if (countEl) {
                countEl.textContent = `Mostrando ${filtered.length} de ${allocationData.length} activos`;
            }
        }

        // ===== ASSET RETURNS TICKER =====
        let dashTimeRange = '1M'; // Default time range

        function updatePriceTicker() {
            // Update ticker with real returns from assetMeta
            const tickerData = {
                btc: { return: assetMeta['Bitcoin']?.ret || 15 },
                sp500: { return: assetMeta['S&P 500']?.ret || 9 },
                fondo: { return: assetMeta['Fondo Liquidez']?.ret || 8 },
                gold: { return: assetMeta['Oro']?.ret || 5 }
            };

            // Update DOM elements with annual returns
            const btcEl = document.getElementById('ticker-btc-return');
            if (btcEl) btcEl.textContent = `+${tickerData.btc.return}%/a침o`;

            const sp500El = document.getElementById('ticker-sp500-return');
            if (sp500El) sp500El.textContent = `+${tickerData.sp500.return}%/a침o`;

            const fondoEl = document.getElementById('ticker-fondo-return');
            if (fondoEl) fondoEl.textContent = `+${tickerData.fondo.return}%/a침o`;

            const goldEl = document.getElementById('ticker-gold-return');
            if (goldEl) goldEl.textContent = `+${tickerData.gold.return}%/a침o`;
        }

        // ===== TIME RANGE FILTER =====
        function setDashTimeRange(range) {
            dashTimeRange = range;

            // Update button states
            document.querySelectorAll('.dash-time-btn').forEach(btn => {
                if (btn.dataset.range === range) {
                    btn.style.background = '#182231';
                    btn.style.color = 'rgba(255,255,255,0.92)';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'rgba(255,255,255,0.58)';
                }
            });

            // Map range to months
            const rangeMonths = {
                '1M': 1,
                '3M': 3,
                '6M': 6,
                '1A': 12,
                'YTD': new Date().getMonth() + 1 // Current month of year
            };
            const months = rangeMonths[range] || 12;

            // Recalculate projection chart with new range
            const capital = currentCapital || 45000;
            const monthly = parseFloat(document.getElementById('monthlyContrib')?.value) || 2000;

            // Calculate real portfolio return
            const modeConfig = config[currentMode];
            let allocationData = [];
            if (currentMode === 'custom' && customAssets.length > 0) {
                allocationData = customAssets;
            } else if (modeConfig && modeConfig.assets) {
                allocationData = modeConfig.assets;
            }
            const portfolioReturn = allocationData.reduce((sum, asset) => {
                const assetReturn = assetMeta[asset.name]?.ret || 0;
                return sum + (assetReturn * (asset.ratio || 0));
            }, 0);
            const rate = portfolioReturn / 100;

            // Update chart with specific number of months
            updateDashProjectionChartForRange(capital, monthly, rate, months, dashChartView);
        }

        function updateDashProjectionChartForRange(capital, monthlyContrib, annualRate, numMonths, chartType = 'bar') {
            const ctx = document.getElementById('dash-projection-chart')?.getContext('2d');
            if (!ctx) return;

            // Generate month labels based on range
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const currentMonth = new Date().getMonth(); // 0-11
            const labels = [];
            const data = [];

            let projectedValue = capital;
            const monthlyRate = annualRate / 12;

            for (let i = 0; i < numMonths; i++) {
                const monthIdx = (currentMonth + i) % 12;
                labels.push(monthNames[monthIdx]);

                projectedValue = projectedValue * (1 + monthlyRate) + monthlyContrib;
                data.push(projectedValue);
            }

            // Update summary
            const summaryEl = document.getElementById('dash-projection-summary');
            if (summaryEl) {
                const finalValue = data[data.length - 1];
                const totalGain = finalValue - capital;
                const gainPct = (totalGain / capital * 100).toFixed(1);
                const rangeLabel = numMonths === 1 ? '1 mes' : numMonths === 12 ? '1 a침o' : `${numMonths} meses`;
                summaryEl.textContent = `En ${rangeLabel}: $${Math.round(finalValue).toLocaleString()} (+$${Math.round(totalGain).toLocaleString()}, ${gainPct}%)`;
            }

            // Destroy and recreate chart
            if (window.dashProjectionChart) {
                window.dashProjectionChart.destroy();
            }

            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Proyecci칩n',
                        data: data,
                        backgroundColor: chartType === 'bar' ?
                            data.map((_, i) => i === data.length - 1 ? '#C6FF34' : 'rgba(185,242,10,0.45)') :
                            'rgba(185,242,10,0.15)',
                        borderColor: '#C6FF34',
                        borderWidth: chartType === 'line' ? 2 : 0,
                        borderRadius: chartType === 'bar' ? 6 : 0,
                        tension: 0.4,
                        fill: chartType === 'line',
                        pointBackgroundColor: chartType === 'line' ? '#C6FF34' : undefined,
                        pointRadius: chartType === 'line' ? 4 : undefined
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.04)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.42)',
                                font: { size: 10 },
                                callback: v => '$' + (v / 1000).toFixed(0) + 'k'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.58)', font: { size: 10 } }
                        }
                    }
                }
            };

            window.dashProjectionChart = new Chart(ctx, chartConfig);
        }

        // ===== STRATEGY SELECTOR =====
        function setDashMode(mode) {
            currentMode = mode;

            // Update button states
            document.querySelectorAll('.dash-mode-btn').forEach(btn => {
                const btnMode = btn.id.replace('dash-mode-', '');
                if (btnMode === mode) {
                    btn.style.background = '#182231';
                    btn.style.color = 'rgba(255,255,255,0.92)';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'rgba(255,255,255,0.58)';
                }
            });

            // Update mode indicator in header if exists
            const memberCard = document.querySelector('#dashboard-wrapper .rounded-2xl');
            if (memberCard) {
                const modeLabel = memberCard.querySelector('[data-mode-label]');
                if (modeLabel) {
                    const modeNames = { normal: 'Modo Normie', sovereign: 'Modo Soberano', custom: 'Personalizado' };
                    modeLabel.textContent = modeNames[mode] || 'Personalizado';
                }
            }

            // Refresh dashboard
            updateDashboardMode();
            showToast(`Estrategia cambiada a ${mode === 'normal' ? 'Normie' : mode === 'sovereign' ? 'Soberano' : 'Personalizado'}`, 'success');
        }

        // ===== EDITABLE CHECKLIST =====
        function getChecklist() {
            try {
                return JSON.parse(localStorage.getItem('dashChecklist') || '[]');
            } catch {
                return [];
            }
        }

        function saveChecklist(items) {
            localStorage.setItem('dashChecklist', JSON.stringify(items));
        }

        function renderChecklist() {
            const container = document.getElementById('dash-checklist');
            if (!container) return;

            let items = getChecklist();
            if (items.length === 0) {
                // Default items
                items = [
                    { id: Date.now(), text: 'Revisar aportaci칩n mensual', done: false },
                    { id: Date.now() + 1, text: 'Configurar estrategia', done: true }
                ];
                saveChecklist(items);
            }

            container.innerHTML = items.map(item => `
                <div class="flex items-center gap-2 group" data-item-id="${item.id}">
                    <input type="checkbox" ${item.done ? 'checked' : ''} 
                        onchange="toggleChecklistItem(${item.id})"
                        class="w-4 h-4 rounded accent-lime-400 cursor-pointer">
                    <span class="flex-1 text-[13px] ${item.done ? 'line-through' : ''}" 
                        style="color: ${item.done ? 'rgba(255,255,255,0.42)' : 'rgba(255,255,255,0.80)'};"
                        contenteditable="true" 
                        onblur="updateChecklistText(${item.id}, this.textContent)">${item.text}</span>
                    <button onclick="deleteChecklistItem(${item.id})" 
                        class="opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-500/20">
                        <i class="fa-solid fa-xmark text-[10px]" style="color: #EF4444;"></i>
                    </button>
                </div>
            `).join('');
        }

        function addChecklistItem() {
            const items = getChecklist();
            items.push({ id: Date.now(), text: 'Nueva tarea...', done: false });
            saveChecklist(items);
            renderChecklist();
        }

        function toggleChecklistItem(id) {
            const items = getChecklist();
            const item = items.find(i => i.id === id);
            if (item) {
                item.done = !item.done;
                saveChecklist(items);
                renderChecklist();
            }
        }

        function updateChecklistText(id, text) {
            const items = getChecklist();
            const item = items.find(i => i.id === id);
            if (item && text.trim()) {
                item.text = text.trim();
                saveChecklist(items);
            }
        }

        function deleteChecklistItem(id) {
            let items = getChecklist();
            items = items.filter(i => i.id !== id);
            saveChecklist(items);
            renderChecklist();
        }

        // ===== MONTHLY SUMMARY =====
        function updateMonthlySummary() {
            const contribStatus = document.getElementById('dash-contrib-status');
            const healthScore = document.getElementById('dash-health-score');
            const ytdReturn = document.getElementById('dash-ytd-return');
            const now = new Date();

            // Check if contribution was made this month
            const lastContrib = localStorage.getItem('lastContributionDate');
            const thisMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

            if (contribStatus) {
                if (lastContrib && lastContrib.startsWith(thisMonth)) {
                    contribStatus.textContent = '九 Hecho';
                    contribStatus.style.background = 'rgba(34,197,94,0.14)';
                    contribStatus.style.color = '#22C55E';
                } else {
                    contribStatus.textContent = 'Pendiente';
                    contribStatus.style.background = 'rgba(251,191,36,0.14)';
                    contribStatus.style.color = '#FBBF24';
                }
            }

            // Calculate Health Score (0-100)
            if (healthScore) {
                let score = 50; // Base score

                // Get allocation data
                const modeConfig = config[currentMode];
                let allocationData = [];
                if (currentMode === 'custom' && customAssets.length > 0) {
                    allocationData = customAssets;
                } else if (modeConfig && modeConfig.assets) {
                    allocationData = modeConfig.assets;
                }

                // +15 for diversification (more than 2 assets)
                if (allocationData.length >= 3) score += 15;
                else if (allocationData.length >= 2) score += 10;

                // +15 for having a defined strategy
                if (currentMode !== 'custom') score += 15;

                // +10 if contribution made this month
                if (lastContrib && lastContrib.startsWith(thisMonth)) score += 10;

                // +10 for having capital set
                if (currentCapital && currentCapital > 0) score += 10;

                // Cap at 100
                score = Math.min(100, Math.max(0, score));

                healthScore.textContent = score;
                // Color based on score
                if (score >= 80) {
                    healthScore.style.color = '#22C55E';
                } else if (score >= 60) {
                    healthScore.style.color = '#FBBF24';
                } else {
                    healthScore.style.color = '#EF4444';
                }
            }

            // Calculate YTD return based on portfolio
            if (ytdReturn) {
                const modeConfig = config[currentMode];
                let allocationData = [];
                if (currentMode === 'custom' && customAssets.length > 0) {
                    allocationData = customAssets;
                } else if (modeConfig && modeConfig.assets) {
                    allocationData = modeConfig.assets;
                }
                const monthsYTD = now.getMonth() + 1;
                const portfolioReturn = allocationData.reduce((sum, asset) => {
                    const assetReturn = assetMeta[asset.name]?.ret || 0;
                    return sum + (assetReturn * (asset.ratio || 0));
                }, 0);
                const ytdPct = (portfolioReturn * monthsYTD / 12).toFixed(1);
                ytdReturn.textContent = `+${ytdPct}%`;
                ytdReturn.style.color = ytdPct >= 0 ? '#22C55E' : '#EF4444';
            }
        }

        // Toggle monthly contribution status
        function toggleMonthlyContribution() {
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            const lastContrib = localStorage.getItem('lastContributionDate');

            if (lastContrib && lastContrib.startsWith(thisMonth)) {
                // Already marked, unmark it
                localStorage.removeItem('lastContributionDate');
                showToast('Aportaci칩n desmarcada', 'info');
            } else {
                // Mark as completed this month
                localStorage.setItem('lastContributionDate', now.toISOString().split('T')[0]);
                showToast('춰Aportaci칩n del mes registrada!', 'success');
            }

            updateMonthlySummary();
        }

        function showDashSettingsModal() {
            // Remove existing modal if any
            const existing = document.getElementById('dash-settings-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'dash-settings-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/60" onclick="closeDashSettingsModal()"></div>
                <div class="relative w-full max-w-md p-6 rounded-2xl" style="background: #0F141B; border: 1px solid rgba(255,255,255,0.10);">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold" style="color: rgba(255,255,255,0.92);">丘뙖잺 Configuraci칩n del Dashboard</h3>
                        <button onclick="closeDashSettingsModal()" class="p-2 rounded-lg hover:bg-white/10" style="color: rgba(255,255,255,0.58);">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 rounded-xl" style="background: #121A23; border: 1px solid rgba(255,255,255,0.06);">
                            <div class="text-sm font-medium mb-3" style="color: rgba(255,255,255,0.80);">Acciones R치pidas</div>
                            <div class="space-y-2">
                                <button onclick="exportDashboardData(); closeDashSettingsModal();" class="w-full px-4 py-2 text-sm font-medium rounded-lg flex items-center gap-2 transition hover:bg-white/5" style="background: #182231; color: rgba(255,255,255,0.80);">
                                    <i class="fa-solid fa-download"></i> Exportar Datos
                                </button>
                                <button onclick="generatePDFReport(); closeDashSettingsModal();" class="w-full px-4 py-2 text-sm font-medium rounded-lg flex items-center gap-2 transition hover:bg-white/5" style="background: #182231; color: rgba(255,255,255,0.80);">
                                    <i class="fa-solid fa-file-pdf"></i> Generar PDF
                                </button>
                                <button onclick="refreshDashboardData(); closeDashSettingsModal();" class="w-full px-4 py-2 text-sm font-medium rounded-lg flex items-center gap-2 transition hover:bg-white/5" style="background: #182231; color: rgba(255,255,255,0.80);">
                                    <i class="fa-solid fa-rotate"></i> Actualizar Datos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeDashSettingsModal() {
            const modal = document.getElementById('dash-settings-modal');
            if (modal) modal.remove();
        }

        // Change mode from within dashboard (no longer opens modal)
        function setDashMode(mode) {
            currentMode = mode;
            localStorage.setItem('selectedMode', mode);
            updateDashboardMode();
            closeDashSettingsModal();
            showToast(`Estrategia cambiada a ${mode === 'normal' ? 'Normie' : mode === 'sovereign' ? 'Soberano' : 'Personalizado'}`, 'success');
        }

        // Refresh dashboard data
        function refreshDashboardData() {
            updateDashboardMode();
            showToast('Dashboard actualizado', 'success');
        }

        // Export dashboard data
        function exportDashboardData() {
            const modeConfig = config[currentMode];
            const capital = currentCapital || 45000;

            let allocationData = [];
            if (currentMode === 'custom' && customAssets.length > 0) {
                allocationData = customAssets.map(a => ({
                    name: a.name,
                    percentage: Math.round((a.ratio || 0) * 100),
                    value: capital * (a.ratio || 0)
                }));
            } else if (modeConfig && modeConfig.allocation) {
                allocationData = Object.keys(modeConfig.allocation)
                    .filter(k => modeConfig.allocation[k] > 0)
                    .map(k => ({
                        name: k,
                        percentage: modeConfig.allocation[k],
                        value: capital * modeConfig.allocation[k] / 100
                    }));
            }

            const exportData = {
                fecha: new Date().toISOString(),
                modo: currentMode,
                patrimonio: capital,
                asignacion: allocationData
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plan-semilla-${currentMode}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Datos exportados correctamente', 'success');
        }

        // NOTE: generatePDFReport is defined earlier in the file (line ~3132) with complete functionality
        // including pie chart, projections, and rebalancing data

        // Search functionality for assets
        function setupDashboardSearch() {
            const searchInput = document.querySelector('#dashboard-wrapper input[placeholder*="Buscar activo"]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    filterDashboardBySearch(query);
                });
            }

            const transactionSearch = document.querySelector('#dashboard-wrapper input[placeholder*="Buscar transacci칩n"]');
            if (transactionSearch) {
                transactionSearch.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    filterTransactionsBySearch(query);
                });
            }
        }

        function filterDashboardBySearch(query) {
            if (!query) {
                updateDashboardMode();
                return;
            }

            // Filter asset list
            const assetList = document.getElementById('dash-asset-list');
            if (assetList) {
                const items = assetList.querySelectorAll('div.flex');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? '' : 'none';
                });
            }
        }

        function filterTransactionsBySearch(query) {
            const tbody = document.getElementById('dash-allocation-table');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Date filter dropdown
        function showDateFilterDropdown(button) {
            const existing = document.getElementById('date-filter-dropdown');
            if (existing) {
                existing.remove();
                return;
            }

            const rect = button.getBoundingClientRect();
            const dropdown = document.createElement('div');
            dropdown.id = 'date-filter-dropdown';
            dropdown.className = 'fixed z-50 p-2 rounded-xl';
            dropdown.style.cssText = `
top: ${rect.bottom + 5}px;
left: ${rect.left}px;
background: #0F141B;
border: 1px solid rgba(255,255,255,0.10);
min-width: 180px;
`;
            dropdown.innerHTML = `
<button onclick="filterByDate('today')" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5"
    style="color: rgba(255,255,255,0.80);">Hoy</button>
<button onclick="filterByDate('week')" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5"
    style="color: rgba(255,255,255,0.80);">칔ltima semana</button>
<button onclick="filterByDate('month')" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5"
    style="color: rgba(255,255,255,0.80);">칔ltimo mes</button>
<button onclick="filterByDate('year')" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5"
    style="color: rgba(255,255,255,0.80);">칔ltimo a침o</button>
<button onclick="filterByDate('all')" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5"
    style="color: #C6FF34;">Ver todo</button>
`;
            document.body.appendChild(dropdown);

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== button) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }

        function filterByDate(range) {
            const dropdown = document.getElementById('date-filter-dropdown');
            if (dropdown) dropdown.remove();

            // For now, just show a toast - real implementation would filter transactions
            const rangeNames = { today: 'hoy', week: '칰ltima semana', month: '칰ltimo mes', year: '칰ltimo a침o', all: 'todo' };
            showToast(`Mostrando: ${rangeNames[range]}`, 'info');
        }

        // Import modal
        function showImportModal() {
            const existing = document.getElementById('import-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'import-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
            modal.innerHTML = `
<div class="absolute inset-0 bg-black/60" onclick="closeImportModal()"></div>
<div class="relative w-full max-w-md p-6 rounded-2xl"
    style="background: #0F141B; border: 1px solid rgba(255,255,255,0.10);">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold" style="color: rgba(255,255,255,0.92);">游닌 Importar Datos</h3>
        <button onclick="closeImportModal()" class="p-2 rounded-lg hover:bg-white/10"
            style="color: rgba(255,255,255,0.58);">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <div class="space-y-4">
        <div class="p-8 rounded-xl text-center border-2 border-dashed"
            style="border-color: rgba(255,255,255,0.20); background: #121A23;">
            <i class="fa-solid fa-cloud-arrow-up text-3xl mb-3" style="color: #C6FF34;"></i>
            <p class="text-sm mb-2" style="color: rgba(255,255,255,0.80);">Arrastra un archivo JSON o CSV aqu칤</p>
            <p class="text-xs" style="color: rgba(255,255,255,0.42);">o haz clic para seleccionar</p>
            <input type="file" accept=".json,.csv" class="hidden" id="import-file-input"
                onchange="handleFileImport(this)">
            <button onclick="document.getElementById('import-file-input').click()"
                class="mt-4 px-4 py-2 text-sm font-medium rounded-lg" style="background: #C6FF34; color: #0B0F14;">
                Seleccionar Archivo
            </button>
        </div>

        <p class="text-xs text-center" style="color: rgba(255,255,255,0.42);">
            Formatos soportados: JSON (exportado desde Plan Semilla), CSV
        </p>
    </div>
</div>
`;
            document.body.appendChild(modal);
        }

        function closeImportModal() {
            const modal = document.getElementById('import-modal');
            if (modal) modal.remove();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // Restore patrimonio
                    if (data.patrimonio) {
                        currentCapital = data.patrimonio;
                        const capitalInput = document.getElementById('currentCapital');
                        if (capitalInput) capitalInput.value = data.patrimonio;
                        localStorage.setItem('planSemillaCapital', data.patrimonio);
                    }

                    // Restore asset allocation
                    if (data.asignacion && data.asignacion.length > 0) {
                        // Convert export format to customAssets format
                        customAssets = data.asignacion.map(a => ({
                            name: a.name,
                            ratio: a.percentage / 100, // Convert percentage to ratio
                            color: getAssetColor(a.name)
                        }));
                        currentMode = 'custom';

                        // Update allocation chart if exists
                        if (typeof updateAllocationDisplay === 'function') {
                            updateAllocationDisplay();
                        }
                    } else if (data.modo) {
                        currentMode = data.modo;
                    }

                    // Update all dashboard displays
                    updateDashboardMode();
                    closeImportModal();
                    showToast(`Datos importados: $${data.patrimonio?.toLocaleString() || 0} con ${data.asignacion?.length || 0} activos`, 'success');
                } catch (err) {
                    console.error('Import error:', err);
                    showToast('Error al importar archivo: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Context menu (3 dots)
        function showDashContextMenu(button) {
            const existing = document.getElementById('dash-context-menu');
            if (existing) {
                existing.remove();
                return;
            }

            const rect = button.getBoundingClientRect();
            const menu = document.createElement('div');
            menu.id = 'dash-context-menu';
            menu.className = 'fixed z-50 p-2 rounded-xl';
            menu.style.cssText = `
top: ${rect.bottom + 5}px;
right: ${window.innerWidth - rect.right}px;
background: #0F141B;
border: 1px solid rgba(255,255,255,0.10);
min-width: 160px;
`;
            menu.innerHTML = `
<button onclick="setMode('simulador'); closeDashContextMenu();"
    class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5 flex items-center gap-2"
    style="color: rgba(255,255,255,0.80);">
    <i class="fa-solid fa-calculator"></i> Simulador
</button>
<button onclick="setMode('rebalance'); closeDashContextMenu();"
    class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5 flex items-center gap-2"
    style="color: rgba(255,255,255,0.80);">
    <i class="fa-solid fa-scale-balanced"></i> Rebalancear
</button>
<button onclick="setMode('portfolios'); closeDashContextMenu();"
    class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5 flex items-center gap-2"
    style="color: rgba(255,255,255,0.80);">
    <i class="fa-solid fa-folder"></i> Portafolios
</button>
<div style="border-top: 1px solid rgba(255,255,255,0.06); margin: 4px 0;"></div>
<button onclick="refreshDashboardData(); closeDashContextMenu();"
    class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-white/5 flex items-center gap-2"
    style="color: #C6FF34;">
    <i class="fa-solid fa-rotate"></i> Actualizar
</button>
`;
            document.body.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target) && e.target !== button) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }

        function closeDashContextMenu() {
            const menu = document.getElementById('dash-context-menu');
            if (menu) menu.remove();
        }

        // Initialize dashboard interactions when loaded
        function initDashboardInteractions() {
            setupDashboardSearch();
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', initDashboardInteractions);

        // ===== REBALANCING CALCULATOR =====

        let rebalanceRowId = 0;

        // Initialize the rebalance calculator with default rows
        function initRebalanceCalculator() {
            const rowsContainer = document.getElementById('rebalance-rows');
            if (!rowsContainer) return;

            // Populate portfolio dropdown
            populateRebalancePortfolioDropdown();

            // If empty, add 3 default rows with asset keys
            if (rowsContainer.children.length === 0) {
                addRebalanceRow('sp500', 10000, 40);
                addRebalanceRow('bitcoin', 5000, 30);
                addRebalanceRow('bonosUI', 5000, 30);
            }

            updateRebalanceTotals();
        }

        // Available assets for dropdown
        // DYNAMICALLY GENERATED FROM simAssetData
        // Filter out aliases and custom_rate
        const rebalanceAssets = Object.keys(simAssetData)
            .filter(k => k !== 'custom_rate' && simAssetData[k].name !== k) // Exclude aliases where key == name is impossible but check content
            .filter(k => simAssetData[k].currency) // Simple check to ensure it's a real asset object
            .filter((k, i, arr) => arr.indexOf(k) === i) // Unique check (though keys are unique)
            .filter(k => !k.includes(' ')) // Filter out "S&P 500" keys (aliases)
            .map(k => ({ key: k, name: simAssetData[k].name }));


        // Build options HTML for dropdown
        // Helper to generate grouped options string
        function getGroupedAssetOptionsHtml(selectedKey = '', valueIsName = false) {
            const groups = {
                'Acciones': [],
                'Crypto': [],
                'Renta Fija': [],
                'Otros': []
            };

            const assets = (typeof rebalanceAssets !== 'undefined') ? rebalanceAssets : [];

            assets.forEach(asset => {
                const data = simAssetData[asset.key];
                if (!data) return; // Should not happen given rebalanceAssets filter

                if (['sp500', 'nasdaq', 'vt', 'smh', 'schd', 'vnq', 'vwo'].includes(asset.key)) groups['Acciones'].push(asset);
                else if (['bitcoin', 'ethereum', 'solana'].includes(asset.key)) groups['Crypto'].push(asset);
                else if (['fondoLiquidez', 'bonosUI', 'bonosTesoro', 'cash'].includes(asset.key)) groups['Renta Fija'].push(asset);
                else groups['Otros'].push(asset);
            });

            let html = '';
            for (const [label, groupAssets] of Object.entries(groups)) {
                if (groupAssets.length > 0) {
                    html += `<optgroup label="${label}">`;
                    groupAssets.forEach(asset => {
                        const val = valueIsName ? asset.name : asset.key;
                        const isSelected = (val === selectedKey);
                        html += `<option value="${val}" ${isSelected ? 'selected' : ''}>${simAssetData[asset.key].emoji} ${asset.name}</option>`;
                    });
                    html += `</optgroup>`;
                }
            }
            return html;
        }

        // Build options HTML for dropdown (Legacy wrapper for table rows)
        function getAssetOptionsHtml(selectedKey = '') {
            return getGroupedAssetOptionsHtml(selectedKey, false);
        }

        // Add a new row to the rebalance table
        function addRebalanceRow(assetKey = '', value = 0, target = 0) {
            const rowsContainer = document.getElementById('rebalance-rows');
            if (!rowsContainer) return;

            rebalanceRowId++;
            const rowId = rebalanceRowId;

            const row = document.createElement('tr');
            row.id = `rebalance-row-${rowId}`;
            row.className = 'border-b border-slate-100 hover:bg-slate-50 transition';
            row.innerHTML = `
<td class="py-2 px-2">
    <select
        class="rebalance-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm bg-white"
        oninput="updateRebalanceTotals()">
        <option value="">Seleccionar activo...</option>
        ${getAssetOptionsHtml(assetKey)}
    </select>
</td>
<td class="py-2 px-2">
    <input type="number" placeholder="0" value="${value}" min="0" step="100"
        class="rebalance-value w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-right text-sm"
        oninput="updateRebalanceTotals()">
</td>
<td class="py-2 px-2">
    <div class="relative">
        <input type="number" placeholder="0" value="${target}" min="0" max="100" step="1"
            class="rebalance-target w-full px-3 py-2 pr-8 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-right text-sm"
            oninput="updateRebalanceTotals()">
        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">%</span>
    </div>
</td>
<td class="py-2 px-2 text-right">
    <span class="rebalance-ideal text-sm text-slate-400 font-medium">-</span>
</td>
<td class="py-2 px-2 text-center">
    <button onclick="removeRebalanceRow(${rowId})"
        class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition">
        <i class="fa-solid fa-trash-can"></i>
    </button>
</td>
`;

            rowsContainer.appendChild(row);
            updateRebalanceTotals();
        }

        // Load rebalance table from a predefined strategy
        function loadRebalanceFromStrategy(strategyType) {
            // Clear current rows
            const rowsContainer = document.getElementById('rebalance-rows');
            if (rowsContainer) rowsContainer.innerHTML = '';
            rebalanceRowId = 0;

            // Map display names to asset keys for custom assets
            const nameToKey = {
                'S&P 500': 'sp500',
                'Bitcoin': 'bitcoin',
                'Ethereum': 'ethereum',
                'Nasdaq 100': 'nasdaq',
                'Fondo Liquidez': 'fondoLiquidez',
                'Bonos UI': 'bonosUI',
                'Bonos USA': 'bonosTesoro',
                'Oro': 'gold',
                'Efectivo': 'efectivo'
            };

            // Build custom allocation from customAssets array if it exists
            let customAllocation = {};
            if (typeof customAssets !== 'undefined' && Array.isArray(customAssets) && customAssets.length > 0) {
                customAssets.forEach(asset => {
                    const key = nameToKey[asset.name] || asset.name.toLowerCase().replace(/\s+/g, '');
                    const pct = Math.round((asset.ratio || 0) * 100);
                    if (pct > 0) {
                        customAllocation[key] = pct;
                    }
                });
            }

            // Define strategy allocations
            const strategyAllocations = {
                normal: { sp500: 60, fondoLiquidez: 40 },
                sovereign: { bitcoin: 35, sp500: 45, fondoLiquidez: 20 },
                custom: customAllocation
            };

            const allocation = strategyAllocations[strategyType] || {};

            // Create rows for each asset in the strategy
            for (const [assetKey, percentage] of Object.entries(allocation)) {
                if (percentage > 0) {
                    addRebalanceRow(assetKey, 0, percentage);
                }
            }

            // If custom and empty, show message
            if (strategyType === 'custom' && Object.keys(allocation).length === 0) {
                alert('No hay una estrategia personalizada definida. Primero crea una en el modo Personalizado.');
                // Add default row
                addRebalanceRow('', 0, 0);
            }

            updateRebalanceTotals();

            // Hide results if visible
            document.getElementById('rebalance-results')?.classList.add('hidden');
        }

        // Save current rebalance state to localStorage
        function saveRebalanceState() {
            const rows = document.querySelectorAll('#rebalance-rows tr');
            const state = [];

            rows.forEach(row => {
                const nameSelect = row.querySelector('.rebalance-name');
                const valueInput = row.querySelector('.rebalance-value');
                const targetInput = row.querySelector('.rebalance-target');

                if (nameSelect && valueInput && targetInput) {
                    state.push({
                        asset: nameSelect.value,
                        value: parseFloat(valueInput.value) || 0,
                        target: parseFloat(targetInput.value) || 0
                    });
                }
            });

            if (state.length === 0) {
                alert('No hay datos para guardar');
                return;
            }

            const dataStr = JSON.stringify({
                version: 1,
                date: new Date().toISOString(),
                assets: state
            }, null, 2);

            // Download as JSON file
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rebalance-state-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Populate the portfolio dropdown with saved portfolios
        function populateRebalancePortfolioDropdown() {
            const select = document.getElementById('rebalance-portfolio-select');
            if (!select) return;

            // Get saved portfolios
            const portfoliosData = getSavedPortfolios();
            const portfolios = portfoliosData.portfolios || [];

            // Clear existing options (keep the first placeholder)
            select.innerHTML = '<option value="">游늬 Mis Portfolios...</option>';

            // Add each portfolio as an option
            portfolios.forEach(portfolio => {
                const option = document.createElement('option');
                option.value = portfolio.id;
                option.textContent = portfolio.name || 'Sin nombre';
                select.appendChild(option);
            });
        }

        // Load a saved portfolio into the rebalance table
        function loadRebalanceFromPortfolio(portfolioId) {
            if (!portfolioId) return;

            // Get saved portfolios
            const portfoliosData = getSavedPortfolios();
            const portfolio = portfoliosData.portfolios.find(p => p.id === portfolioId);

            if (!portfolio || !portfolio.data || !portfolio.data.assets) {
                alert('Portfolio no encontrado o inv치lido');
                return;
            }

            // Clear current rows
            const rowsContainer = document.getElementById('rebalance-rows');
            if (rowsContainer) rowsContainer.innerHTML = '';
            rebalanceRowId = 0;

            // Map display names to asset keys
            const nameToKey = {
                'S&P 500': 'sp500',
                'Bitcoin': 'bitcoin',
                'Ethereum': 'ethereum',
                'Nasdaq 100': 'nasdaq',
                'Fondo Liquidez': 'fondoLiquidez',
                'Bonos UI': 'bonosUI',
                'Bonos USA': 'bonosTesoro',
                'Oro': 'gold',
                'Efectivo': 'efectivo'
            };

            // Load each asset from the portfolio
            const assets = portfolio.data.assets;
            for (const [assetName, percentage] of Object.entries(assets)) {
                if (percentage > 0) {
                    // Convert display name to key, or use as-is if already a key
                    const assetKey = nameToKey[assetName] || assetName.toLowerCase().replace(/\s+/g, '');
                    addRebalanceRow(assetKey, 0, percentage); // Value = 0, Target = percentage
                }
            }

            // If no assets loaded, add empty row
            if (Object.keys(assets).length === 0) {
                addRebalanceRow('', 0, 0);
            }

            updateRebalanceTotals();

            // Hide results if visible
            document.getElementById('rebalance-results')?.classList.add('hidden');

            // Reset dropdown
            document.getElementById('rebalance-portfolio-select').value = '';
        }

        // Remove a row from the rebalance table
        function removeRebalanceRow(rowId) {
            const row = document.getElementById(`rebalance-row-${rowId}`);
            if (row) {
                row.remove();
                updateRebalanceTotals();
            }
        }

        // Update totals and validation bar
        function updateRebalanceTotals() {
            const rows = document.querySelectorAll('#rebalance-rows tr');
            let totalValue = 0;
            let totalPct = 0;

            // Get new money input
            const newMoney = parseFloat(document.getElementById('rebalance-new-money')?.value) || 0;
            const totalFuture = totalValue + newMoney; // Will be updated after first pass

            // First pass: calculate total value and percentage
            rows.forEach(row => {
                const valueInput = row.querySelector('.rebalance-value');
                const targetInput = row.querySelector('.rebalance-target');

                if (valueInput && targetInput) {
                    totalValue += parseFloat(valueInput.value) || 0;
                    totalPct += parseFloat(targetInput.value) || 0;
                }
            });

            // Calculate total future (actual + new money)
            const patrimonioFuturo = totalValue + newMoney;

            // Second pass: update Meta $ for each row based on FUTURE patrimony
            rows.forEach(row => {
                const targetInput = row.querySelector('.rebalance-target');
                const idealSpan = row.querySelector('.rebalance-ideal');

                if (targetInput && idealSpan) {
                    const targetPct = parseFloat(targetInput.value) || 0;
                    if (patrimonioFuturo > 0 && targetPct > 0) {
                        const idealValue = patrimonioFuturo * (targetPct / 100);
                        idealSpan.textContent = '$' + idealValue.toLocaleString('es-UY', {
                            maximumFractionDigits: 0
                        });
                    } else {
                        idealSpan.textContent = '-';
                    }
                }
            });

            // Update total displays
            document.getElementById('rebalance-total-value').textContent = '$' +
                totalValue.toLocaleString('es-UY');
            document.getElementById('rebalance-total-pct').textContent = totalPct + '%';

            // Update new money display
            const newMoneyDisplay = document.getElementById('rebalance-new-money-display');
            if (newMoneyDisplay) {
                newMoneyDisplay.textContent = '+$' + newMoney.toLocaleString('es-UY');
            }

            // Update future total
            const totalFutureEl = document.getElementById('rebalance-total-future');
            if (totalFutureEl) {
                totalFutureEl.textContent = '$' + patrimonioFuturo.toLocaleString('es-UY');
            }

            // Update total ideal (should equal future value when 100%)
            const totalIdealEl = document.getElementById('rebalance-total-ideal');
            if (totalIdealEl) {
                if (totalPct === 100) {
                    totalIdealEl.textContent = '$' + patrimonioFuturo.toLocaleString('es-UY');
                } else {
                    totalIdealEl.textContent = '-';
                }
            }

            // Update validation bar
            const bar = document.getElementById('rebalance-pct-bar');
            const status = document.getElementById('rebalance-pct-status');
            const totalPctEl = document.getElementById('rebalance-total-pct');

            const pctWidth = Math.min(totalPct, 100);
            bar.style.width = pctWidth + '%';

            if (totalPct === 100) {
                bar.className = 'h-full bg-green-500 transition-all duration-300';
                status.className = 'font-bold text-green-600';
                status.textContent = '100% 九 Perfecto';
                totalPctEl.className = 'text-right py-2 px-2 font-bold text-green-600';
            } else if (totalPct < 100) {
                bar.className = 'h-full bg-amber-500 transition-all duration-300';
                status.className = 'font-bold text-amber-600'; status.textContent = `${totalPct}% (Falta ${100 - totalPct}%)`;
                totalPctEl.className = 'text-right py-2 px-2 font-bold text-amber-600';
            } else {
                bar.className = 'h-full bg-red-500 transition-all duration-300'; status.className = 'font-bold text-red-600';
                status.textContent = `${totalPct}% (Sobra ${totalPct - 100}%)`;
                totalPctEl.className = 'text-right py-3 px-2 font-bold text-red-600';
            }
        } // Calculate and display rebalancing actions

        function calculateRebalance() {
            const rows = document.querySelectorAll('#rebalance-rows tr');
            const assets = [];
            let totalValue = 0;
            let totalPct = 0;

            // Collect data
            rows.forEach(row => {
                const nameSelect = row.querySelector('.rebalance-name');
                const valueInput = row.querySelector('.rebalance-value');
                const targetInput = row.querySelector('.rebalance-target');

                if (nameSelect && valueInput && targetInput) {
                    const assetKey = nameSelect.value;
                    // Get display name from the dropdown's selected option
                    const displayName = nameSelect.options[nameSelect.selectedIndex]?.text || assetKey || 'Sin nombre';
                    const currentValue = parseFloat(valueInput.value) || 0;
                    const targetPct = parseFloat(targetInput.value) || 0;

                    assets.push({ name: displayName, assetKey, currentValue, targetPct });
                    totalValue += currentValue;
                    totalPct += targetPct;
                }
            });

            // Validate
            if (assets.length === 0) {
                alert('Agrega al menos un activo para calcular');
                return;
            }

            if (totalPct !== 100) {
                alert(`La suma de las metas debe ser 100 %.Actualmente es ${totalPct}% `);
                return;
            }

            // Get new money input for future patrimony calculation
            const newMoney = parseFloat(document.getElementById('rebalance-new-money')?.value) || 0;
            const patrimonioFuturo = totalValue + newMoney;

            // Calculate ideal values and differences based on FUTURE patrimony
            let totalBuy = 0;
            let totalSell = 0;

            const actions = assets.map(asset => {
                const idealValue = patrimonioFuturo * (asset.targetPct / 100);
                const difference = idealValue - asset.currentValue;

                let action, actionClass, icon;

                if (difference > 50) {
                    action = `COMPRAR $${Math.abs(difference).toLocaleString('es-UY', {
                        maximumFractionDigits: 0
                    })
                        } `;
                    actionClass = 'text-green-600 bg-green-50 border-green-200';
                    icon = '游릭';
                    totalBuy += difference;
                } else if (difference < -50) {
                    action = `VENDER $${Math.abs(difference).toLocaleString('es-UY', {
                        maximumFractionDigits: 0
                    })}`; actionClass = 'text-red-600 bg-red-50 border-red-200'; icon = '游댮'; totalSell
                        += Math.abs(difference);
                } else {
                    action = 'Mantener'; actionClass = 'text-slate-600 bg-slate-50 border-slate-200';
                    icon = '九';
                } return {
                    name: asset.name, currentValue: asset.currentValue, idealValue, difference, action,
                    actionClass, icon, targetPct: asset.targetPct
                };
            }); // Render results const
            actionsContainer = document.getElementById('rebalance-actions'); actionsContainer.innerHTML = actions.map(a => `
        <div class="flex items-center justify-between p-4 rounded-xl border-2 ${a.actionClass}">
            <div class="flex-1">
                <div class="font-bold text-slate-800">${a.icon} ${a.name}</div>
                <div class="text-sm text-slate-500">
                    Actual: $${a.currentValue.toLocaleString('es-UY')} 
                    Ideal: $${a.idealValue.toLocaleString('es-UY', {
                maximumFractionDigits:
                    0
            })} (${a.targetPct}%)
                </div>
            </div>
            <div class="text-right font-bold text-lg">${a.action}</div>
        </div>
        `).join('');

            // Update summary
            document.getElementById('rebalance-total-buy').textContent = '$' +
                totalBuy.toLocaleString('es-UY', { maximumFractionDigits: 0 });
            document.getElementById('rebalance-total-sell').textContent = '$' +
                totalSell.toLocaleString('es-UY', { maximumFractionDigits: 0 });

            // Show results card
            document.getElementById('rebalance-results').classList.remove('hidden');

            // Scroll to results
            document.getElementById('rebalance-results').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Make rebalance functions globally accessible for onclick handlers
        window.loadRebalanceFromStrategy = loadRebalanceFromStrategy;
        window.loadRebalanceFromPortfolio = loadRebalanceFromPortfolio;
        window.addRebalanceRow = addRebalanceRow;
        window.removeRebalanceRow = removeRebalanceRow;
        window.updateRebalanceTotals = updateRebalanceTotals;
        window.calculateRebalance = calculateRebalance;
        window.saveRebalanceState = saveRebalanceState;
        window.populateRebalancePortfolioDropdown = populateRebalancePortfolioDropdown;
        window.initRebalanceCalculator = initRebalanceCalculator;

        function initSimulator() {
            // Get shared values from first scenario inputs
            const updateSharedValues = () => {
                const capital = parseFloat(document.getElementById('sim-capital')?.value) || 45000;
                const aporte = parseFloat(document.getElementById('sim-aporte')?.value) || 2000;
                const years = parseInt(document.getElementById('sim-years')?.value) || 10;

                scenarios.forEach(s => {
                    s.capital = capital;
                    s.aporte = aporte;
                    s.years = years;
                });

                updateAllSimulations();
            };

            // Attach listeners to first scenario inputs
            ['sim-capital', 'sim-aporte', 'sim-years'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateSharedValues);
                }
            });

            renderScenarios();
        }

        // --- 10. LIVE PRICES ---

        // Fallback prices (updated periodically)
        const FALLBACK_PRICES = {
            btc: { price: 98000, change: 1.5 },
            eth: { price: 3400, change: 2.1 },
            sol: { price: 195, change: 3.2 },
            gold: { price: 2650, change: 0.3 },
            sp500: { price: 6000, change: 0.5 }
        };

        // Rate limit tracking
        let lastFetchTime = 0;
        const MIN_FETCH_INTERVAL = 30000; // 30 seconds minimum between fetches
        let fetchRetryCount = 0;
        const MAX_RETRIES = 3;

        async function fetchAllPrices() {
            // First, immediately show fallback prices so UI isn't empty
            showFallbackPrices();

            // Check if we should skip fetching (rate limit protection)
            const now = Date.now();
            if (now - lastFetchTime < MIN_FETCH_INTERVAL) {
                console.log('[Prices] Skipping fetch - rate limit protection');
                return;
            }
            lastFetchTime = now;

            try {
                // STRATEGY 1: Try backend proxy first (avoids CORS issues)
                if (useBackend || await tryBackendPrices()) {
                    return; // Success via backend
                }

                // STRATEGY 2: Direct CoinGecko (may have CORS issues from localhost)
                console.log('[Prices] Backend unavailable, trying direct API...');
                await fetchDirectFromCoinGecko();

            } catch (error) {
                handleFetchError(error);
            }
        }

        async function tryBackendPrices() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${API_BASE_URL}/prices`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Backend HTTP ${response.status}`);
                }

                const data = await response.json();
                fetchRetryCount = 0;

                // Update all prices from backend response
                if (data.bitcoin) {
                    updatePriceUI('btc', data.bitcoin.price, data.bitcoin.change_24h);
                }
                if (data.ethereum) {
                    updatePriceUI('eth', data.ethereum.price, data.ethereum.change_24h);
                }
                if (data.solana) {
                    updatePriceUI('sol', data.solana.price, data.solana.change_24h);
                }
                if (data.gold) {
                    updatePriceUI('gold', data.gold.price, data.gold.change_24h);
                }
                if (data.sp500) {
                    updatePriceUI('sp500', data.sp500.price, data.sp500.change_24h, false);
                }

                const suffix = data.cached ? ' (cached)' : '';
                updatePriceTimestamp(suffix);
                console.log('[Prices] 九 Prices updated via backend' + suffix);
                return true;

            } catch (error) {
                console.log('[Prices] Backend proxy failed:', error.message);
                return false;
            }
        }

        async function fetchDirectFromCoinGecko() {
            const cryptoUrl = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,tether-gold&vs_currencies=usd&include_24hr_change=true';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            const response = await fetch(cryptoUrl, {
                signal: controller.signal,
                headers: { 'Accept': 'application/json' }
            });
            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`CoinGecko HTTP ${response.status}`);
            }

            const data = await response.json();
            fetchRetryCount = 0;

            if (data.bitcoin) {
                updatePriceUI('btc', data.bitcoin.usd, data.bitcoin.usd_24h_change);
            }
            if (data.ethereum) {
                updatePriceUI('eth', data.ethereum.usd, data.ethereum.usd_24h_change);
            }
            if (data.solana) {
                updatePriceUI('sol', data.solana.usd, data.solana.usd_24h_change);
            }
            if (data['tether-gold']) {
                updatePriceUI('gold', data['tether-gold'].usd, data['tether-gold'].usd_24h_change);
            }
            updatePriceUI('sp500', FALLBACK_PRICES.sp500.price, FALLBACK_PRICES.sp500.change, false);

            updatePriceTimestamp();
            console.log('[Prices] 九 Prices updated via direct API');
        }

        function handleFetchError(error) {
            fetchRetryCount++;
            console.warn(`[Prices] Fetch failed (attempt ${fetchRetryCount}/${MAX_RETRIES}):`, error.message);

            if (fetchRetryCount < MAX_RETRIES) {
                const retryDelay = Math.min(5000 * Math.pow(2, fetchRetryCount), 30000);
                console.log(`[Prices] Retrying in ${retryDelay / 1000}s...`);
                setTimeout(fetchAllPrices, retryDelay);
            } else {
                console.log('[Prices] Max retries reached, using fallback data');
                updatePriceTimestamp('(datos hist칩ricos)');
            }
        }

        function showFallbackPrices() {
            // Show fallback prices immediately so UI is never empty
            Object.entries(FALLBACK_PRICES).forEach(([asset, data]) => {
                updatePriceUI(asset, data.price, data.change, asset !== 'sp500');
            });
        }

        function updatePriceTimestamp(suffix = '') {
            const now = new Date();
            const updatedEl = document.getElementById('markets-updated');
            if (updatedEl) {
                updatedEl.innerHTML = '<i class="fa-solid fa-clock"></i> ' +
                    now.toLocaleTimeString('es-UY', { hour: '2-digit', minute: '2-digit' }) +
                    (suffix ? ' ' + suffix : '');
            }
        }

        function updatePriceUI(asset, price, change, showDecimals = true) {
            const formattedPrice = showDecimals
                ? '$' + price.toLocaleString('en-US', { maximumFractionDigits: 0 })
                : price.toLocaleString('en-US', { maximumFractionDigits: 0 });

            // Update ALL price elements with matching data-price attribute
            document.querySelectorAll(`[data-price="${asset}"]`).forEach(el => {
                el.textContent = formattedPrice;
            });

            // Update ALL change elements with matching data-change attribute
            const changeText = change >= 0 ? '+' + change.toFixed(2) + '%' : change.toFixed(2) +
                '%';
            const changeClass = change >= 0
                ? 'text-xs font-medium px-1.5 py-0.5 rounded bg-green-500/20 text-green-400'
                : 'text-xs font-medium px-1.5 py-0.5 rounded bg-red-500/20 text-red-400';

            document.querySelectorAll(`[data-change="${asset}"]`).forEach(el => {
                el.textContent = changeText;
                el.className = changeClass;
            });
        }

        // Refresh prices every 60 seconds
        setInterval(fetchAllPrices, 60000);

        // --- 10. BACKEND INTEGRATION ---

        let currentPortfolioId = 1; // Default portfolio ID

        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                if (response.ok) {
                    useBackend = true;
                    updateBackendStatus(true);
                    document.getElementById('transactions-section').classList.remove('hidden');
                    loadTransactions();
                    return true;
                }
            } catch (e) {
                console.log('Backend not available, using local mode');
            }
            useBackend = false;
            updateBackendStatus(false);
            return false;
        }

        function updateBackendStatus(connected) {
            const statusEl = document.getElementById('backend-status');
            const textEl = document.getElementById('backend-status-text');

            if (connected) {
                statusEl.className = 'mb-4 p-3 rounded-lg text-center text-sm bg-emerald-50 text-emerald-700 border border-emerald-200';
                textEl.innerHTML = '<i class="fa-solid fa-circle-check mr-1"></i> Backend conectado - Modo seguro activo';
            } else {
                statusEl.className = 'mb-4 p-3 rounded-lg text-center text-sm bg-amber-50 text-amber-700 border border-amber-200';
                textEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> Backend no disponible - Ejecuta: python backend/app.py';
            }
        }

        async function loadTransactions() {
            if (!useBackend) return;

            try {
                const response = await
                    fetch(`${API_BASE_URL}/portfolios/${currentPortfolioId}/transactions`);
                const transactions = await response.json();
                renderTransactions(transactions);
            } catch (e) {
                console.error('Error loading transactions:', e);
            }
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactions-list');

            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
        <p class="text-center text-slate-400 text-sm py-4">
            <i class="fa-solid fa-inbox"></i> No hay transacciones registradas
        </p>
        `;
                return;
            }

            container.innerHTML = transactions.map(t => {
                const typeColors = {
                    'buy': 'bg-emerald-100 text-emerald-700',
                    'sell': 'bg-red-100 text-red-700',
                    'contribution': 'bg-blue-100 text-blue-700'
                };
                const typeLabels = {
                    'buy': 'Compra',
                    'sell': 'Venta',
                    'contribution': 'Aporte'
                };
                const date = new Date(t.date).toLocaleDateString('es-UY');

                return `
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
            <div class="flex items-center gap-3">
                <span
                    class="px-2 py-1 text-xs font-bold rounded ${typeColors[t.type] || 'bg-slate-100'}">${typeLabels[t.type]
                    || t.type}</span>
                <div>
                    <div class="font-medium text-slate-700">${t.asset_name}</div>
                    <div class="text-xs text-slate-400">${date} ${t.notes ? ' ' + t.notes :
                        ''}</div>
                </div>
            </div>
            <div class="text-right">
                <div class="font-bold text-slate-700">${formatCurrency(t.amount)}</div>
                <button onclick="deleteTransaction(${t.id})" class="text-xs text-red-400 hover:text-red-600">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </div>
        `;
            }).join('');
        }

        async function addTransaction() {
            if (!useBackend) {
                alert('Backend no disponible. Ejecuta: python backend/app.py');
                return;
            }

            const asset = document.getElementById('txn-asset').value;
            const type = document.getElementById('txn-type').value;
            const amount = parseFloat(document.getElementById('txn-amount').value);
            const date = document.getElementById('txn-date').value;
            const notes = document.getElementById('txn-notes').value;

            if (!amount || amount <= 0) {
                alert('Ingresa un monto v치lido');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/portfolios/${currentPortfolioId}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        asset_name: asset,
                        type: type,
                        amount: amount,
                        date: date || new Date().toISOString(),
                        notes: notes
                    })
                });

                if (response.ok) {
                    // Clear form
                    document.getElementById('txn-amount').value = '';
                    document.getElementById('txn-notes').value = '';
                    // Reload transactions
                    loadTransactions();
                } else {
                    alert('Error al guardar la transacci칩n');
                }
            } catch (e) {
                console.error('Error adding transaction:', e);
                alert('Error de conexi칩n');
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('쮼liminar esta transacci칩n?')) return;
            try {
                await fetch(`${API_BASE_URL}/transactions/${id}`, { method: 'DELETE' });
                loadTransactions();
            } catch (e) {
                console.error('Error deleting transaction:', e);
            }
        }

        // --- INITIALIZATION ---
        // --- 10. BACKTESTING (TIME MACHINE) ---

        let backtestChartInstance = null;
        let backtestMode = 'asset'; // 'asset' or 'strategy'

        // Toggle between asset and strategy backtest modes
        function setBacktestMode(mode) {
            backtestMode = mode;
            const assetBtn = document.getElementById('bt-mode-asset');
            const strategyBtn = document.getElementById('bt-mode-strategy');
            const assetSelector = document.getElementById('bt-asset-selector');
            const strategySelector = document.getElementById('bt-strategy-selector');
            const rebalanceRow = document.getElementById('bt-rebalance-row');
            const ghostRow = document.getElementById('bt-ghost-row');

            if (mode === 'asset') {
                assetBtn.className = 'flex-1 py-2.5 px-4 rounded-xl border-2 border-purple-500 bg-purple-50 text-purple-700 font-bold text-sm transition shadow-sm hover:shadow-md';
                strategyBtn.className = 'flex-1 py-2.5 px-4 rounded-xl border-2 border-slate-200 bg-white text-slate-600 font-bold text-sm transition hover:border-purple-300 hover:shadow-md';
                assetSelector.classList.remove('hidden');
                strategySelector.classList.add('hidden');
                if (rebalanceRow) rebalanceRow.classList.add('hidden');
                if (ghostRow) ghostRow.classList.add('hidden');
            } else {
                assetBtn.className = 'flex-1 py-2.5 px-4 rounded-xl border-2 border-slate-200 bg-white text-slate-600 font-bold text-sm transition hover:border-purple-300 hover:shadow-md';
                strategyBtn.className = 'flex-1 py-2.5 px-4 rounded-xl border-2 border-purple-500 bg-purple-50 text-purple-700 font-bold text-sm transition shadow-sm hover:shadow-md';
                assetSelector.classList.add('hidden');
                strategySelector.classList.remove('hidden');
                if (rebalanceRow) rebalanceRow.classList.remove('hidden');
                if (ghostRow) ghostRow.classList.remove('hidden');
                updateStrategyPreview();
            }
        }

        // Get current strategy assets
        function getCurrentStrategyAssets() {
            if (currentMode === 'custom') {
                return customAssets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    key: assetNameToKey[a.name] || null
                }));
            } else {
                return config[currentMode].assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    key: assetNameToKey[a.name] || null
                }));
            }
        }

        // Update strategy preview in the UI
        function updateStrategyPreview() {
            const strategyId = document.getElementById('bt-strategy').value;
            let assets = [];

            if (strategyId === 'current') {
                assets = getCurrentStrategyAssets();
            } else if (strategyId === 'normal') {
                assets = config.normal.assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    key: assetNameToKey[a.name]
                }));
            } else if (strategyId === 'sovereign') {
                assets = config.sovereign.assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    key: assetNameToKey[a.name]
                }));
            }

            const composition = document.getElementById('bt-strategy-composition');
            if (assets.length === 0) {
                composition.innerHTML = '<span class="text-slate-400">No hay activos definidos</span>';
            } else {
                composition.innerHTML = assets.map(a =>
                    `<span class="inline-block bg-white px-2 py-1 rounded mr-1 mb-1">${a.name}: ${(a.ratio *
                        100).toFixed(0)}%</span>`
                ).join('');
            }
        }

        // Add event listener for strategy selector change
        document.addEventListener('DOMContentLoaded', function () {
            const strategySelect = document.getElementById('bt-strategy');
            if (strategySelect) {
                strategySelect.addEventListener('change', updateStrategyPreview);
            }
        });

        function runBacktest() {
            const initialAmount = parseFloat(document.getElementById('bt-amount').value) ||
                0;
            const monthlyContribution =
                parseFloat(document.getElementById('bt-monthly').value) || 0;
            const yearsBack = parseInt(document.getElementById('bt-years-slider').value) ||
                5;
            const showRealReturn = document.getElementById('bt-real-return-toggle')?.checked
                ?? true;
            const currencyPerspective =
                document.getElementById('bt-currency-perspective')?.value || 'local';

            // Check if we're in portfolio mode
            if (backtestMode === 'strategy') {
                runPortfolioBacktest();
                return;
            }

            // Individual asset mode
            const asset = document.getElementById('bt-asset').value;

            if (initialAmount <= 0 && monthlyContribution <= 0) {
                showNotification('Ingresa al menos una inversi칩n inicial o aporte mensual', 'Error', 'error');
                return;
            }

            if (!historicalData[asset]) {
                showNotification('Datos no disponibles para este activo', 'Error', 'error');
                return;
            }

            // Calculate start date based on years back
            const now = new Date();
            const startYear = now.getFullYear() - yearsBack;
            const startMonth = String(now.getMonth() + 1).padStart(2, '0');
            const startDate = `${startYear}-${startMonth}`;

            // Get all data for this asset
            const allData = historicalData[asset];

            // Filter data from start date to latest available
            let assetData = allData.filter(d => d.date >= startDate);

            // If no data from exact start date, find closest available
            if (assetData.length === 0) {
                // Try to get data from earliest available
                const sortedData = [...allData].sort((a, b) => a.date.localeCompare(b.date));
                assetData = sortedData;
            }

            if (assetData.length < 2) {
                showNotification('No hay suficientes datos hist칩ricos para este periodo', 'Error', 'error');
                return;
            }

            // Sort data by date to ensure chronological order
            assetData.sort((a, b) => a.date.localeCompare(b.date));

            // Get asset metadata
            const assetMeta = historicalAssetMeta[asset] || {};
            const isUSDAsset = assetMeta.currency === 'USD';
            const dividendYield = assetConfig?.dividendYields?.[asset] || 0;
            const monthlyDividend = dividendYield / 12 / 100;

            // DCA Calculation: simulate buying each month
            let totalUnits = 0;
            let totalInvested = initialAmount;
            const portfolioHistory = [];

            // Buy initial amount at first price
            if (initialAmount > 0) {
                totalUnits = initialAmount / assetData[0].price;
            }

            portfolioHistory.push({
                date: assetData[0].date,
                value: totalUnits * assetData[0].price,
                invested: totalInvested
            });

            // Process each subsequent month
            for (let i = 1; i < assetData.length; i++) {
                const currentPrice = assetData[i].price;
                // Add dividend reinvestment (for equity assets)
                if (dividendYield > 0) {
                    totalUnits *= (1 + monthlyDividend);
                }

                // Add monthly contribution
                if (monthlyContribution > 0) {
                    const unitsBought = monthlyContribution / currentPrice;
                    totalUnits += unitsBought;
                    totalInvested += monthlyContribution;
                }

                portfolioHistory.push({
                    date: assetData[i].date,
                    value: totalUnits * currentPrice,
                    invested: totalInvested
                });
            }

            const startDateActual = assetData[0].date;
            const endDateActual = assetData[assetData.length - 1].date;
            const finalValue = portfolioHistory[portfolioHistory.length -
                1].value;
            const totalReturn = totalInvested > 0 ? ((finalValue -
                totalInvested) / totalInvested) * 100 : 0;
            const netGain = finalValue - totalInvested;

            // Calculate CAGR
            const startD = new Date(startDateActual + '-01');
            const endD = new Date(endDateActual + '-01');
            const yearsDiff = Math.max((endD - startD) / (1000 * 60 * 60 * 24 *
                365.25), 0.1);
            const cagr = totalInvested > 0 ? (Math.pow(finalValue /
                totalInvested, 1 / yearsDiff) - 1) * 100 : 0;

            // ===== REAL RETURN CALCULATION =====
            let realReturn = null;
            let inflationRate = null;
            let realGain = null;
            let realExplanation = '';
            let currencyLabel = isUSDAsset ? 'USD' : 'UYU';

            if (showRealReturn) {
                if (currencyPerspective === 'local') {
                    // PERSPECTIVE: Uruguayan investor (all values in UYU purchasing power)
                    currencyLabel = 'UYU';

                    if (isUSDAsset) {
                        // For USD assets: Convert to UYU, then adjust for UY inflation
                        // Step 1: Get exchange rates at start and end
                        const startExchangeRate =
                            FinancialUtils._findClosestPrice(historicalData.dolarUruguay,
                                startDateActual) || 1;
                        const endExchangeRate =
                            FinancialUtils._findClosestPrice(historicalData.dolarUruguay,
                                endDateActual) || 1;

                        // Step 2: Convert portfolio values to UYU
                        const investedUYU = totalInvested * startExchangeRate;
                        const finalValueUYU = finalValue * endExchangeRate;

                        // Step 3: Calculate nominal return in UYU
                        const nominalReturnUYU = ((finalValueUYU - investedUYU) /
                            investedUYU) * 100;

                        // Step 4: Get UY inflation
                        inflationRate = FinancialUtils.getInflationRateUY(startDateActual,
                            endDateActual);

                        // Step 5: Calculate real return in UYU
                        if (inflationRate !== null) {
                            realReturn = FinancialUtils.getRealReturn(nominalReturnUYU,
                                inflationRate);
                            realGain = (investedUYU * (1 + realReturn / 100)) - investedUYU;
                        }

                        realExplanation = `USD ${formatCurrency(totalInvested)} 칑
                        $${startExchangeRate.toFixed(2)}  $${endExchangeRate.toFixed(2)},
                        menos ${inflationRate?.toFixed(1) || '?'}% inflaci칩n UY`;
                    } else {
                        // For UYU assets: Just adjust for UY inflation directly
                        inflationRate = FinancialUtils.getInflationRateUY(startDateActual,
                            endDateActual);

                        if (inflationRate !== null) {
                            realReturn = FinancialUtils.getRealReturn(totalReturn,
                                inflationRate);
                            realGain = (totalInvested * (1 + realReturn / 100)) - totalInvested;
                        }

                        realExplanation = `Retorno ${totalReturn.toFixed(1)}% menos
                        ${inflationRate?.toFixed(1) || '?'}% inflaci칩n UY`;
                    }
                } else {
                    // PERSPECTIVE: USD purchasing power (for comparison with US investors)
                    currencyLabel = 'USD';

                    if (isUSDAsset) {
                        // For USD assets: Just adjust for US inflation
                        inflationRate = FinancialUtils.getInflationRateUS(startDateActual,
                            endDateActual);

                        if (inflationRate !== null) {
                            realReturn = FinancialUtils.getRealReturn(totalReturn,
                                inflationRate);
                            realGain = (totalInvested * (1 + realReturn / 100)) - totalInvested;
                        }

                        realExplanation = `Retorno ${totalReturn.toFixed(1)}% menos
                        ${inflationRate?.toFixed(1) || '?'}% inflaci칩n USA`;
                    } else {
                        // For UYU assets: Convert to USD, then adjust for US inflation
                        const startExchangeRate =
                            FinancialUtils._findClosestPrice(historicalData.dolarUruguay,
                                startDateActual) || 1;
                        const endExchangeRate =
                            FinancialUtils._findClosestPrice(historicalData.dolarUruguay,
                                endDateActual) || 1;

                        const investedUSD = totalInvested / startExchangeRate;
                        const finalValueUSD = finalValue / endExchangeRate;
                        const nominalReturnUSD = ((finalValueUSD - investedUSD) /
                            investedUSD) * 100;

                        inflationRate = FinancialUtils.getInflationRateUS(startDateActual,
                            endDateActual);

                        if (inflationRate !== null) {
                            realReturn = FinancialUtils.getRealReturn(nominalReturnUSD,
                                inflationRate);
                            realGain = (investedUSD * (1 + realReturn / 100)) - investedUSD;
                        }

                        realExplanation = `UYU convertido a USD
                        ($${startExchangeRate.toFixed(2)}  $${endExchangeRate.toFixed(2)}),
                        menos ${inflationRate?.toFixed(1) || '?'}% inflaci칩n USA`;
                    }
                }
            }

            // ===== UPDATE UI =====

            // Determine display currency based on perspective
            const displayCurrency = showRealReturn ?
                (currencyPerspective === 'local' ? 'UYU' : 'USD') :
                (isUSDAsset ? 'USD' : 'UYU');

            const currencySymbol = displayCurrency === 'UYU' ? '$U ' : 'US$ ';
            const currencyFlag = displayCurrency === 'UYU' ? '游쥟릖' : '游쥟릖';
            const currencyCode = displayCurrency;
            const inflationCountry = currencyPerspective === 'local' ? 'UY' :
                'USA';

            // Helper to format with dynamic currency
            const formatWithCurrency = (amount) => {
                const formatted = Math.abs(amount).toLocaleString('es-UY', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
                return formatted;
            };

            // Update currency indicators
            document.getElementById('bt-currency-symbol').textContent =
                currencySymbol;
            document.getElementById('bt-currency-flag').textContent =
                currencyFlag;
            document.getElementById('bt-currency-code').textContent =
                currencyCode;

            // Update all currency prefixes
            document.querySelectorAll('.bt-currency-prefix').forEach(el => {
                el.textContent = currencySymbol;
            });

            // Update nominal values
            document.getElementById('bt-total-invested').textContent =
                formatWithCurrency(totalInvested);
            document.getElementById('bt-final-value').textContent =
                formatWithCurrency(finalValue);
            document.getElementById('bt-total-return').textContent =
                (totalReturn >= 0 ? '+' : '') + totalReturn.toFixed(1) + '%';
            document.getElementById('bt-total-return').className = 'font-bold '
                + (totalReturn >= 0 ? 'text-green-400' : 'text-red-400');
            document.getElementById('bt-net-gain').textContent = (netGain >= 0 ?
                '+' : '-') + formatWithCurrency(netGain);
            document.getElementById('bt-net-gain').parentElement.className =
                'font-bold ' + (netGain >= 0 ? 'text-green-400' : 'text-red-400');
            document.getElementById('bt-cagr').textContent = cagr.toFixed(1) +
                '%';

            // Update return label based on toggle
            document.getElementById('bt-return-label').textContent =
                showRealReturn ?
                    'Retorno Nominal' : 'Retorno Total (Sin ajuste)';

            // Update Real Return section
            const realReturnSection =
                document.getElementById('bt-real-return-section');
            if (showRealReturn && realReturn !== null) {
                realReturnSection.classList.remove('hidden');

                document.getElementById('bt-inflation').textContent = '+' +
                    (inflationRate?.toFixed(1) || '?') + '%';
                document.getElementById('bt-inflation-country').textContent =
                    `(${inflationCountry})`;

                const realReturnEl = document.getElementById('bt-real-return');
                realReturnEl.textContent = (realReturn >= 0 ? '+' : '') +
                    realReturn.toFixed(1) + '%';
                realReturnEl.className = 'font-bold ' + (realReturn >= 0 ?
                    'text-green-400' : 'text-red-400');

                const realGainPrefix = currencySymbol;
                const realGainFormatted = realGain !== null ?
                    (realGainPrefix + (realGain >= 0 ? '+' : '-') + formatWithCurrency(Math.abs(realGain))) : '$?';
                document.getElementById('bt-real-gain').textContent = realGainFormatted;
                document.getElementById('bt-real-gain').className = 'font-bold text-xl ' +
                    (realGain >= 0 ? 'text-green-400' : 'text-red-400');

                document.getElementById('bt-real-explanation').textContent =
                    realExplanation;
            } else {
                realReturnSection.classList.add('hidden');
            }

            document.getElementById('bt-result-card').classList.remove('hidden');

            // Calculate and display KPI metrics (using raw asset prices)
            const endDate = portfolioHistory[portfolioHistory.length - 1]?.date
                || '';
            calculateKPIMetrics(portfolioHistory, showRealReturn ? realReturn :
                null, cagr, asset, startDate, endDate);

            // Render Chart with DCA line
            renderBacktestChart(portfolioHistory, asset);
        }

        // ===== KPI METRICS CALCULATION =====
        function calculateKPIMetrics(history, realCAGR, nominalCAGR, assetKey, startDate, endDate) {
            const kpiCards = document.getElementById('bt-kpi-cards');
            if (!kpiCards) return;

            // Show KPI cards
            kpiCards.classList.remove('hidden');

            // ===== CALCULATE FROM RAW ASSET PRICES (not DCA-smoothed portfolio) =====
            let assetPrices = [];

            if (assetKey && historicalData[assetKey]) {
                // Get raw monthly prices from the asset
                assetPrices = historicalData[assetKey]
                    .filter(d => d.date >= startDate && d.date <= endDate).sort((a, b) =>
                        a.date.localeCompare(b.date));
            }

            // Fallback to portfolio history if no asset data
            if (assetPrices.length < 2) {
                assetPrices = history.map(h => ({
                    date: h.date, price: h.value
                }));
            }

            // ===== MONTHLY RETURNS FOR VOLATILITY =====
            const monthlyReturns = [];
            for (let i = 1; i < assetPrices.length; i++) {
                const prevPrice = assetPrices[i - 1].price;
                const currPrice = assetPrices[i].price; if (prevPrice > 0) {
                    monthlyReturns.push(((currPrice - prevPrice) / prevPrice) * 100);
                }
            }

            // ===== YEARLY RETURNS FOR BEST/WORST YEAR =====
            const yearlyData = {};
            assetPrices.forEach((point) => {
                const year = point.date.split('-')[0];
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        first: point.price, last:
                            point.price
                    };
                }
                yearlyData[year].last = point.price;
            });

            const annualReturns = [];
            const years = Object.keys(yearlyData).sort();

            for (let i = 1; i < years.length; i++) {
                const year = years[i]; const prevYear = years[i
                    - 1]; const startVal = yearlyData[prevYear].last; const
                        endVal = yearlyData[year].last; if (startVal > 0) {
                            const returnPct = ((endVal - startVal) / startVal) * 100;
                            annualReturns.push({ year, return: returnPct });
                        }
            }

            // Best/Worst Year
            let bestYear = { year: '-', return: 0 };
            let worstYear = { year: '-', return: 0 };

            if (annualReturns.length > 0) {
                bestYear = annualReturns.reduce((max, curr) => curr.return > max.return ? curr : max);
                worstYear = annualReturns.reduce((min, curr) => curr.return < min.return ? curr : min);
            }

            //===== MAX DRAWDOWN (High-Water Mark method on MONTHLY prices) =====
            let maxDrawdown = 0;
            let peak = assetPrices[0]?.price || 0;
            let drawdownDate = '';

            assetPrices.forEach(point => {
                // Update peak (High-Water Mark)
                if (point.price > peak) {
                    peak = point.price;
                }

                // Calculate current drawdown from peak
                const drawdown = ((point.price - peak) / peak) * 100;

                if (drawdown < maxDrawdown) {
                    maxDrawdown = drawdown;
                    drawdownDate = point.date;
                }
            });

            //===== VOLATILITY (Annualized from monthly returns) =====
            let volatility = 0;
            if (monthlyReturns.length > 1) {
                const avgReturn = monthlyReturns.reduce((sum, r) => sum + r, 0) /
                    monthlyReturns.length;
                const variance = monthlyReturns.reduce((sum, r) => sum + Math.pow(r -
                    avgReturn, 2), 0) / monthlyReturns.length;
                const monthlyVol = Math.sqrt(variance);
                // Annualize: monthly * sqrt(12)
                volatility = monthlyVol * Math.sqrt(12);
            }

            // Use real CAGR if available, otherwise nominal
            const displayCAGR = realCAGR !== null ?
                realCAGR : nominalCAGR;

            // ===== UPDATE UI =====
            document.getElementById('bt-kpi-cagr').textContent
                = (displayCAGR >= 0 ? '+' : '') +
                displayCAGR.toFixed(1) + '%';
            document.getElementById('bt-kpi-cagr').className
                = 'text-2xl font-bold ' + (displayCAGR >= 0
                    ? 'text-purple-600' : 'text-red-600');

            document.getElementById('bt-kpi-best').textContent
                = '+' + bestYear.return.toFixed(1) + '%';
            document.getElementById('bt-kpi-best-year').textContent
                = bestYear.year;

            document.getElementById('bt-kpi-worst').textContent
                = worstYear.return.toFixed(1) + '%';
            document.getElementById('bt-kpi-worst-year').textContent
                = worstYear.year;

            // Max Drawdown - red if > 20%
            const drawdownEl = document.getElementById('bt-kpi-drawdown');
            drawdownEl.textContent = maxDrawdown.toFixed(1) + '%';
            drawdownEl.className = 'text-2xl font-bold ' + (maxDrawdown < -20 ? 'text-red-600' : 'text-amber-600');
            document.getElementById('bt-kpi-volatility').textContent = volatility.toFixed(1) + '%';
        }

        //===== PORTFOLIO BACKTESTING =====
        function runPortfolioBacktest() {
            const initialAmount = parseFloat(document.getElementById('bt-amount').value) || 0;
            const monthlyContribution = parseFloat(document.getElementById('bt-monthly').value) || 0;
            const yearsBack = parseInt(document.getElementById('bt-years-slider').value) || 5;
            const showRealReturn = document.getElementById('bt-real-return-toggle')?.checked ?? true;
            const currencyPerspective = document.getElementById('bt-currency-perspective')?.value || 'local';
            const doRebalance = document.getElementById('bt-rebalance')?.checked ?? true;
            const showGhostLine = document.getElementById('bt-show-ghost')?.checked ?? false;
            const showInflation = document.getElementById('bt-show-inflation')?.checked ?? true;

            if (initialAmount <= 0 && monthlyContribution <= 0) {
                showNotification('Ingresa al menos una inversi칩n inicial o aporte mensual', 'Error', 'error');
                return;
            }

            // Get strategy assets
            const strategyId = document.getElementById('bt-strategy').value;
            let strategyAssets = [];
            let strategyName = '';

            if (strategyId === 'current') {
                strategyAssets = getCurrentStrategyAssets();
                strategyName = currentMode === 'custom' ? 'Custom' : (currentMode === 'normal' ? 'Normie' : 'Soberano');
            } else if (strategyId === 'normal') {
                strategyAssets = config.normal.assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    key: assetNameToKey[a.name]
                }));
                strategyName = 'Normie';
            } else if (strategyId === 'sovereign') {
                strategyAssets = config.sovereign.assets.map(a => ({
                    name: a.name,
                    ratio: a.ratio,
                    key: assetNameToKey[a.name]
                }));
                strategyName = 'Soberano';
            }

            // Filter valid assets (with historical data)
            const validAssets = strategyAssets.filter(a => a.key && historicalData[a.key]);

            if (validAssets.length === 0) {
                showNotification('No hay datos hist칩ricos para los activos de esta estrategia', 'Error', 'error');
                return;
            }

            // Normalize weights if some assets were excluded
            const totalWeight = validAssets.reduce((sum, a) => sum + a.ratio,
                0);
            const normalizedAssets = validAssets.map(a => ({
                ...a,
                ratio: a.ratio / totalWeight
            }));

            // Calculate date range
            const now = new Date();
            const startYear = now.getFullYear() -
                yearsBack;
            const startMonth = String(now.getMonth()
                + 1).padStart(2, '0');
            const startDate =
                `${startYear}-${startMonth}`;
            const endDate =
                now.toISOString().slice(0, 7);

            // Find common date range across all assets
            let commonDates = null;
            for (const asset of normalizedAssets) {
                const data = historicalData[asset.key];
                const dates = new Set(data.filter(d =>
                    d.date >= startDate).map(d => d.date));
                if (!commonDates) {
                    commonDates = dates;
                } else {
                    commonDates = new
                        Set([...commonDates].filter(d =>
                            dates.has(d)));
                }
            }

            const sortedDates = [...commonDates].sort();
            if (sortedDates.length < 2) {
                showNotification('No hay suficientes datos comunes en el rango de fechas', 'Error', 'error');
                return;
            }

            //===== SIMULATE PORTFOLIO WITH REBALANCING =====
            function simulatePortfolioInternal(assets, dates, rebalance) {
                let holdings = {};
                let totalInvested = initialAmount;
                const history = [];

                // Initial purchase
                const firstDate = dates[0];
                for (const asset of assets) {
                    const priceData = historicalData[asset.key].find(d => d.date === firstDate);
                    if (!priceData) continue;
                    const investAmount = initialAmount * asset.ratio;
                    holdings[asset.key] = {
                        units: investAmount / priceData.price,
                        weight: asset.ratio
                    };
                }

                let monthsSinceRebalance = 0;

                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    let totalValue = 0;

                    // Calculate current value
                    for (const asset of assets) {
                        const holding = holdings[asset.key];
                        if (!holding) continue;
                        const priceData = historicalData[asset.key].find(d => d.date === date);
                        if (!priceData) continue;

                        // Add dividends
                        const divYield = assetConfig?.dividendYields?.[asset.key] || 0;
                        if (divYield > 0 && i > 0) {
                            holding.units *= (1 + divYield / 12 / 100);
                        }

                        totalValue += holding.units * priceData.price;
                    }

                    // Add monthly contribution
                    if (monthlyContribution > 0 && i > 0) {
                        for (const asset of assets) {
                            const priceData = historicalData[asset.key].find(d => d.date
                                === date);
                            if (!priceData) continue;
                            const investAmount =
                                monthlyContribution *
                                asset.ratio;
                            holdings[asset.key].units +=
                                investAmount / priceData.price;
                        }
                        totalInvested +=
                            monthlyContribution;
                        totalValue +=
                            monthlyContribution;
                    }

                    // Rebalance annually if enabled
                    monthsSinceRebalance++;
                    if (rebalance && monthsSinceRebalance >= 12 && i <
                        dates.length - 1) {
                        for (const asset of assets) {
                            const
                                targetValue = totalValue * asset.ratio; const
                                    priceData = historicalData[asset.key].find(d => d.date ===
                                        date);
                            if (priceData) {
                                holdings[asset.key].units =
                                    targetValue /
                                    priceData.price;
                            }
                        }
                        monthsSinceRebalance = 0;
                    }

                    history.push({
                        date: date,
                        value: totalValue,
                        invested: totalInvested
                    });
                }

                return {
                    history,
                    totalInvested
                };
            }

            // Run simulation with rebalancing (main result)
            const mainResult =
                simulatePortfolioInternal(normalizedAssets, sortedDates,
                    doRebalance);

            // Run without rebalancing for ghost line
            let ghostResult = null;
            if (showGhostLine) {
                ghostResult =
                    simulatePortfolioInternal(normalizedAssets,
                        sortedDates, false);
            }

            // Calculate inflation line
            let inflationLine = null;
            if (showInflation) {
                const startIPC =
                    FinancialUtils._findClosestIPC(inflacionUruguay,
                        sortedDates[0]);
                inflationLine = sortedDates.map(date => {
                    const currentIPC =
                        FinancialUtils._findClosestIPC(inflacionUruguay, date);
                    const inflationFactor = startIPC ? (currentIPC?.index ||
                        startIPC.index) / startIPC.index : 1;
                    return {
                        date: date,
                        value: initialAmount *
                            inflationFactor
                    };
                });
            }

            // Calculate final metrics
            const portfolioHistory =
                mainResult.history;
            const totalInvested =
                mainResult.totalInvested;
            const finalValue =
                portfolioHistory[portfolioHistory.length
                    - 1].value;
            const totalReturn =
                ((finalValue -
                    totalInvested) /
                    totalInvested) * 100;
            const netGain = finalValue -
                totalInvested;

            const startDateActual =
                sortedDates[0];
            const endDateActual = sortedDates[sortedDates.length - 1];
            const yearsDiff = sortedDates.length / 12;
            const cagr = (Math.pow(finalValue / totalInvested, 1 / yearsDiff) - 1) * 100;

            // Calculate real return (same logic as individual assets)
            let realReturn = null;
            let inflationRate = null;
            let realGain = null;
            let realExplanation = '';

            if (showRealReturn) {
                // For portfolios, we use UYU perspective primarily
                if (currencyPerspective === 'local') {
                    // Convert entire portfolio to UYU perspective
                    const startExchangeRate = FinancialUtils._findClosestPrice(historicalData.dolarUruguay, startDateActual) || 1;
                    const endExchangeRate = FinancialUtils._findClosestPrice(historicalData.dolarUruguay, endDateActual) || 1;

                    // Most portfolio assets are USD-denominated
                    const investedUYU = totalInvested * startExchangeRate;
                    const finalValueUYU = finalValue * endExchangeRate;
                    const nominalReturnUYU = ((finalValueUYU - investedUYU) / investedUYU) * 100;

                    inflationRate = FinancialUtils.getInflationRateUY(startDateActual, endDateActual);

                    if (inflationRate !== null) {
                        realReturn = FinancialUtils.getRealReturn(nominalReturnUYU, inflationRate);
                        realGain = (investedUYU * (1 + realReturn / 100)) - investedUYU;
                    }

                    realExplanation = `Portfolio ${strategyName} en UYU, menos ${inflationRate?.toFixed(1) || '?'}% inflaci칩n`;
                } else {
                    inflationRate = FinancialUtils.getInflationRateUS(startDateActual, endDateActual);

                    if (inflationRate !== null) {
                        realReturn = FinancialUtils.getRealReturn(totalReturn, inflationRate);
                        realGain = (totalInvested * (1 + realReturn / 100)) - totalInvested;
                    }

                    realExplanation = `Portfolio ${strategyName} en USD, menos ${inflationRate?.toFixed(1) || '?'}% inflaci칩n USA`;
                }
            }

            // ===== UPDATE UI =====
            const displayCurrency = currencyPerspective === 'local' ? 'UYU' : 'USD';
            const currencySymbol =
                displayCurrency === 'UYU' ?
                    '$U ' : 'US$ ';
            const currencyFlag =
                displayCurrency === 'UYU' ?
                    '游쥟릖' : '游쥟릖';
            const inflationCountry =
                currencyPerspective ===
                    'local' ? 'UY' : 'USA';

            const formatWithCurrency =
                (amount) => {
                    return
                    Math.abs(amount).toLocaleString('es-UY',
                        {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                };

            document.getElementById('bt-currency-symbol').textContent = currencySymbol;
            document.getElementById('bt-currency-flag').textContent = currencyFlag;
            document.getElementById('bt-currency-code').textContent = displayCurrency;

            document.querySelectorAll('.bt-currency-prefix').forEach(el => {
                el.textContent = currencySymbol;
            });

            document.getElementById('bt-total-invested').textContent = formatWithCurrency(totalInvested);
            document.getElementById('bt-final-value').textContent = formatWithCurrency(finalValue);
            document.getElementById('bt-total-return').textContent = (totalReturn >= 0 ? '+' : '') + totalReturn.toFixed(1) + '%';
            document.getElementById('bt-total-return').className = 'font-bold ' + (totalReturn >= 0 ? 'text-green-400' :
                'text-red-400');
            document.getElementById('bt-net-gain').textContent =
                (netGain >= 0 ? '+' : '-') +
                formatWithCurrency(netGain);
            document.getElementById('bt-cagr').textContent =
                cagr.toFixed(1) + '%';
            document.getElementById('bt-return-label').textContent =
                showRealReturn ? 'Retorno Nominal' : 'Retorno Total';

            // Update Real Return section
            const realReturnSection =
                document.getElementById('bt-real-return-section');
            if (showRealReturn && realReturn !== null) {
                realReturnSection.classList.remove('hidden');

                document.getElementById('bt-inflation').textContent
                    = '+' +
                    (inflationRate?.toFixed(1)
                        || '?') + '%';
                document.getElementById('bt-inflation-country').textContent
                    = `(${inflationCountry})`;

                const realReturnEl =
                    document.getElementById('bt-real-return');
                realReturnEl.textContent =
                    (realReturn >= 0 ? '+' : '')
                    + realReturn.toFixed(1) +
                    '%';
                realReturnEl.className =
                    'font-bold ' + (realReturn
                        >= 0 ? 'text-green-400' :
                        'text-red-400');

                const realGainFormatted =
                    realGain !== null ?
                        (currencySymbol + (realGain
                            >= 0 ? '+' : '-') +
                            formatWithCurrency(Math.abs(realGain)))
                        : '$?';
                document.getElementById('bt-real-gain').textContent
                    = realGainFormatted;
                document.getElementById('bt-real-gain').className
                    = 'font-bold text-xl ' +
                    (realGain >= 0 ?
                        'text-green-400' :
                        'text-red-400');

                document.getElementById('bt-real-explanation').textContent
                    = realExplanation;
            } else {
                realReturnSection.classList.add('hidden');
            }

            document.getElementById('bt-result-card').classList.remove('hidden');

            // Calculate and display KPI metrics (for portfolio, use portfolio values as base)
            const kpiStartDate = portfolioHistory[0]?.date || '';
            const kpiEndDate = portfolioHistory[portfolioHistory.length - 1]?.date || '';
            calculateKPIMetrics(portfolioHistory, showRealReturn ? realReturn : null, cagr, null, kpiStartDate, kpiEndDate);

            // Render chart with multiple lines
            renderPortfolioBacktestChart(portfolioHistory, ghostResult?.history, inflationLine, strategyName, doRebalance);
        }

        // ===== RENDER PORTFOLIO CHART WITH MULTIPLE LINES =====
        function renderPortfolioBacktestChart(mainHistory, ghostHistory, inflationLine, strategyName, withRebalance) {
            const ctx = document.getElementById('backtestChart');
            if (!ctx) return;

            if (backtestChartInstance) {
                backtestChartInstance.destroy();
            }

            const labels = mainHistory.map(d => d.date);

            const datasets = [
                // Main portfolio line
                {
                    label: `游늵 ${strategyName} ${withRebalance ? '(con Gesti칩n Activa)' : '(Buy & Hold)'}`,
                    data: mainHistory.map(d => d.value),
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0
                },
                // Total invested line
                {
                    label: '游눳 Total Invertido',
                    data: mainHistory.map(d => d.invested),
                    borderColor: '#64748B',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0,
                    pointRadius: 0
                }
            ];

            // Ghost line (without rebalancing)
            if (ghostHistory) {
                datasets.push({
                    label: '游놑 Buy & Hold (sin gesti칩n)',
                    data: ghostHistory.map(d => d.value),
                    borderColor: '#F59E0B',
                    backgroundColor:
                        'transparent',
                    borderWidth: 2,
                    borderDash: [3, 3],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                });
            }

            // Inflation benchmark line
            if (inflationLine) {
                datasets.push({
                    label: '游댮 Inflaci칩n Acumulada (UY)',
                    data: inflationLine.map(d => d.value),
                    borderColor: '#EF4444',
                    backgroundColor:
                        'transparent',
                    borderWidth: 2,
                    borderDash: [8, 4],
                    fill: false,
                    tension: 0,
                    pointRadius: 0
                });
            }

            backtestChartInstance = new
                Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: ctx => {
                                        const val = ctx.parsed.y;
                                        if (val >= 1000000) {
                                            return
                                            `${ctx.dataset.label}:
                                                                $${(val /
                                                    1000000).toFixed(2)}M`;
                                        } else if (val >= 1000) {
                                            return
                                            `${ctx.dataset.label}:
                                                                $${(val /
                                                    1000).toFixed(1)}K`;
                                        }
                                        return
                                        `${ctx.dataset.label}:
                                                                $${val.toFixed(0)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: val => {
                                        if (val >= 1000000) return
                                        '$' + (val /
                                            1000000).toFixed(1) + 'M';
                                        if (val >= 1000) return '$'
                                            + (val / 1000).toFixed(0) +
                                            'K';
                                        return '$' + val;
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }
                        }
                    }
                });
        }

        function
            renderBacktestChart(portfolioHistory,
                assetKey) {
            const ctx =
                document.getElementById('backtestChart');
            if (!ctx) return;

            if (backtestChartInstance) {
                backtestChartInstance.destroy();
            }

            const labels =
                portfolioHistory.map(d =>
                    d.date);
            const values =
                portfolioHistory.map(d =>
                    d.value);
            const invested =
                portfolioHistory.map(d =>
                    d.invested);

            // Get color from
            historicalAssetMeta
            const color =
                historicalAssetMeta[assetKey]?.color
                || '#8B5CF6';
            const assetName =
                historicalAssetMeta[assetKey]?.name
                || assetKey;

            backtestChartInstance = new
                Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Valor del Portfolio',
                                data: values,
                                borderColor: color,
                                backgroundColor: color +
                                    '30',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 2,
                                pointHoverRadius: 6,
                                borderWidth: 3
                            },
                            {
                                label: 'Total Invertido',
                                data: invested,
                                borderColor: '#64748B',
                                backgroundColor:
                                    'transparent',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0,
                                pointRadius: 0,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 8
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label
                                            + ': ' +
                                            formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        if (value >= 1000000) {
                                            return '$' + (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return '$' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 12,
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
        }

        window.addEventListener('load', async () => {
            // Set default date for transaction form
            document.getElementById('txn-date').value = new
                Date().toISOString().split('T')[0];

            // Load saved state
            const loaded = loadState();
            loadChatHistory();
            if (!loaded) {
                setMode('normal');
            }

            // Check backend connection
            await checkBackendConnection();

            // Fetch live prices
            fetchAllPrices();

            // Initialize compound interest simulator
            // Initialize compound interest simulator
            // Initialize compound interest simulator
            initSimulator();

            // Initialize Dynamic UI (Assets, Scenarios)
            initDynamicUI();
        });

        // Helper function to generate grouped asset options HTML
        function getGroupedAssetOptionsHtml(selectedValue = '', valueIsName = false) {
            let html = '';
            if (typeof rebalanceAssets === 'undefined') {
                return html;
            }

            // Group by type (heuristic)
            const groups = {
                'Acciones': [],
                'Crypto': [],
                'Renta Fija': [],
                'Otros': []
            };

            rebalanceAssets.forEach(asset => {
                const data = simAssetData[asset.key];
                if (!data) return;

                if (['sp500', 'nasdaq', 'vt', 'smh', 'schd', 'vnq', 'vwo'].includes(asset.key)) groups['Acciones'].push(asset);
                else if (['bitcoin', 'ethereum', 'solana'].includes(asset.key)) groups['Crypto'].push(asset);
                else if (['fondoLiquidez', 'bonosUI', 'bonosTesoro'].includes(asset.key)) groups['Renta Fija'].push(asset);
                else groups['Otros'].push(asset);
            });

            for (const [label, assets] of Object.entries(groups)) {
                if (assets.length > 0) {
                    html += `<optgroup label="${label}">`;
                    assets.forEach(asset => {
                        const value = valueIsName ? asset.name : asset.key;
                        const selectedAttr = (value === selectedValue) ? 'selected' : '';
                        html += `<option value="${value}" ${selectedAttr}>${simAssetData[asset.key].emoji} ${asset.name}</option>`;
                    });
                    html += `</optgroup>`;
                }
            }
            return html;
        }

        // --- INIT DYNAMIC UI ---
        function initDynamicUI() {
            console.log("Initializing Dynamic UI...");

            // 1. Populate Custom Strategy Asset Dropdown (Grouped)
            const customSelect = document.getElementById('customAssetSelect');
            if (customSelect) {
                // Use helper with valueIsName = true
                customSelect.innerHTML = getGroupedAssetOptionsHtml('', true);
            }

            // 2. Populate Time Machine Asset Dropdown (Grouped)
            const btSelect = document.getElementById('bt-asset');
            if (btSelect) {
                // Use helper with valueIsName = false (default)
                btSelect.innerHTML = getGroupedAssetOptionsHtml('', false);
            }
            // 3. Render Initial Scenarios
            // Delegate to renderScenarios() which now handles full rendering
            if (typeof renderScenarios === 'function') {
                renderScenarios();
            } else {
                console.error("renderScenarios function not found");
            }
        }

    </script>
    <!-- Market Clock Widget Logic -->
    <script src="market_clock.js?v=clockFixed"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('九 SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('仇 SW registration failed:', error);
                    });
            });
        }
    </script>
</body>

</html>